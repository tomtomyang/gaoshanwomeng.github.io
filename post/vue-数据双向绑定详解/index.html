<!DOCTYPE html>
<html lang="zh-cn" data-theme="light"><head>
    <meta name="google-site-verification" content="kw1N-Xm6qEr1c9PGuRd0U_T6DXkw_EHsLyz5LpuDDv8" />
    <meta name="msvalidate.01" content="EE98205D30806C22C519683EFC53E9BA" />
    <meta name="baidu-site-verification" content="iPC3wUcQLL" />
    <title>  vue æ•°æ®åŒå‘ç»‘å®šè¯¦è§£ </title>
    <meta charset="utf-8" /><meta name="generator" content="Hugo 0.74.3" /><meta name="viewport" content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1" />
    <meta name="description" itemprop="description"
        content=" vue æ•°æ®åŒå‘ç»‘å®šè¯¦è§£ " />
    <meta name="keywords" itemprop="keywords"
        content=" [vue æ•°æ®åŒå‘ç»‘å®š] " />
    <base href="https://tomtomyoung.top/">
    <link rel="shortcut icon" href="https://tomtomyoung.top/favicons//favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="https://tomtomyoung.top/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://tomtomyoung.top/favicons/favicon-16x16.png">
    <link rel="canonical" href="https://tomtomyoung.top/post/vue-%E6%95%B0%E6%8D%AE%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A%E8%AF%A6%E8%A7%A3/">
    <link rel="stylesheet" type="text/css" href="https://at.alicdn.com/t/font_2450869_iypnqhtzjei.css">
    
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="https://tomtomyoung.top/css/style.min.d3105484ab1af6af37b65225e214199cc648cfba5e7e2808585a08a35f422e28.css" integrity="" type="text/css">
    
    
    <script type="text/javascript" src="https://tomtomyoung.top/js/docsearch.min.69f8ad33daa0ba1950834aaf16111d935f6a7e2b03db2cc2ae537724142b2719782bcea9aba5996af27f6f94a8365b6575ce2eff90506c2bba9aa0411587116c.js" integrity=""></script>
</head><body class="animated fadeInDown">
<div class="main"><div class="percentage_container">
    <div class="percentage" id="percentage"></div>
</div><div class="toc sub-container">
    <div class="toc-header">
        <span>ç›®å½•</span>
    </div><ul class="toc-h2"><li>
                <span class="toc-link">1. åŒå‘ç»‘å®šåŸç†</span>
            </li>
            <li>
                <span class="toc-link">2. Observer</span>
            </li>
            
                    <ul class="toc-h3"><li>
                <span class="toc-link">1. observe()</span>
            </li>
            <li>
                <span class="toc-link">2. Observer()</span>
            </li>
            <li>
                <span class="toc-link">3. defineReactive()</span>
            </li>
            
                    </ul><li>
                <span class="toc-link">3. Dep</span>
            </li>
            <li>
                <span class="toc-link">4. Watcher</span>
            </li>
            </div><div class="single-post container">
    <div class="post">
      <div class="header">
        <span class="title">vue æ•°æ®åŒå‘ç»‘å®šè¯¦è§£</span>
        
        <div class="info">
          <span>ğŸ“… 2021-09-03</span>
          <span>ğŸ‘¦ Tomtom Young</span>
          <span>ğŸ“– 5768å­—</span>
          <span>â± 12åˆ†é’Ÿ</span>
        </div>
        
      </div>
      <div class="content markdown-body">
        <blockquote>
<p>å‚è€ƒï¼š</p>
<p><a href="https://cn.vuejs.org/v2/guide/reactivity.html#%E5%A6%82%E4%BD%95%E8%BF%BD%E8%B8%AA%E5%8F%98%E5%8C%96">Vue.js_æ·±å…¥å“åº”å¼åŸç†</a></p>
<p><a href="https://www.cnblogs.com/demonxian3/p/13546525.html">Vueæºç åˆ†æä¹‹å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆçš„Vue</a></p>
<p><a href="https://github.com/DMQ/mvvm">DMQ/mvvm</a></p>
<p><a href="https://www.cnblogs.com/moon3/p/12200807.html">vueæºç è§£è¯»ï¼ˆä¸€ï¼‰Observer/Dep/Watcheræ˜¯å¦‚ä½•å®ç°æ•°æ®ç»‘å®šçš„</a></p>
</blockquote>
<h2 id="1-åŒå‘ç»‘å®šåŸç†">1. åŒå‘ç»‘å®šåŸç†</h2>
<p>vue.js æ˜¯é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆå‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼çš„æ–¹å¼ï¼Œé€šè¿‡<code>Object.defineProperty()</code>æ¥åŠ«æŒå„ä¸ªå±æ€§çš„<code>setter</code>ï¼Œ<code>getter</code>ï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒï¼Œä¸‹é¢æ˜¯å‡ ä¸ªè‡³å…³é‡è¦çš„è§’è‰²ï¼š</p>
<ol>
<li>Observeræ•°æ®ç›‘å¬å™¨ï¼Œå¯¹dataæ•°æ®è¿›è¡Œé€’å½’éå†ï¼Œéƒ½åŠ ä¸Š setterå’Œgetterã€‚è¿™æ ·çš„è¯ï¼Œç»™è¿™ä¸ªå¯¹è±¡çš„æŸä¸ªå€¼èµ‹å€¼ï¼Œå°±ä¼šè§¦å‘setterï¼Œé‚£ä¹ˆå°±èƒ½ç›‘å¬åˆ°äº†æ•°æ®å˜åŒ–ï¼Œå¯ä»¥æ‹¿åˆ°æœ€æ–°å€¼ï¼Œæ·»åŠ åˆ°å‘å¸ƒè€…ï¼Œè¿›è€Œé€šçŸ¥è®¢é˜…è€…ï¼›</li>
<li>Depè®¢é˜…å™¨ï¼Œèº«ä»½æ˜¯å‘å¸ƒè€…ï¼Œç»´æŠ¤ä¸€ä¸ªæ•°ç»„ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘</li>
<li>Compilerè§£æå™¨ï¼Œæ ¹æ®æŒ‡ä»¤ï¼Œå°†æ¨¡æ¿ä¸­çš„å˜é‡æ›¿æ¢æˆæ•°æ®ï¼ŒåŒæ—¶ç»‘å®šæ›´æ–°è¿™ä¸ªæ•°æ®çš„æ›´æ–°å‡½æ•°ï¼›</li>
<li>Watcherå˜åŒ–è§‚å¯Ÿå™¨ï¼Œèº«ä»½æ—¶è®¢é˜…è€…ï¼Œè¿æ¥Observerå’ŒCompilerçš„æ¡¥æ¢ï¼Œèƒ½å¤Ÿé€šè¿‡Depæ”¶åˆ°æ¯ä¸ªå±æ€§çš„å˜åŒ–é€šçŸ¥ï¼Œæ‰§è¡ŒCompileræ·»åŠ çš„æ›´æ–°å‡½æ•°ï¼Œä»è€Œæ›´æ–°è§†å›¾ï¼›</li>
<li>MVVMå¯¹è±¡ï¼Œä½œä¸ºæ•°æ®ç»‘å®šçš„å…¥å£ï¼Œæ•´åˆObserverã€Compilerå’ŒWatcherä¸‰è€…ï¼Œé€šè¿‡Observeræ¥ç›‘å¬è‡ªå·±çš„dataæ•°æ®å˜åŒ–ï¼Œé€šè¿‡Compileræ¥è§£æç¼–è¯‘æ¨¡æ¿æŒ‡ä»¤ï¼Œæœ€ç»ˆåˆ©ç”¨Watcheræ­èµ·Observerå’ŒCompileä¹‹é—´çš„é€šä¿¡æ¡¥æ¢ï¼Œè¾¾åˆ°æ•°æ®å˜åŒ– -&gt; è§†å›¾æ›´æ–°ï¼›è§†å›¾å˜åŒ–-&gt; æ•°æ®æ›´æ–°çš„åŒå‘ç»‘å®šæ•ˆæœã€‚</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/20190528174339999.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FsaXVqaXVqaWFuZw==,size_16,color_FFFFFF,t_70" alt="img"></p>
<h2 id="2-observer">2. Observer</h2>
<p>Observerçš„ä½œç”¨æ˜¯å¯¹æ•´ä¸ªDataè¿›è¡Œç›‘å¬ï¼Œåœ¨initDataè¿™ä¸ªåˆå§‹æ–¹æ³•é‡Œä½¿ç”¨<code>observe(data)</code>ï¼ŒObserverç±»å†…éƒ¨é€šè¿‡defineReactiveæ–¹æ³•åŠ«æŒdataçš„æ¯ä¸€ä¸ªå±æ€§çš„getterå’Œsetterã€‚</p>
<h3 id="1-observe">1. observe()</h3>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹<code>observe</code>å‡½æ•°çš„æºç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">export</span> <span style="color:#8be9fd;font-style:italic">function</span> observe (value: <span style="color:#8be9fd">any</span>, asRootData: <span style="color:#8be9fd">?boolean</span>)<span style="color:#ff79c6">:</span> Observer <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">void</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  <span style="color:#6272a4">/*åˆ¤æ–­Dataæ˜¯å¦æ˜¯ä¸€ä¸ªå¯¹è±¡*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>isObject(value)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#6272a4">// å­˜å‚¨Observer
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd;font-style:italic">let</span> ob: <span style="color:#8be9fd">Observer</span> <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">void</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#6272a4">/*è¿™é‡Œç”¨__ob__è¿™ä¸ªå±æ€§æ¥åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰Observerå®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰Observerå®ä¾‹åˆ™ä¼šæ–°å»ºä¸€ä¸ªObserverå®ä¾‹å¹¶èµ‹å€¼ç»™__ob__è¿™ä¸ªå±æ€§ï¼Œå¦‚æœå·²æœ‰Observerå®ä¾‹åˆ™ç›´æ¥è¿”å›è¯¥Observerå®ä¾‹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">if</span> (hasOwn(value, <span style="color:#f1fa8c">&#39;__ob__&#39;</span>) <span style="color:#ff79c6">&amp;&amp;</span> value.__ob__ <span style="color:#ff79c6">instanceof</span> Observer) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    ob <span style="color:#ff79c6">=</span> value.__ob__
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#6272a4">/*è¿™é‡Œçš„åˆ¤æ–­æ˜¯ä¸ºäº†ç¡®ä¿valueæ˜¯å•çº¯çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯å‡½æ•°æˆ–è€…æ˜¯Regexpç­‰æƒ…å†µã€‚*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    observerState.shouldConvert <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#ff79c6">!</span>isServerRendering() <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(value) <span style="color:#ff79c6">||</span> isPlainObject(value)) <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#8be9fd;font-style:italic">Object</span>.isExtensible(value) <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#ff79c6">!</span>value._isVue
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>  ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#6272a4">// åˆ›å»ºä¸€ä¸ªObserverå®ä¾‹ï¼Œç»‘å®šdataè¿›è¡Œç›‘å¬
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#6272a4"></span>    ob <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Observer(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  <span style="color:#ff79c6">if</span> (asRootData <span style="color:#ff79c6">&amp;&amp;</span> ob) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#6272a4">/*å¦‚æœæ˜¯æ ¹æ•°æ®åˆ™è®¡æ•°ï¼Œåé¢Observerä¸­çš„observeçš„asRootDataétrue*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    ob.vmCount<span style="color:#ff79c6">++</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  <span style="color:#ff79c6">return</span> ob
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>}
</code></pre></div><p>ç»™dataç»‘å®šä¸€ä¸ª<code>__ob__</code>å±æ€§ï¼Œç”¨æ¥å­˜æ”¾<code>Observer</code>å®ä¾‹ï¼Œé¿å…é‡å¤ç»‘å®šï¼›</p>
<h3 id="2-observer-1">2. Observer()</h3>
<p>å†çœ‹ä¸€ä¸‹<code>Observer</code>ç±»çš„æºç :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"> * Observer class that are attached to each observed
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"> * object. Once attached, the observer converts target
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"> * object&#39;s property keys into getter/setters that
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"> * collect dependencies and dispatches updates.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"> */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  value: <span style="color:#8be9fd">any</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  dep: <span style="color:#8be9fd">Dep</span>; <span style="color:#6272a4">// æ¯ä¸€ä¸ªDataçš„å±æ€§éƒ½ä¼šç»‘å®šä¸€ä¸ªdepï¼Œç”¨äºå­˜æ”¾watcher arr
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>  vmCount: <span style="color:#8be9fd">number</span>; <span style="color:#6272a4">// number of vms that has this object as root $data
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#ff79c6">constructor</span> (value: <span style="color:#8be9fd">any</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#ff79c6">this</span>.dep <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Dep()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#ff79c6">this</span>.vmCount <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#6272a4">// è¿™ä¸ªdefçš„æ„æ€å°±æ˜¯æŠŠObserverå®ä¾‹ç»‘å®šåˆ°Dataçš„__ob__å±æ€§ä¸Šå»
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>    def(value, <span style="color:#f1fa8c">&#39;__ob__&#39;</span>, <span style="color:#ff79c6">this</span>) 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(value)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>      <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4">          å¦‚æœæ˜¯æ•°ç»„ï¼Œå°†ä¿®æ”¹åå¯ä»¥æˆªè·å“åº”çš„æ•°ç»„æ–¹æ³•æ›¿æ¢æ‰è¯¥æ•°ç»„çš„åŸå‹ä¸­çš„åŸç”Ÿæ–¹æ³•ï¼Œè¾¾åˆ°ç›‘å¬æ•°ç»„æ•°æ®å˜åŒ–å“åº”çš„æ•ˆæœã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#6272a4">      */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>      <span style="color:#ff79c6">const</span> augment <span style="color:#ff79c6">=</span> hasProto <span style="color:#ff79c6">?</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        protoAugment  <span style="color:#6272a4">/*ç›´æ¥è¦†ç›–åŸå‹çš„æ–¹æ³•æ¥ä¿®æ”¹ç›®æ ‡å¯¹è±¡*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        <span style="color:#ff79c6">:</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>        copyAugment   <span style="color:#6272a4">/*å®šä¹‰ï¼ˆè¦†ç›–ï¼‰ç›®æ ‡å¯¹è±¡æˆ–æ•°ç»„çš„æŸä¸€ä¸ªæ–¹æ³•*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>      augment(value, arrayMethods, arrayKeys)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>      <span style="color:#6272a4">/*å¦‚æœæ˜¯æ•°ç»„åˆ™éœ€è¦éå†æ•°ç»„çš„æ¯ä¸€ä¸ªæˆå‘˜è¿›è¡Œobserve*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>      <span style="color:#ff79c6">this</span>.observeArray(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>      <span style="color:#6272a4">/*å¦‚æœæ˜¯å¯¹è±¡åˆ™ç›´æ¥walkè¿›è¡Œç»‘å®š*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>      <span style="color:#ff79c6">this</span>.walk(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  walk (obj: <span style="color:#8be9fd">Object</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    <span style="color:#ff79c6">const</span> keys <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">Object</span>.keys(obj)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>    <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span style="color:#6272a4">    walkæ–¹æ³•ä¼šéå†å¯¹è±¡çš„æ¯ä¸€ä¸ªå±æ€§è¿›è¡ŒdefineReactiveç»‘å®š
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#6272a4">    defineReactive: åŠ«æŒdataçš„getterå’Œsetter
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#6272a4">    */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> keys.length; i<span style="color:#ff79c6">++</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>      defineReactive(obj, keys[i], obj[keys[i]])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>  observeArray (items: <span style="color:#8be9fd">Array</span>&lt;<span style="color:#ff79c6">any</span>&gt;) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>    <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span style="color:#6272a4">    æ•°ç»„éœ€è¦éå†æ¯ä¸€ä¸ªæˆå‘˜è¿›è¡Œobserve
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span style="color:#6272a4">    */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>, l <span style="color:#ff79c6">=</span> items.length; i <span style="color:#ff79c6">&lt;</span> l; i<span style="color:#ff79c6">++</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>      observe(items[i])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>}
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>Observer</code>ç±»ä¸»è¦å¹²äº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>å¦‚æœdataæ˜¯Objectï¼Œéå†å¯¹è±¡çš„æ¯ä¸€ä¸ªå±æ€§è¿›è¡Œ<code>defineReactive</code>ç›‘å¬ï¼›</li>
<li>å¦‚æœdataæ˜¯Arrayï¼Œåˆ™éœ€è¦å¯¹æ¯ä¸€ä¸ªæˆå‘˜è¿›è¡Œ<code>observe</code>ã€‚Vueä¼šé‡å†™Arrayçš„pushã€popã€shiftã€unshiftã€spliceã€sortã€reverseè¿™7ä¸ªæ–¹æ³•ï¼Œä¿è¯ä¹‹åpop/pushç­‰æ“ä½œè¿›å»çš„å¯¹è±¡ä¹Ÿæœ‰è¿›è¡ŒåŒå‘ç»‘å®šï¼›</li>
</ul>
<h3 id="3-definereactive">3. defineReactive()</h3>
<p>å¦‚ä¸Šè¿°æºç æ‰€ç¤ºï¼Œ<code>Observer</code>ç±»ä¸»è¦æ˜¯é éå†dataçš„æ¯ä¸€ä¸ªå±æ€§ï¼Œä½¿ç”¨<code>defineReactive()</code>æ–¹æ³•åŠ«æŒ<code>getter</code>å’Œ<code>setter</code>æ–¹æ³•, ä¸‹é¢æ¥å…·ä½“çœ‹ä¸€ä¸‹<code>defineReactive</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">export</span> <span style="color:#8be9fd;font-style:italic">function</span> defineReactive (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  obj: <span style="color:#8be9fd">Object</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  key: <span style="color:#8be9fd">string</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  val: <span style="color:#8be9fd">any</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  customSetter?: <span style="color:#8be9fd">Function</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  <span style="color:#6272a4">/*åœ¨é—­åŒ…ä¸­å®šä¹‰ä¸€ä¸ªdepå¯¹è±¡*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#ff79c6">const</span> dep <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Dep()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">const</span> property <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">Object</span>.getOwnPropertyDescriptor(obj, key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  <span style="color:#ff79c6">if</span> (property <span style="color:#ff79c6">&amp;&amp;</span> property.configurable <span style="color:#ff79c6">===</span> <span style="color:#ff79c6">false</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#ff79c6">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  <span style="color:#6272a4">/*å¦‚æœä¹‹å‰è¯¥å¯¹è±¡å·²ç»é¢„è®¾äº†getterä»¥åŠsetterå‡½æ•°åˆ™å°†å…¶å–å‡ºæ¥ï¼Œæ–°å®šä¹‰çš„getter/setterä¸­ä¼šå°†å…¶æ‰§è¡Œï¼Œä¿è¯ä¸ä¼šè¦†ç›–ä¹‹å‰å·²ç»å®šä¹‰çš„getter/setterã€‚*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  <span style="color:#6272a4">// cater for pre-defined getter/setters
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">const</span> getter <span style="color:#ff79c6">=</span> property <span style="color:#ff79c6">&amp;&amp;</span> property.get
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  <span style="color:#ff79c6">const</span> setter <span style="color:#ff79c6">=</span> property <span style="color:#ff79c6">&amp;&amp;</span> property.set
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>  <span style="color:#6272a4">/*å¯¹è±¡çš„å­å¯¹è±¡ä¹Ÿä¼šè¿›è¡Œobserve*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  <span style="color:#8be9fd;font-style:italic">let</span> childOb <span style="color:#ff79c6">=</span> observe(val)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  <span style="color:#8be9fd;font-style:italic">Object</span>.defineProperty(obj, key, {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    enumerable: <span style="color:#8be9fd">true</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    configurable: <span style="color:#8be9fd">true</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    get: <span style="color:#8be9fd">function</span> reactiveGetter () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>      <span style="color:#6272a4">/*å¦‚æœåŸæœ¬å¯¹è±¡æ‹¥æœ‰getteræ–¹æ³•åˆ™æ‰§è¡Œ*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>      <span style="color:#ff79c6">const</span> value <span style="color:#ff79c6">=</span> getter <span style="color:#ff79c6">?</span> getter.call(obj) <span style="color:#ff79c6">:</span> val
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    <span style="color:#6272a4">//   Dep.targetï¼šå…¨å±€å±æ€§ï¼Œç”¨äºæŒ‡å‘æŸä¸€ä¸ªwatcherï¼Œç”¨å®Œå³ä¸¢
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">if</span> (Dep.target) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>        <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#6272a4">        è¿›è¡Œä¾èµ–æ”¶é›†
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#6272a4">        dep.depend()å†…éƒ¨å®ç°addDepï¼Œå¾€depä¸­æ·»åŠ watcherå®ä¾‹ (å…·ä½“å‚è€ƒDep.prototype.dependçš„ä»£ç )
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#6272a4">        dependçš„æ—¶å€™ä¼šæ ¹æ®idåˆ¤æ–­watcheræœ‰æ²¡æœ‰æ·»åŠ è¿‡ï¼Œé¿å…é‡å¤æ·»åŠ ä¾èµ–
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4">        */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        dep.depend()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>        <span style="color:#ff79c6">if</span> (childOb) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>          <span style="color:#6272a4">/*å­å¯¹è±¡è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå…¶å®å°±æ˜¯å°†åŒä¸€ä¸ªwatcherè§‚å¯Ÿè€…å®ä¾‹æ”¾è¿›äº†ä¸¤ä¸ªdependä¸­ï¼Œä¸€ä¸ªæ˜¯æ­£åœ¨æœ¬èº«é—­åŒ…ä¸­çš„dependï¼Œå¦ä¸€ä¸ªæ˜¯å­å…ƒç´ çš„depend*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>          childOb.dep.depend()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>        <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(value)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>          <span style="color:#6272a4">/*æ˜¯æ•°ç»„åˆ™éœ€è¦å¯¹æ¯ä¸€ä¸ªæˆå‘˜éƒ½è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå¦‚æœæ•°ç»„çš„æˆå‘˜è¿˜æ˜¯æ•°ç»„ï¼Œåˆ™é€’å½’ã€‚*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>          dependArray(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>      <span style="color:#ff79c6">return</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>    set: <span style="color:#8be9fd">function</span> reactiveSetter (newVal) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>      <span style="color:#6272a4">/*é€šè¿‡getteræ–¹æ³•è·å–å½“å‰å€¼ï¼Œä¸æ–°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¸€è‡´åˆ™ä¸éœ€è¦æ‰§è¡Œä¸‹é¢çš„æ“ä½œ*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>      <span style="color:#ff79c6">const</span> value <span style="color:#ff79c6">=</span> getter <span style="color:#ff79c6">?</span> getter.call(obj) <span style="color:#ff79c6">:</span> val
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>      <span style="color:#6272a4">/* eslint-disable no-self-compare */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>      <span style="color:#ff79c6">if</span> (newVal <span style="color:#ff79c6">===</span> value <span style="color:#ff79c6">||</span> (newVal <span style="color:#ff79c6">!==</span> newVal <span style="color:#ff79c6">&amp;&amp;</span> value <span style="color:#ff79c6">!==</span> value)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>        <span style="color:#ff79c6">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>      <span style="color:#6272a4">/* eslint-enable no-self-compare */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>      <span style="color:#ff79c6">if</span> (process.env.NODE_ENV <span style="color:#ff79c6">!==</span> <span style="color:#f1fa8c">&#39;production&#39;</span> <span style="color:#ff79c6">&amp;&amp;</span> customSetter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>        customSetter()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>      <span style="color:#ff79c6">if</span> (setter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>        <span style="color:#6272a4">/*å¦‚æœåŸæœ¬å¯¹è±¡æ‹¥æœ‰setteræ–¹æ³•åˆ™æ‰§è¡Œsetter*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>        setter.call(obj, newVal)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>      } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>        val <span style="color:#ff79c6">=</span> newVal
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>      <span style="color:#6272a4">/*æ–°çš„å€¼éœ€è¦é‡æ–°è¿›è¡Œobserveï¼Œä¿è¯æ•°æ®å“åº”å¼*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>      childOb <span style="color:#ff79c6">=</span> observe(newVal)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>      <span style="color:#6272a4">/*depå¯¹è±¡é€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>      dep.notify()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>  })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>}
</code></pre></div><p>defineReactive()æ–¹æ³•ä¸»è¦é€šè¿‡Object.defineProperty()åšäº†ä»¥ä¸‹å‡ ä»¶äº‹:</p>
<ul>
<li>åœ¨é—­åŒ…é‡Œå®šä¹‰ä¸€ä¸ªDepå®ä¾‹ï¼›</li>
<li>getterç”¨æ¥æ”¶é›†ä¾èµ–ï¼ŒDep.targetæ˜¯ä¸€ä¸ªå…¨å±€çš„å±æ€§ï¼ŒæŒ‡å‘çš„é‚£ä¸ªwatcheræ”¶é›†åˆ°depé‡Œæ¥ï¼ˆå¦‚æœä¹‹å‰æ·»åŠ è¿‡å°±ä¸ä¼šé‡å¤æ·»åŠ ï¼‰ï¼›</li>
<li>setteræ˜¯åœ¨æ›´æ–°valueçš„æ—¶å€™é€šçŸ¥æ‰€æœ‰getteræ—¶å€™é€šçŸ¥æ‰€æœ‰æ”¶é›†çš„ä¾èµ–è¿›è¡Œæ›´æ–°ï¼ˆdep.notifyï¼‰ã€‚è¿™è¾¹ä¼šåšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœnewValå’ŒoldValä¸€æ ·ï¼Œå°±ä¸ä¼šæœ‰æ“ä½œã€‚</li>
</ul>
<h2 id="3-dep">3. Dep</h2>
<p>åœ¨ä¸Šé¢çš„defineReactiveä¸­æåˆ°äº†Depï¼Œäºæ˜¯æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹Depçš„æºç , depä¸»è¦æ˜¯ç”¨æ¥åœ¨æ•°æ®æ›´æ–°çš„æ—¶å€™é€šçŸ¥watchersè¿›è¡Œæ›´æ–°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"> * A dep is an observable that can have multiple
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"> * directives subscribing to it.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"> */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">default</span> <span style="color:#ff79c6">class</span> Dep {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#ff79c6">static</span> target: <span style="color:#8be9fd">?Watcher</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  id: <span style="color:#8be9fd">number</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  subs: <span style="color:#8be9fd">Array</span>&lt;<span style="color:#ff79c6">Watcher</span>&gt;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">constructor</span> () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#ff79c6">this</span>.id <span style="color:#ff79c6">=</span> uid<span style="color:#ff79c6">++</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#6272a4">// subs: Array&lt;Watcher&gt;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.subs <span style="color:#ff79c6">=</span> []
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  <span style="color:#6272a4">/*æ·»åŠ ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  addSub (sub: <span style="color:#8be9fd">Watcher</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#ff79c6">this</span>.subs.push(sub)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  <span style="color:#6272a4">/*ç§»é™¤ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  removeSub (sub: <span style="color:#8be9fd">Watcher</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    remove(<span style="color:#ff79c6">this</span>.subs, sub)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  <span style="color:#6272a4">/*ä¾èµ–æ”¶é›†ï¼Œå½“å­˜åœ¨Dep.targetçš„æ—¶å€™æ·»åŠ è§‚å¯Ÿè€…å¯¹è±¡*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#6272a4">//   åœ¨defineReactiveçš„getterä¸­ä¼šç”¨åˆ°dep.depend()
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#6272a4"></span>  depend () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    <span style="color:#ff79c6">if</span> (Dep.target) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>        <span style="color:#6272a4">// Dep.targetæŒ‡å‘çš„æ˜¯ä¸€ä¸ªwatcher
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#6272a4"></span>      Dep.target.addDep(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>  <span style="color:#6272a4">/*é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>  notify () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>    <span style="color:#6272a4">// stabilize the subscriber list first
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> subs <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.subs.slice()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>, l <span style="color:#ff79c6">=</span> subs.length; i <span style="color:#ff79c6">&lt;</span> l; i<span style="color:#ff79c6">++</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>        <span style="color:#6272a4">// è°ƒç”¨æ¯ä¸€ä¸ªwatcherçš„update
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#6272a4"></span>      subs[i].update()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#6272a4">// the current target watcher being evaluated.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span style="color:#6272a4">// this is globally unique because there could be only one
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span style="color:#6272a4">// watcher being evaluated at any time.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span style="color:#6272a4"></span>Dep.target <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span style="color:#6272a4">/*ä¾èµ–æ”¶é›†å®Œéœ€è¦å°†Dep.targetè®¾ä¸ºnullï¼Œé˜²æ­¢åé¢é‡å¤æ·»åŠ ä¾èµ–ã€‚*/</span>
</code></pre></div><ul>
<li>Depæ˜¯ä¸€ä¸ªå‘å¸ƒè€…ï¼Œå¯ä»¥è®¢é˜…å¤šä¸ªè§‚å¯Ÿè€…ï¼Œä¾èµ–æ”¶é›†ä¹‹åDepä¸­ä¼šæœ‰ä¸€ä¸ªsubså­˜æ”¾ä¸€ä¸ªæˆ–å¤šä¸ªè§‚å¯Ÿè€…ï¼Œåœ¨æ•°æ®å˜æ›´çš„æ—¶å€™é€šçŸ¥æ‰€æœ‰çš„watcherã€‚</li>
<li>å†å¤ä¹ ä¸€ä¸‹ï¼ŒDepå’ŒObserverçš„å…³ç³»å°±æ˜¯Observerç›‘å¬æ•´ä¸ªdataï¼Œéå†dataçš„æ¯ä¸ªå±æ€§ç»™æ¯ä¸ªå±æ€§ç»‘å®šdefineReactiveæ–¹æ³•åŠ«æŒgetterå’Œsetter, åœ¨getterçš„æ—¶å€™å¾€Depç±»é‡Œå¡ä¾èµ–ï¼ˆdep.dependï¼‰ï¼Œåœ¨setterçš„æ—¶å€™é€šçŸ¥æ‰€æœ‰watcherè¿›è¡Œupdate(dep.notify)</li>
</ul>
<h2 id="4-watcher">4. Watcher</h2>
<p>watcheræ¥å—åˆ°é€šçŸ¥ä¹‹åï¼Œä¼šé€šè¿‡å›è°ƒå‡½æ•°è¿›è¡Œæ›´æ–°ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦ä»”ç»†çœ‹ä¸€ä¸‹watcherçš„æºç ã€‚ç”±ä¹‹å‰çš„Depä»£ç å¯çŸ¥çš„æ˜¯ï¼Œwatcheréœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>dep.depend()çš„æ—¶å€™å¾€depé‡Œæ·»åŠ è‡ªå·±ï¼›</li>
<li>dep.notify()çš„æ—¶å€™è°ƒç”¨watcher.update()æ–¹æ³•ï¼Œå¯¹è§†å›¾è¿›è¡Œæ›´æ–°ï¼›</li>
</ul>
<p>åŒæ—¶è¦æ³¨æ„çš„æ˜¯ï¼Œwatcheræœ‰ä¸‰ç§ï¼šrender watcher/ computed watcher/ user watcher(å°±æ˜¯vueæ–¹æ³•ä¸­çš„é‚£ä¸ªwatch)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">default</span> <span style="color:#ff79c6">class</span> Watcher {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span>  vm: <span style="color:#8be9fd">Component</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span>  expression: <span style="color:#8be9fd">string</span>; <span style="color:#6272a4">// æ¯ä¸€ä¸ªDOM attrå¯¹åº”çš„string
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span style="color:#6272a4"></span>  cb: <span style="color:#8be9fd">Function</span>; <span style="color:#6272a4">// updateçš„æ—¶å€™çš„å›è°ƒå‡½æ•°
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span style="color:#6272a4"></span>  id: <span style="color:#8be9fd">number</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span>  deep: <span style="color:#8be9fd">boolean</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span>  user: <span style="color:#8be9fd">boolean</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span>  lazy: <span style="color:#8be9fd">boolean</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span>  sync: <span style="color:#8be9fd">boolean</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span>  dirty: <span style="color:#8be9fd">boolean</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span>  active: <span style="color:#8be9fd">boolean</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span>  deps: <span style="color:#8be9fd">Array</span>&lt;<span style="color:#ff79c6">Dep</span>&gt;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span>  newDeps: <span style="color:#8be9fd">Array</span>&lt;<span style="color:#ff79c6">Dep</span>&gt;;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span>  depIds: <span style="color:#8be9fd">ISet</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span>  newDepIds: <span style="color:#8be9fd">ISet</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span>  getter: <span style="color:#8be9fd">Function</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span>  value: <span style="color:#8be9fd">any</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span>  <span style="color:#ff79c6">constructor</span> (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span>    vm: <span style="color:#8be9fd">Component</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span>    expOrFn: <span style="color:#8be9fd">string</span> <span style="color:#ff79c6">|</span> <span style="color:#8be9fd;font-style:italic">Function</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span>    cb: <span style="color:#8be9fd">Function</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span>    options?: <span style="color:#8be9fd">Object</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>  ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span>    <span style="color:#ff79c6">this</span>.vm <span style="color:#ff79c6">=</span> vm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>    <span style="color:#6272a4">/*_watcherså­˜æ”¾è®¢é˜…è€…å®ä¾‹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>    vm._watchers.push(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>    <span style="color:#6272a4">// options
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (options) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>      <span style="color:#ff79c6">this</span>.deep <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">!!</span>options.deep
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>      <span style="color:#ff79c6">this</span>.user <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">!!</span>options.user
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span>      <span style="color:#ff79c6">this</span>.lazy <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">!!</span>options.lazy
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span>      <span style="color:#ff79c6">this</span>.sync <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">!!</span>options.sync
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span>      <span style="color:#ff79c6">this</span>.deep <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.user <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.lazy <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.sync <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span>    <span style="color:#ff79c6">this</span>.cb <span style="color:#ff79c6">=</span> cb
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>    <span style="color:#ff79c6">this</span>.id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">++</span>uid <span style="color:#6272a4">// uid for batching
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.active <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>    <span style="color:#ff79c6">this</span>.dirty <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.lazy <span style="color:#6272a4">// for lazy watchers
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.deps <span style="color:#ff79c6">=</span> []
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span>    <span style="color:#ff79c6">this</span>.newDeps <span style="color:#ff79c6">=</span> []
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span>    <span style="color:#ff79c6">this</span>.depIds <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Set()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span>    <span style="color:#ff79c6">this</span>.newDepIds <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Set()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span>    <span style="color:#ff79c6">this</span>.expression <span style="color:#ff79c6">=</span> process.env.NODE_ENV <span style="color:#ff79c6">!==</span> <span style="color:#f1fa8c">&#39;production&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>      <span style="color:#ff79c6">?</span> expOrFn.toString()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span>      <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span>    <span style="color:#6272a4">// parse expression for getter
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/*æŠŠè¡¨è¾¾å¼expOrFnè§£ææˆgetter*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> expOrFn <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;function&#39;</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>      <span style="color:#ff79c6">this</span>.getter <span style="color:#ff79c6">=</span> expOrFn
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>      <span style="color:#ff79c6">this</span>.getter <span style="color:#ff79c6">=</span> parsePath(expOrFn)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span>      <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.getter) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>        <span style="color:#ff79c6">this</span>.getter <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">function</span> () {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>        process.env.NODE_ENV <span style="color:#ff79c6">!==</span> <span style="color:#f1fa8c">&#39;production&#39;</span> <span style="color:#ff79c6">&amp;&amp;</span> warn(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>          <span style="color:#f1fa8c">`Failed watching path: &#34;</span><span style="color:#f1fa8c">${</span>expOrFn<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34; `</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>          <span style="color:#f1fa8c">&#39;Watcher only accepts simple dot-delimited paths. &#39;</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>          <span style="color:#f1fa8c">&#39;For full control, use a function instead.&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>          vm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>        )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>    <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.lazy
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>      <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">undefined</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span>      <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">this</span>.get()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span><span style="color:#6272a4">   * Evaluate the getter, and re-collect dependencies.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>   <span style="color:#6272a4">/*è·å¾—getterçš„å€¼å¹¶ä¸”é‡æ–°è¿›è¡Œä¾èµ–æ”¶é›†*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span>  get () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>    <span style="color:#6272a4">/*å°†è‡ªèº«watcherè§‚å¯Ÿè€…å®ä¾‹è®¾ç½®ç»™Dep.targetï¼Œç”¨ä»¥ä¾èµ–æ”¶é›†ã€‚*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span>    pushTarget(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>    <span style="color:#8be9fd;font-style:italic">let</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>    <span style="color:#ff79c6">const</span> vm <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.vm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span>    <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span><span style="color:#6272a4">      æ‰§è¡Œäº†getteræ“ä½œï¼Œçœ‹ä¼¼æ‰§è¡Œäº†æ¸²æŸ“æ“ä½œï¼Œå…¶å®æ˜¯æ‰§è¡Œäº†ä¾èµ–æ”¶é›†ã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span><span style="color:#6272a4">      åœ¨å°†Dep.targetè®¾ç½®ä¸ºè‡ªèº«è§‚å¯Ÿè€…å®ä¾‹ä»¥åï¼Œæ‰§è¡Œgetteræ“ä½œã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span><span style="color:#6272a4">      è­¬å¦‚è¯´ç°åœ¨çš„çš„dataä¸­å¯èƒ½æœ‰aã€bã€cä¸‰ä¸ªæ•°æ®ï¼Œgetteræ¸²æŸ“éœ€è¦ä¾èµ–aè·Ÿcï¼Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span><span style="color:#6272a4">      é‚£ä¹ˆåœ¨æ‰§è¡Œgetterçš„æ—¶å€™å°±ä¼šè§¦å‘aè·Ÿcä¸¤ä¸ªæ•°æ®çš„getterå‡½æ•°ï¼Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span><span style="color:#6272a4">      åœ¨getterå‡½æ•°ä¸­å³å¯åˆ¤æ–­Dep.targetæ˜¯å¦å­˜åœ¨ç„¶åå®Œæˆä¾èµ–æ”¶é›†ï¼Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span style="color:#6272a4">      å°†è¯¥è§‚å¯Ÿè€…å¯¹è±¡æ”¾å…¥é—­åŒ…ä¸­çš„Depçš„subsä¸­å»ã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span><span style="color:#6272a4">    */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.user) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>        <span style="color:#6272a4">// this.user: åˆ¤æ–­æ˜¯ä¸æ˜¯vueä¸­é‚£ä¸ªwatchæ–¹æ³•ç»‘å®šçš„watcher
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>        value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.getter.call(vm, vm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>      } <span style="color:#ff79c6">catch</span> (e) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>        handleError(e, vm, <span style="color:#f1fa8c">`getter for watcher &#34;</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.expression<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;`</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>      value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.getter.call(vm, vm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>    <span style="color:#6272a4">// &#34;touch&#34; every property so they are all tracked as
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// dependencies for deep watching
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/*å¦‚æœå­˜åœ¨deepï¼Œåˆ™è§¦å‘æ¯ä¸ªæ·±å±‚å¯¹è±¡çš„ä¾èµ–ï¼Œè¿½è¸ªå…¶å˜åŒ–*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.deep) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span>      <span style="color:#6272a4">/*é€’å½’æ¯ä¸€ä¸ªå¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œè§¦å‘å®ƒä»¬çš„getterï¼Œä½¿å¾—å¯¹è±¡æˆ–æ•°ç»„çš„æ¯ä¸€ä¸ªæˆå‘˜éƒ½è¢«ä¾èµ–æ”¶é›†ï¼Œå½¢æˆä¸€ä¸ªâ€œæ·±ï¼ˆdeepï¼‰â€ä¾èµ–å…³ç³»*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>      traverse(value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>    <span style="color:#6272a4">/*å°†è§‚å¯Ÿè€…å®ä¾‹ä»targetæ ˆä¸­å–å‡ºå¹¶è®¾ç½®ç»™Dep.target*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>    popTarget()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>    <span style="color:#ff79c6">this</span>.cleanupDeps()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>    <span style="color:#ff79c6">return</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span><span style="color:#6272a4">   * Add a dependency to this directive.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span>   <span style="color:#6272a4">/*æ·»åŠ ä¸€ä¸ªä¾èµ–å…³ç³»åˆ°Depsé›†åˆä¸­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span> <span style="color:#6272a4">//  åœ¨dep.depend()ä¸­è°ƒç”¨çš„æ˜¯Dep.target.addDep()
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span><span style="color:#6272a4"></span>  addDep (dep: <span style="color:#8be9fd">Dep</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span>    <span style="color:#ff79c6">const</span> id <span style="color:#ff79c6">=</span> dep.id
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.newDepIds.has(id)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span>        <span style="color:#6272a4">// newDepIdså’ŒnewDepsè®°å½•watcherå®ä¾‹æ‰€ç”¨åˆ°çš„depï¼Œæ¯”å¦‚æŸä¸ªcomputed watcherå…¶å®ç”¨åˆ°äº†dataé‡Œçš„a/b/cä¸‰ä¸ªå±æ€§ï¼Œé‚£å°±éœ€è¦è®°å½•3ä¸ªdep
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">this</span>.newDepIds.add(id)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span>      <span style="color:#ff79c6">this</span>.newDeps.push(dep)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span>      <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.depIds.has(id)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span>        <span style="color:#6272a4">//  ä½œç”¨æ˜¯å¾€depçš„subsé‡Œæ·»åŠ è‡ªå·±ï¼ˆWatcherå®ä¾‹ï¼‰
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//  ä½†æ˜¯ä¼šå…ˆåˆ¤æ–­ä¸€ä¸‹idï¼Œå¦‚æœsubsé‡Œæœ‰ç›¸åŒçš„idå°±ä¸ä¼šé‡å¤æ·»åŠ 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span><span style="color:#6272a4"></span>        dep.addSub(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131</span><span style="color:#6272a4">   * Clean up for dependency collection.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133</span>   <span style="color:#6272a4">/*æ¸…ç†ä¾èµ–æ”¶é›†*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134</span>  cleanupDeps () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135</span>    <span style="color:#6272a4">/*ç§»é™¤æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136</span>    <span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.deps.length
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137</span>    <span style="color:#ff79c6">while</span> (i<span style="color:#ff79c6">--</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138</span>      <span style="color:#ff79c6">const</span> dep <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.deps[i]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139</span>      <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.newDepIds.has(dep.id)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140</span>        dep.removeSub(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143</span>    <span style="color:#8be9fd;font-style:italic">let</span> tmp <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.depIds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144</span>    <span style="color:#ff79c6">this</span>.depIds <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.newDepIds
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145</span>    <span style="color:#ff79c6">this</span>.newDepIds <span style="color:#ff79c6">=</span> tmp
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146</span>    <span style="color:#ff79c6">this</span>.newDepIds.clear()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147</span>    tmp <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.deps
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148</span>    <span style="color:#ff79c6">this</span>.deps <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.newDeps
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149</span>    <span style="color:#ff79c6">this</span>.newDeps <span style="color:#ff79c6">=</span> tmp
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150</span>    <span style="color:#ff79c6">this</span>.newDeps.length <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154</span><span style="color:#6272a4">   * Subscriber interface.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155</span><span style="color:#6272a4">   * Will be called when a dependency changes.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157</span><span style="color:#6272a4">//   dep.notifyçš„æ—¶å€™ä¼šé€ä¸ªè°ƒç”¨watcherçš„updateæ–¹æ³•
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158</span><span style="color:#6272a4"></span>  update () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159</span>    <span style="color:#6272a4">/* istanbul ignore else */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.lazy) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161</span>      <span style="color:#ff79c6">this</span>.dirty <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162</span>    } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.sync) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163</span>      <span style="color:#6272a4">/*åŒæ­¥åˆ™æ‰§è¡Œrunç›´æ¥æ¸²æŸ“è§†å›¾*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164</span>      <span style="color:#6272a4">// åŸºæœ¬ä¸ä¼šç”¨åˆ°sync
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165</span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">this</span>.run()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167</span>      <span style="color:#6272a4">/*å¼‚æ­¥æ¨é€åˆ°è§‚å¯Ÿè€…é˜Ÿåˆ—ä¸­ï¼Œç”±è°ƒåº¦è€…è°ƒç”¨ã€‚*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168</span>      queueWatcher(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173</span><span style="color:#6272a4">   * Scheduler job interface.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174</span><span style="color:#6272a4">   * Will be called by the scheduler.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176</span>   <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177</span><span style="color:#6272a4">      è°ƒåº¦è€…å·¥ä½œæ¥å£ï¼Œå°†è¢«è°ƒåº¦è€…å›è°ƒã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178</span><span style="color:#6272a4">    */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179</span>  run () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.active) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181</span>      <span style="color:#ff79c6">const</span> value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.get()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182</span>      <span style="color:#ff79c6">if</span> (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183</span>        value <span style="color:#ff79c6">!==</span> <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184</span>        <span style="color:#6272a4">// Deep watchers and watchers on Object/Arrays should fire even
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// when the value is the same, because the value may
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// have mutated.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188</span><span style="color:#6272a4">            å³ä¾¿å€¼ç›¸åŒï¼Œæ‹¥æœ‰Deepå±æ€§çš„è§‚å¯Ÿè€…ä»¥åŠåœ¨å¯¹è±¡ï¼æ•°ç»„ä¸Šçš„è§‚å¯Ÿè€…åº”è¯¥è¢«è§¦å‘æ›´æ–°ï¼Œå› ä¸ºå®ƒä»¬çš„å€¼å¯èƒ½å‘ç”Ÿæ”¹å˜ã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189</span><span style="color:#6272a4">        */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190</span>        isObject(value) <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191</span>        <span style="color:#ff79c6">this</span>.deep
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192</span>      ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193</span>        <span style="color:#6272a4">// set new value
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">const</span> oldValue <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195</span>        <span style="color:#6272a4">/*è®¾ç½®æ–°çš„å€¼*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196</span>        <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> value
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198</span>        <span style="color:#6272a4">/*è§¦å‘å›è°ƒæ¸²æŸ“è§†å›¾*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199</span>        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.user) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200</span>          <span style="color:#ff79c6">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201</span>            <span style="color:#ff79c6">this</span>.cb.call(<span style="color:#ff79c6">this</span>.vm, value, oldValue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202</span>          } <span style="color:#ff79c6">catch</span> (e) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203</span>            handleError(e, <span style="color:#ff79c6">this</span>.vm, <span style="color:#f1fa8c">`callback for watcher &#34;</span><span style="color:#f1fa8c">${</span><span style="color:#ff79c6">this</span>.expression<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;`</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205</span>        } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206</span>          <span style="color:#ff79c6">this</span>.cb.call(<span style="color:#ff79c6">this</span>.vm, value, oldValue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213</span><span style="color:#6272a4">   * Evaluate the value of the watcher.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214</span><span style="color:#6272a4">   * This only gets called for lazy watchers.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216</span>   <span style="color:#6272a4">/*è·å–è§‚å¯Ÿè€…çš„å€¼*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217</span>  evaluate () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218</span>    <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.get()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219</span>    <span style="color:#ff79c6">this</span>.dirty <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223</span><span style="color:#6272a4">   * Depend on all deps collected by this watcher.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225</span>   <span style="color:#6272a4">/*æ”¶é›†è¯¥watcherçš„æ‰€æœ‰depsä¾èµ–*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226</span>  depend () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227</span>    <span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.deps.length
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228</span>    <span style="color:#ff79c6">while</span> (i<span style="color:#ff79c6">--</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229</span>      <span style="color:#ff79c6">this</span>.deps[i].depend()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233</span>  <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234</span><span style="color:#6272a4">   * Remove self from all dependencies&#39; subscriber list.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235</span><span style="color:#6272a4">   */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236</span>   <span style="color:#6272a4">/*å°†è‡ªèº«ä»æ‰€æœ‰ä¾èµ–æ”¶é›†è®¢é˜…åˆ—è¡¨åˆ é™¤*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237</span>  teardown () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">this</span>.active) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239</span>      <span style="color:#6272a4">// remove self from vm&#39;s watcher list
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240</span><span style="color:#6272a4"></span>      <span style="color:#6272a4">// this is a somewhat expensive operation so we skip it
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241</span><span style="color:#6272a4"></span>      <span style="color:#6272a4">// if the vm is being destroyed.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242</span><span style="color:#6272a4"></span>      <span style="color:#6272a4">/*ä»vmå®ä¾‹çš„è§‚å¯Ÿè€…åˆ—è¡¨ä¸­å°†è‡ªèº«ç§»é™¤ï¼Œç”±äºè¯¥æ“ä½œæ¯”è¾ƒè€—è´¹èµ„æºï¼Œæ‰€ä»¥å¦‚æœvmå®ä¾‹æ­£åœ¨è¢«é”€æ¯åˆ™è·³è¿‡è¯¥æ­¥éª¤ã€‚*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243</span>      <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.vm._isBeingDestroyed) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244</span>        remove(<span style="color:#ff79c6">this</span>.vm._watchers, <span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246</span>      <span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.deps.length
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247</span>      <span style="color:#ff79c6">while</span> (i<span style="color:#ff79c6">--</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">248</span>        <span style="color:#ff79c6">this</span>.deps[i].removeSub(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">249</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">250</span>      <span style="color:#ff79c6">this</span>.active <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">251</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">252</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">253</span>}
</code></pre></div><p>è¦æ³¨æ„çš„æ˜¯ï¼Œwatcherä¸­æœ‰ä¸ªsyncå±æ€§ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œwatcherå¹¶ä¸æ˜¯åŒæ­¥æ›´æ–°çš„ï¼Œè€Œæ˜¯é‡‡ç”¨å¼‚æ­¥æ›´æ–°çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code>queueWatcher(this)</code>æ¨é€åˆ°è§‚å¯Ÿè€…é˜Ÿåˆ—å½“ä¸­ï¼Œå¾…nextTickçš„æ—¶å€™è¿›è¡Œè°ƒç”¨ã€‚</p>

      </div>
      <div class="footer">
        <span><a class="category" href="https://tomtomyoung.top/%20categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a><a class="category" href="https://tomtomyoung.top/%20categories/%E7%B2%BE%E9%80%89/">ç²¾é€‰</a></span>
        <span><a class="tag" href="https://tomtomyoung.top/%20tags/vue/">vue</a></span>
      </div>
    </div>

    <ul class="menu">
    <li class="menu-item">
        <i class="iconfont icon-top item-btn" id="back_top_btn"></i>
    </li>
    <li class="menu-item">
        <a href="https://tomtomyoung.top/" id="back-btn">
            <i class="iconfont icon-home item-btn"></i>
        </a>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-switch item-btn" id="switch_btn"></i>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-search item-btn" id="search_btn"></i>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/vue%E4%B8%8Ereact%E7%9A%84%E5%AF%B9%E6%AF%94/" data-tooltip="Vueä¸Reactå¯¹æ¯”">
            <i class="iconfont icon-left item-btn"></i>
            
        </a>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/vue-%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81%E8%AF%A6%E8%A7%A3/" data-tooltip="vue æ•°æ®åŠ«æŒè¯¦è§£">
            <i class="iconfont icon-right item-btn"></i>
            
        </a>
    </li>
</ul>

  </div>
</div>

<div class="cover" id="cover">
        <div class="search-container">
    <input type="search" class="docsearch-input search-input" placeholder="æœç´¢å…³é”®è¯" />
    <div id="loading" class="loading-container"></div>
</div>
    </div>
</body>






<script type="text/javascript" src="https://tomtomyoung.top/js/util.min.23fcb467e1267d2c197d5b376a19d64754a5273c549b0ff6810b60cca2dd4afda8c7d8c36cf8c7d9f60a285a94e8495929e857e4f239c4e1839649cf861c27d4.js" integrity=""></script></html>