<!DOCTYPE html>
<html lang="zh-cn" data-theme="light"><head>
  <meta name="google-site-verification" content="kw1N-Xm6qEr1c9PGuRd0U_T6DXkw_EHsLyz5LpuDDv8" />
  <meta name="msvalidate.01" content="EE98205D30806C22C519683EFC53E9BA" />
  <meta name="baidu-site-verification" content="iPC3wUcQLL" />
  <title> vue vdomä¸diffè¯¦è§£</title>
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.74.3" /><meta name="viewport" content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1" />
  <meta name="description" itemprop="description"
    content=" vue vdomä¸diffè¯¦è§£ " />
  <meta name="keywords" itemprop="keywords"
    content=" [vue vdom diff] " />
  <base href="https://tomtomyoung.top/" />


  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" media="print"
    onload="this.media='all'">

  
  <link rel="shortcut icon" href="https://tomtomyoung.top/favicons//favicon.ico" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://tomtomyoung.top/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://tomtomyoung.top/favicons/favicon-16x16.png" />
  <link rel="mask-icon" href="https://tomtomyoung.top/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="apple-touch-icon" sizes="180x180" href="https://tomtomyoung.top/favicons/apple-touch-icon.png">
  <meta name="msapplication-TileColor" content="#00aba9">
  <meta name="msapplication-TileImage" content="https://tomtomyoung.top/favicons/mstile-144x144.png">
  <link rel="manifest" href="https://tomtomyoung.top/manifest.json">

  
  <link rel="canonical" href="https://tomtomyoung.top/post/vue-vdom%E4%B8%8Ediff%E8%AF%A6%E8%A7%A3/" />
  <link rel="stylesheet" type="text/css" href="https://at.alicdn.com/t/font_2450869_5vzvggza71i.css" />
  
  
  
  
  
  
  
  
  
  <link rel="stylesheet" href="https://tomtomyoung.top/css/style.min.css" integrity="" type="text/css" />

  
  
  
  <script type="text/javascript" src="https://tomtomyoung.top/js/docsearch.min.js" integrity=""></script>
</head><body class="animated fadeInDown">
<div class="main"><div class="percentage_container">
    <div class="percentage" id="percentage"></div>
</div><div class="toc sub-container">
    <div class="toc-header">
        <span>ç›®å½•</span>
    </div><ul class="toc-h2"><li>
                <span class="toc-link">1. VNode</span>
            </li>
            <li>
                <span class="toc-link">2. ä¿®æ”¹è§†å›¾</span>
            </li>
            <li>
                <span class="toc-link">3. patch</span>
            </li>
            <li>
                <span class="toc-link">4. sameVnode</span>
            </li>
            <li>
                <span class="toc-link">5. patchVnode</span>
            </li>
            <li>
                <span class="toc-link">6. updateChildren</span>
            </li>
            <li>
                <span class="toc-link">7. DOMæ“ä½œ</span>
            </li>
            </div><div class="single-post container">
    <div class="post">
      <div class="header">
        <span class="title">vue vdomä¸diffè¯¦è§£</span>
        
        <div class="info">
          <span>ğŸ“… 2021-09-03</span>
          <span>ğŸ‘¦ Tomtom Young</span>
          <span>ğŸ“– 7546å­—</span>
          <span>â± 16åˆ†é’Ÿ</span>
        </div>
        
      </div>
      <div class="content markdown-body">
        <blockquote>
<p>å‚è€ƒï¼š</p>
<p><a href="https://xiaozhuanlan.com/topic/5970683214">VirtualDOM ä¸ diff( Vue å®ç°)</a></p>
</blockquote>
<h2 id="1-vnode">1. VNode</h2>
<p>åœ¨åˆ€è€•ç«ç§çš„å¹´ä»£ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å„ä¸ªäº‹ä»¶æ–¹æ³•ä¸­ç›´æ¥æ“ä½œDOMæ¥è¾¾åˆ°ä¿®æ”¹è§†å›¾çš„ç›®çš„ã€‚ä½†æ˜¯å½“åº”ç”¨ä¸€å¤§å°±ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚</p>
<p>é‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥æŠŠçœŸå®DOMæ ‘æŠ½è±¡æˆä¸€æ£µä»¥JavaScriptå¯¹è±¡æ„æˆçš„æŠ½è±¡æ ‘ï¼Œåœ¨ä¿®æ”¹æŠ½è±¡æ ‘æ•°æ®åå°†æŠ½è±¡æ ‘è½¬åŒ–æˆçœŸå®DOMé‡ç»˜åˆ°é¡µé¢ä¸Šå‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥Vue.jså°†DOMæ ‘æŠ½è±¡æˆä¸€ä¸ªä»¥JavaScriptå¯¹è±¡ä¸ºèŠ‚ç‚¹çš„è™šæ‹ŸDOMæ ‘ï¼Œä»¥VNodeèŠ‚ç‚¹æ¨¡æ‹ŸçœŸå®DOMèŠ‚ç‚¹ï¼Œå¯ä»¥å¯¹è¿™é¢—æŠ½è±¡æ ‘è¿›è¡Œåˆ›å»ºèŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ä»¥åŠä¿®æ”¹èŠ‚ç‚¹ç­‰æ“ä½œï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­éƒ½ä¸éœ€è¦æ“ä½œçœŸå®DOMï¼Œåªéœ€è¦æ“ä½œJavaScriptå¯¹è±¡ï¼Œå¤§å¤§æå‡äº†æ€§èƒ½ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·çš„JavaScriptæ“ä½œDOMè¿›è¡Œé‡ç»˜æ•´ä¸ªè§†å›¾æ˜¯ç›¸å½“æ¶ˆè€—æ€§èƒ½çš„ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥æ¯æ¬¡åªæ›´æ–°å®ƒçš„ä¿®æ”¹å‘¢ï¼Ÿ</p>
<p>åœ¨å¯¹VNodeæ ‘è¿›è¡Œä¿®æ”¹åï¼Œç»è¿‡diffç®—æ³•å¾—å‡ºä¸€äº›éœ€è¦ä¿®æ”¹çš„æœ€å°å•ä½ï¼Œå†å°†è¿™äº›å°å•ä½çš„è§†å›¾è¿›è¡Œæ›´æ–°ã€‚è¿™æ ·åšå‡å°‘äº†å¾ˆå¤šä¸éœ€è¦çš„DOMæ“ä½œï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½ã€‚</p>
<p>Vueå°±ä½¿ç”¨äº†è¿™æ ·çš„æŠ½è±¡èŠ‚ç‚¹VNodeï¼Œå®ƒæ˜¯å¯¹çœŸå®DOMçš„ä¸€å±‚æŠ½è±¡ï¼Œè€Œä¸ä¾èµ–æŸä¸ªå¹³å°ï¼Œå®ƒå¯ä»¥æ˜¯æµè§ˆå™¨å¹³å°ï¼Œä¹Ÿå¯ä»¥æ˜¯weexï¼Œç”šè‡³æ˜¯nodeå¹³å°ä¹Ÿå¯ä»¥å¯¹è¿™æ ·ä¸€æ£µæŠ½è±¡DOMæ ‘è¿›è¡Œåˆ›å»ºåˆ é™¤ä¿®æ”¹ç­‰æ“ä½œï¼Œè¿™ä¹Ÿä¸ºå‰åç«¯åŒæ„æä¾›äº†å¯èƒ½ã€‚</p>
<h2 id="2-ä¿®æ”¹è§†å›¾">2. ä¿®æ”¹è§†å›¾</h2>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒVueé€šè¿‡æ•°æ®ç»‘å®šæ¥ä¿®æ”¹è§†å›¾ï¼Œå½“æŸä¸ªæ•°æ®è¢«ä¿®æ”¹çš„æ—¶å€™ï¼Œsetæ–¹æ³•ä¼šè®©é—­åŒ…ä¸­çš„Depè°ƒç”¨notifyé€šçŸ¥æ‰€æœ‰è®¢é˜…è€…Watcherï¼ŒWatcheré€šè¿‡getæ–¹æ³•æ‰§è¡Œ<code>vm._update(vm._render(), hydrating)</code>ã€‚</p>
<p>è¿™é‡Œçœ‹ä¸€ä¸‹_updateæ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>Vue.prototype._update <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">function</span> (vnode<span style="color:#ff79c6">:</span> VNode, hydrating<span style="color:#ff79c6">?:</span> <span style="color:#ff79c6">boolean</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">const</span> vm<span style="color:#ff79c6">:</span> Component <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#6272a4">/*å¦‚æœå·²ç»è¯¥ç»„ä»¶å·²ç»æŒ‚è½½è¿‡äº†åˆ™ä»£è¡¨è¿›å…¥è¿™ä¸ªæ­¥éª¤æ˜¯ä¸ªæ›´æ–°çš„è¿‡ç¨‹ï¼Œè§¦å‘beforeUpdateé’©å­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">if</span> (vm._isMounted) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>      callHook(vm, <span style="color:#f1fa8c">&#39;beforeUpdate&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">const</span> prevEl <span style="color:#ff79c6">=</span> vm.$el
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#ff79c6">const</span> prevVnode <span style="color:#ff79c6">=</span> vm._vnode
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#ff79c6">const</span> prevActiveInstance <span style="color:#ff79c6">=</span> activeInstance
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    activeInstance <span style="color:#ff79c6">=</span> vm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    vm._vnode <span style="color:#ff79c6">=</span> vnode
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#6272a4">// Vue.prototype.__patch__ is injected in entry points
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// based on the rendering backend used.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/*åŸºäºåç«¯æ¸²æŸ“Vue.prototype.__patch__è¢«ç”¨æ¥ä½œä¸ºä¸€ä¸ªå…¥å£*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>prevVnode) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>      <span style="color:#6272a4">// initial render
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4"></span>      vm.$el <span style="color:#ff79c6">=</span> vm.__patch__(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        vm.$el, vnode, hydrating, <span style="color:#ff79c6">false</span> <span style="color:#6272a4">/* removeOnly */</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        vm.$options._parentElm,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        vm.$options._refElm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>      )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>      <span style="color:#6272a4">// updates
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#6272a4"></span>      vm.$el <span style="color:#ff79c6">=</span> vm.__patch__(prevVnode, vnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    activeInstance <span style="color:#ff79c6">=</span> prevActiveInstance
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#6272a4">// update __vue__ reference
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/*æ›´æ–°æ–°çš„å®ä¾‹å¯¹è±¡çš„__vue__*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    <span style="color:#ff79c6">if</span> (prevEl) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>      prevEl.__vue__ <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    <span style="color:#ff79c6">if</span> (vm.$el) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>      vm.$el.__vue__ <span style="color:#ff79c6">=</span> vm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    <span style="color:#6272a4">// if parent is an HOC, update its $el as well
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (vm.$vnode <span style="color:#ff79c6">&amp;&amp;</span> vm.$parent <span style="color:#ff79c6">&amp;&amp;</span> vm.$vnode <span style="color:#ff79c6">===</span> vm.$parent._vnode) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>      vm.$parent.$el <span style="color:#ff79c6">=</span> vm.$el
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    <span style="color:#6272a4">// updated hook is called by the scheduler to ensure that children are
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// updated in a parent&#39;s updated hook.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#6272a4"></span>  }
</code></pre></div><p>_updateæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªVNodeå¯¹è±¡ï¼Œåœ¨å†…éƒ¨ä¼šå°†è¯¥VNodeå¯¹è±¡ä¸ä¹‹å‰æ—§çš„VNodeå¯¹è±¡è¿›è¡Œ<code>__patch__</code>ã€‚</p>
<h2 id="3-__patch__">3. <strong>patch</strong></h2>
<p>patchå°†æ–°è€VNodeèŠ‚ç‚¹è¿›è¡Œæ¯”å¯¹ï¼Œç„¶åå°†æ ¹æ®ä¸¤è€…çš„æ¯”è¾ƒç»“æœè¿›è¡Œæœ€å°å•ä½åœ°ä¿®æ”¹è§†å›¾ï¼Œè€Œä¸æ˜¯å°†æ•´ä¸ªè§†å›¾æ ¹æ®æ–°çš„VNodeé‡ç»˜ã€‚patchçš„æ ¸å¿ƒåœ¨äºdiffç®—æ³•ï¼Œè¿™å¥—ç®—æ³•å¯ä»¥é«˜æ•ˆåœ°æ¯”è¾ƒvirtual DOMçš„å˜æ›´ï¼Œå¾—å‡ºå˜åŒ–ä»¥ä¿®æ”¹è§†å›¾ã€‚</p>
<p>é‚£ä¹ˆpatchå¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆè¯´ä¸€ä¸‹patchçš„æ ¸å¿ƒdiffç®—æ³•ï¼Œdiffç®—æ³•æ˜¯é€šè¿‡åŒå±‚çš„æ ‘èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒè€Œéå¯¹æ ‘è¿›è¡Œé€å±‚æœç´¢éå†çš„æ–¹å¼ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦åªæœ‰O(n)ï¼Œæ˜¯ä¸€ç§ç›¸å½“é«˜æ•ˆçš„ç®—æ³•ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/db00c818c1da8f0dcc7919eb3577e37b.png" alt="img"></p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/f09aa38b6efcaf90698d60c0d7cda10f.png" alt="img"></p>
<p>è¿™ä¸¤å¼ å›¾ä»£è¡¨æ—§çš„VNodeä¸æ–°VNodeè¿›è¡Œpatchçš„è¿‡ç¨‹ï¼Œä»–ä»¬åªæ˜¯åœ¨åŒå±‚çº§çš„VNodeä¹‹é—´è¿›è¡Œæ¯”è¾ƒå¾—åˆ°å˜åŒ–ï¼ˆç¬¬äºŒå¼ å›¾ä¸­ç›¸åŒé¢œè‰²çš„æ–¹å—ä»£è¡¨äº’ç›¸è¿›è¡Œæ¯”è¾ƒçš„VNodeèŠ‚ç‚¹ï¼‰ï¼Œç„¶åä¿®æ”¹å˜åŒ–çš„è§†å›¾ï¼Œæ‰€ä»¥ååˆ†é«˜æ•ˆã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹patchçš„ä»£ç ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>  <span style="color:#6272a4">/*createPatchFunctionçš„è¿”å›å€¼ï¼Œä¸€ä¸ªpatchå‡½æ•°*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">function</span> patch (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#6272a4">/*vnodeä¸å­˜åœ¨åˆ™ç›´æ¥è°ƒç”¨é”€æ¯é’©å­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">if</span> (isUndef(vnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>      <span style="color:#ff79c6">if</span> (isDef(oldVnode)) invokeDestroyHook(oldVnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>      <span style="color:#ff79c6">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#8be9fd;font-style:italic">let</span> isInitialPatch <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">const</span> insertedVnodeQueue <span style="color:#ff79c6">=</span> []
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#ff79c6">if</span> (isUndef(oldVnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>      <span style="color:#6272a4">// empty mount (likely as component), create new root element
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>      <span style="color:#6272a4">/*oldVnodeæœªå®šä¹‰çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿå°±æ˜¯rootèŠ‚ç‚¹ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>      isInitialPatch <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>      createElm(vnode, insertedVnodeQueue, parentElm, refElm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      <span style="color:#6272a4">/*æ ‡è®°æ—§çš„VNodeæ˜¯å¦æœ‰nodeType*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>      <span style="color:#ff79c6">const</span> isRealElement <span style="color:#ff79c6">=</span> isDef(oldVnode.nodeType)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>      <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>isRealElement <span style="color:#ff79c6">&amp;&amp;</span> sameVnode(oldVnode, vnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        <span style="color:#6272a4">// patch existing root node
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">/*æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ç›´æ¥ä¿®æ”¹ç°æœ‰çš„èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        patchVnode(oldVnode, vnode, insertedVnodeQueue, removeOnly)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>      } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#ff79c6">if</span> (isRealElement) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>          <span style="color:#6272a4">// mounting to a real element
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">// check if this is server-rendered content and if we can perform
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">// a successful hydration.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#6272a4"></span>          <span style="color:#ff79c6">if</span> (oldVnode.nodeType <span style="color:#ff79c6">===</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&amp;&amp;</span> oldVnode.hasAttribute(SSR_ATTR)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>            <span style="color:#6272a4">/*å½“æ—§çš„VNodeæ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„å…ƒç´ ï¼Œhydratingè®°ä¸ºtrue*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>            oldVnode.removeAttribute(SSR_ATTR)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>            hydrating <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>          <span style="color:#ff79c6">if</span> (isTrue(hydrating)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>            <span style="color:#6272a4">/*éœ€è¦åˆå¹¶åˆ°çœŸå®DOMä¸Š*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>            <span style="color:#ff79c6">if</span> (hydrate(oldVnode, vnode, insertedVnodeQueue)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>              <span style="color:#6272a4">/*è°ƒç”¨inserté’©å­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>              invokeInsertHook(vnode, insertedVnodeQueue, <span style="color:#ff79c6">true</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>              <span style="color:#ff79c6">return</span> oldVnode
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>            } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (process.env.NODE_ENV <span style="color:#ff79c6">!==</span> <span style="color:#f1fa8c">&#39;production&#39;</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>              warn(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>                <span style="color:#f1fa8c">&#39;The client-side rendered virtual DOM tree is not matching &#39;</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>                <span style="color:#f1fa8c">&#39;server-rendered content. This is likely caused by incorrect &#39;</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>                <span style="color:#f1fa8c">&#39;HTML markup, for example nesting block-level elements inside &#39;</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>                <span style="color:#f1fa8c">&#39;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &#39;</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>                <span style="color:#f1fa8c">&#39;full client-side render.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>              )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>          <span style="color:#6272a4">// either not server-rendered, or hydration failed.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">// create an empty node and replace it
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">/*å¦‚æœä¸æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æˆ–è€…åˆå¹¶åˆ°çœŸå®DOMå¤±è´¥ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºçš„VNodeèŠ‚ç‚¹æ›¿æ¢å®ƒ*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>          oldVnode <span style="color:#ff79c6">=</span> emptyNodeAt(oldVnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>        <span style="color:#6272a4">// replacing existing element
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">/*å–ä»£ç°æœ‰å…ƒç´ */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>        <span style="color:#ff79c6">const</span> oldElm <span style="color:#ff79c6">=</span> oldVnode.elm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>        <span style="color:#ff79c6">const</span> parentElm <span style="color:#ff79c6">=</span> nodeOps.parentNode(oldElm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>        createElm(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>          vnode,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>          insertedVnodeQueue,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>          <span style="color:#6272a4">// extremely rare edge case: do not insert if old element is in a
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">// leaving transition. Only happens when combining transition +
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">// keep-alive + HOCs. (#4590)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span><span style="color:#6272a4"></span>          oldElm._leaveCb <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">:</span> parentElm,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>          nodeOps.nextSibling(oldElm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>        )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>        <span style="color:#ff79c6">if</span> (isDef(vnode.parent)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>          <span style="color:#6272a4">// component root element replaced.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">// update parent placeholder node element, recursively
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">/*ç»„ä»¶æ ¹èŠ‚ç‚¹è¢«æ›¿æ¢ï¼Œéå†æ›´æ–°çˆ¶èŠ‚ç‚¹element*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>          <span style="color:#8be9fd;font-style:italic">let</span> ancestor <span style="color:#ff79c6">=</span> vnode.parent
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>          <span style="color:#ff79c6">while</span> (ancestor) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span>            ancestor.elm <span style="color:#ff79c6">=</span> vnode.elm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>            ancestor <span style="color:#ff79c6">=</span> ancestor.parent
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span>          <span style="color:#ff79c6">if</span> (isPatchable(vnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span>            <span style="color:#6272a4">/*è°ƒç”¨createå›è°ƒ*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span>            <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> cbs.create.length; <span style="color:#ff79c6">++</span>i) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span>              cbs.create[i](emptyNode, vnode.parent)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86</span>        <span style="color:#ff79c6">if</span> (isDef(parentElm)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87</span>          <span style="color:#6272a4">/*ç§»é™¤è€èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88</span>          removeVnodes(parentElm, [oldVnode], <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89</span>        } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isDef(oldVnode.tag)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90</span>          <span style="color:#6272a4">/*è°ƒç”¨destroyé’©å­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91</span>          invokeDestroyHook(oldVnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">96</span>    <span style="color:#6272a4">/*è°ƒç”¨inserté’©å­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">97</span>    invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">98</span>    <span style="color:#ff79c6">return</span> vnode.elm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">99</span>  }
</code></pre></div><p>ä»ä»£ç ä¸­ä¸éš¾å‘ç°ï¼Œå½“oldVnodeä¸vnodeåœ¨sameVnodeçš„æ—¶å€™æ‰ä¼šè¿›è¡ŒpatchVnodeï¼Œä¹Ÿå°±æ˜¯æ–°æ—§VNodeèŠ‚ç‚¹åˆ¤å®šä¸ºåŒä¸€èŠ‚ç‚¹çš„æ—¶å€™æ‰ä¼šè¿›è¡ŒpatchVnodeè¿™ä¸ªè¿‡ç¨‹ï¼Œå¦åˆ™å°±æ˜¯åˆ›å»ºæ–°çš„DOMï¼Œç§»é™¤æ—§çš„DOMã€‚</p>
<p>æ€ä¹ˆæ ·çš„èŠ‚ç‚¹ç®—sameVnodeå‘¢ï¼Ÿ</p>
<h2 id="4-samevnode">4. sameVnode</h2>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹sameVnodeçš„å®ç°ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4">  åˆ¤æ–­ä¸¤ä¸ªVNodeèŠ‚ç‚¹æ˜¯å¦æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4">  keyç›¸åŒ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4">  tagï¼ˆå½“å‰èŠ‚ç‚¹çš„æ ‡ç­¾åï¼‰ç›¸åŒ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4">  isCommentï¼ˆæ˜¯å¦ä¸ºæ³¨é‡ŠèŠ‚ç‚¹ï¼‰ç›¸åŒ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4">  æ˜¯å¦dataï¼ˆå½“å‰èŠ‚ç‚¹å¯¹åº”çš„å¯¹è±¡ï¼ŒåŒ…å«äº†å…·ä½“çš„ä¸€äº›æ•°æ®ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªVNodeDataç±»å‹ï¼Œå¯ä»¥å‚è€ƒVNodeDataç±»å‹ä¸­çš„æ•°æ®ä¿¡æ¯ï¼‰éƒ½æœ‰å®šä¹‰
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4">  å½“æ ‡ç­¾æ˜¯&lt;input&gt;çš„æ—¶å€™ï¼Œtypeå¿…é¡»ç›¸åŒ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#8be9fd;font-style:italic">function</span> sameVnode (a, b) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#ff79c6">return</span> (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    a.key <span style="color:#ff79c6">===</span> b.key <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    a.tag <span style="color:#ff79c6">===</span> b.tag <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    a.isComment <span style="color:#ff79c6">===</span> b.isComment <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    isDef(a.data) <span style="color:#ff79c6">===</span> isDef(b.data) <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    sameInputType(a, b)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#6272a4">// Some browsers do not support dynamically changing type for &lt;input&gt;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#6272a4">// so they need to be treated as different nodes
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#6272a4"></span><span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4">  åˆ¤æ–­å½“æ ‡ç­¾æ˜¯&lt;input&gt;çš„æ—¶å€™ï¼Œtypeæ˜¯å¦ç›¸åŒ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#6272a4">  æŸäº›æµè§ˆå™¨ä¸æ”¯æŒåŠ¨æ€ä¿®æ”¹&lt;input&gt;ç±»å‹ï¼Œæ‰€ä»¥ä»–ä»¬è¢«è§†ä¸ºä¸åŒç±»å‹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span style="color:#8be9fd;font-style:italic">function</span> sameInputType (a, b) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  <span style="color:#ff79c6">if</span> (a.tag <span style="color:#ff79c6">!==</span> <span style="color:#f1fa8c">&#39;input&#39;</span>) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  <span style="color:#8be9fd;font-style:italic">let</span> i
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  <span style="color:#ff79c6">const</span> typeA <span style="color:#ff79c6">=</span> isDef(i <span style="color:#ff79c6">=</span> a.data) <span style="color:#ff79c6">&amp;&amp;</span> isDef(i <span style="color:#ff79c6">=</span> i.attrs) <span style="color:#ff79c6">&amp;&amp;</span> i.type
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  <span style="color:#ff79c6">const</span> typeB <span style="color:#ff79c6">=</span> isDef(i <span style="color:#ff79c6">=</span> b.data) <span style="color:#ff79c6">&amp;&amp;</span> isDef(i <span style="color:#ff79c6">=</span> i.attrs) <span style="color:#ff79c6">&amp;&amp;</span> i.type
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  <span style="color:#ff79c6">return</span> typeA <span style="color:#ff79c6">===</span> typeB
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>}
</code></pre></div><p>å½“ä¸¤ä¸ªVNodeçš„tagã€keyã€isCommentéƒ½ç›¸åŒï¼Œå¹¶ä¸”åŒæ—¶å®šä¹‰æˆ–æœªå®šä¹‰dataçš„æ—¶å€™ï¼Œä¸”å¦‚æœæ ‡ç­¾ä¸ºinputåˆ™typeå¿…é¡»ç›¸åŒã€‚è¿™æ—¶å€™è¿™ä¸¤ä¸ªVNodeåˆ™ç®—sameVnodeï¼Œå¯ä»¥ç›´æ¥è¿›è¡ŒpatchVnodeæ“ä½œã€‚</p>
<h2 id="5-patchvnode">5. patchVnode</h2>
<p>è¿˜æ˜¯å…ˆæ¥çœ‹ä¸€ä¸‹patchVnodeçš„ä»£ç ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>  <span style="color:#6272a4">/*patch VNodeèŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  <span style="color:#8be9fd;font-style:italic">function</span> patchVnode (oldVnode, vnode, insertedVnodeQueue, removeOnly) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#6272a4">/*ä¸¤ä¸ªVNodeèŠ‚ç‚¹ç›¸åŒåˆ™ç›´æ¥è¿”å›*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">if</span> (oldVnode <span style="color:#ff79c6">===</span> vnode) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>      <span style="color:#ff79c6">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#6272a4">// reuse element for static trees.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// note we only do this if the vnode is cloned -
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// if the new node is not cloned it means the render functions have been
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// reset by the hot-reload-api and we need to do a proper re-render.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4">      å¦‚æœæ–°æ—§VNodeéƒ½æ˜¯é™æ€çš„ï¼ŒåŒæ—¶å®ƒä»¬çš„keyç›¸åŒï¼ˆä»£è¡¨åŒä¸€èŠ‚ç‚¹ï¼‰ï¼Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4">      å¹¶ä¸”æ–°çš„VNodeæ˜¯cloneæˆ–è€…æ˜¯æ ‡è®°äº†onceï¼ˆæ ‡è®°v-onceå±æ€§ï¼Œåªæ¸²æŸ“ä¸€æ¬¡ï¼‰ï¼Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4">      é‚£ä¹ˆåªéœ€è¦æ›¿æ¢elmä»¥åŠcomponentInstanceå³å¯ã€‚
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#6272a4">    */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#ff79c6">if</span> (isTrue(vnode.isStatic) <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        isTrue(oldVnode.isStatic) <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        vnode.key <span style="color:#ff79c6">===</span> oldVnode.key <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        (isTrue(vnode.isCloned) <span style="color:#ff79c6">||</span> isTrue(vnode.isOnce))) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>      vnode.elm <span style="color:#ff79c6">=</span> oldVnode.elm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>      vnode.componentInstance <span style="color:#ff79c6">=</span> oldVnode.componentInstance
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>      <span style="color:#ff79c6">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#8be9fd;font-style:italic">let</span> i
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#ff79c6">const</span> data <span style="color:#ff79c6">=</span> vnode.data
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#ff79c6">if</span> (isDef(data) <span style="color:#ff79c6">&amp;&amp;</span> isDef(i <span style="color:#ff79c6">=</span> data.hook) <span style="color:#ff79c6">&amp;&amp;</span> isDef(i <span style="color:#ff79c6">=</span> i.prepatch)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>      <span style="color:#6272a4">/*i = data.hook.prepatchï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œè§&#34;./create-component componentVNodeHooks&#34;ã€‚*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>      i(oldVnode, vnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    <span style="color:#ff79c6">const</span> elm <span style="color:#ff79c6">=</span> vnode.elm <span style="color:#ff79c6">=</span> oldVnode.elm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    <span style="color:#ff79c6">const</span> oldCh <span style="color:#ff79c6">=</span> oldVnode.children
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    <span style="color:#ff79c6">const</span> ch <span style="color:#ff79c6">=</span> vnode.children
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    <span style="color:#ff79c6">if</span> (isDef(data) <span style="color:#ff79c6">&amp;&amp;</span> isPatchable(vnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>      <span style="color:#6272a4">/*è°ƒç”¨updateå›è°ƒä»¥åŠupdateé’©å­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>      <span style="color:#ff79c6">for</span> (i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> cbs.update.length; <span style="color:#ff79c6">++</span>i) cbs.update[i](oldVnode, vnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>      <span style="color:#ff79c6">if</span> (isDef(i <span style="color:#ff79c6">=</span> data.hook) <span style="color:#ff79c6">&amp;&amp;</span> isDef(i <span style="color:#ff79c6">=</span> i.update)) i(oldVnode, vnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>    <span style="color:#6272a4">/*å¦‚æœè¿™ä¸ªVNodeèŠ‚ç‚¹æ²¡æœ‰textæ–‡æœ¬æ—¶*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    <span style="color:#ff79c6">if</span> (isUndef(vnode.text)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>      <span style="color:#ff79c6">if</span> (isDef(oldCh) <span style="color:#ff79c6">&amp;&amp;</span> isDef(ch)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>        <span style="color:#6272a4">/*æ–°è€èŠ‚ç‚¹å‡æœ‰childrenå­èŠ‚ç‚¹ï¼Œåˆ™å¯¹å­èŠ‚ç‚¹è¿›è¡Œdiffæ“ä½œï¼Œè°ƒç”¨updateChildren*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>        <span style="color:#ff79c6">if</span> (oldCh <span style="color:#ff79c6">!==</span> ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isDef(ch)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>        <span style="color:#6272a4">/*å¦‚æœè€èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹è€Œæ–°èŠ‚ç‚¹å­˜åœ¨å­èŠ‚ç‚¹ï¼Œå…ˆæ¸…ç©ºelmçš„æ–‡æœ¬å†…å®¹ï¼Œç„¶åä¸ºå½“å‰èŠ‚ç‚¹åŠ å…¥å­èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>        <span style="color:#ff79c6">if</span> (isDef(oldVnode.text)) nodeOps.setTextContent(elm, <span style="color:#f1fa8c">&#39;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>        addVnodes(elm, <span style="color:#ff79c6">null</span>, ch, <span style="color:#bd93f9">0</span>, ch.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>, insertedVnodeQueue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isDef(oldCh)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>        <span style="color:#6272a4">/*å½“æ–°èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹è€Œè€èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåˆ™ç§»é™¤æ‰€æœ‰eleçš„å­èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>        removeVnodes(elm, oldCh, <span style="color:#bd93f9">0</span>, oldCh.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isDef(oldVnode.text)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>        <span style="color:#6272a4">/*å½“æ–°è€èŠ‚ç‚¹éƒ½æ— å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåªæ˜¯æ–‡æœ¬çš„æ›¿æ¢ï¼Œå› ä¸ºè¿™ä¸ªé€»è¾‘ä¸­æ–°èŠ‚ç‚¹textä¸å­˜åœ¨ï¼Œæ‰€ä»¥ç›´æ¥å»é™¤eleçš„æ–‡æœ¬*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>        nodeOps.setTextContent(elm, <span style="color:#f1fa8c">&#39;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>    } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (oldVnode.text <span style="color:#ff79c6">!==</span> vnode.text) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>      <span style="color:#6272a4">/*å½“æ–°è€èŠ‚ç‚¹textä¸ä¸€æ ·æ—¶ï¼Œç›´æ¥æ›¿æ¢è¿™æ®µæ–‡æœ¬*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>      nodeOps.setTextContent(elm, vnode.text)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>    <span style="color:#6272a4">/*è°ƒç”¨postpatché’©å­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>    <span style="color:#ff79c6">if</span> (isDef(data)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>      <span style="color:#ff79c6">if</span> (isDef(i <span style="color:#ff79c6">=</span> data.hook) <span style="color:#ff79c6">&amp;&amp;</span> isDef(i <span style="color:#ff79c6">=</span> i.postpatch)) i(oldVnode, vnode)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>  }
</code></pre></div><p>patchVnodeçš„è§„åˆ™æ˜¯è¿™æ ·çš„ï¼š</p>
<p>1.å¦‚æœæ–°æ—§VNodeéƒ½æ˜¯é™æ€çš„ï¼ŒåŒæ—¶å®ƒä»¬çš„keyç›¸åŒï¼ˆä»£è¡¨åŒä¸€èŠ‚ç‚¹ï¼‰ï¼Œå¹¶ä¸”æ–°çš„VNodeæ˜¯cloneæˆ–è€…æ˜¯æ ‡è®°äº†onceï¼ˆæ ‡è®°v-onceå±æ€§ï¼Œåªæ¸²æŸ“ä¸€æ¬¡ï¼‰ï¼Œé‚£ä¹ˆåªéœ€è¦æ›¿æ¢elmä»¥åŠcomponentInstanceå³å¯ã€‚</p>
<p>2.æ–°è€èŠ‚ç‚¹å‡æœ‰childrenå­èŠ‚ç‚¹ï¼Œåˆ™å¯¹å­èŠ‚ç‚¹è¿›è¡Œdiffæ“ä½œï¼Œè°ƒç”¨updateChildrenï¼Œè¿™ä¸ªupdateChildrenä¹Ÿæ˜¯diffçš„æ ¸å¿ƒã€‚</p>
<p>3.å¦‚æœè€èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹è€Œæ–°èŠ‚ç‚¹å­˜åœ¨å­èŠ‚ç‚¹ï¼Œå…ˆæ¸…ç©ºè€èŠ‚ç‚¹DOMçš„æ–‡æœ¬å†…å®¹ï¼Œç„¶åä¸ºå½“å‰DOMèŠ‚ç‚¹åŠ å…¥å­èŠ‚ç‚¹ã€‚</p>
<p>4.å½“æ–°èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹è€Œè€èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåˆ™ç§»é™¤è¯¥DOMèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ã€‚</p>
<p>5.å½“æ–°è€èŠ‚ç‚¹éƒ½æ— å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåªæ˜¯æ–‡æœ¬çš„æ›¿æ¢ã€‚</p>
<h2 id="6-updatechildren">6. updateChildren</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>  <span style="color:#8be9fd;font-style:italic">function</span> updateChildren (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#8be9fd;font-style:italic">let</span> oldStartIdx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#8be9fd;font-style:italic">let</span> newStartIdx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd;font-style:italic">let</span> oldEndIdx <span style="color:#ff79c6">=</span> oldCh.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#8be9fd;font-style:italic">let</span> oldStartVnode <span style="color:#ff79c6">=</span> oldCh[<span style="color:#bd93f9">0</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#8be9fd;font-style:italic">let</span> oldEndVnode <span style="color:#ff79c6">=</span> oldCh[oldEndIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#8be9fd;font-style:italic">let</span> newEndIdx <span style="color:#ff79c6">=</span> newCh.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#8be9fd;font-style:italic">let</span> newStartVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#bd93f9">0</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#8be9fd;font-style:italic">let</span> newEndVnode <span style="color:#ff79c6">=</span> newCh[newEndIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#8be9fd;font-style:italic">let</span> oldKeyToIdx, idxInOld, elmToMove, refElm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#6272a4">// removeOnly is a special flag used only by &lt;transition-group&gt;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// to ensure removed elements stay in correct relative positions
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// during leaving transitions
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> canMove <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">!</span>removeOnly
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#ff79c6">while</span> (oldStartIdx <span style="color:#ff79c6">&lt;=</span> oldEndIdx <span style="color:#ff79c6">&amp;&amp;</span> newStartIdx <span style="color:#ff79c6">&lt;=</span> newEndIdx) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      <span style="color:#ff79c6">if</span> (isUndef(oldStartVnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        oldStartVnode <span style="color:#ff79c6">=</span> oldCh[<span style="color:#ff79c6">++</span>oldStartIdx] <span style="color:#6272a4">// Vnode has been moved left
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#6272a4"></span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isUndef(oldEndVnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        oldEndVnode <span style="color:#ff79c6">=</span> oldCh[<span style="color:#ff79c6">--</span>oldEndIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (sameVnode(oldStartVnode, newStartVnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#6272a4">/*å‰å››ç§æƒ…å†µå…¶å®æ˜¯æŒ‡å®škeyçš„æ—¶å€™ï¼Œåˆ¤å®šä¸ºåŒä¸€ä¸ªVNodeï¼Œåˆ™ç›´æ¥patchVnodeå³å¯ï¼Œåˆ†åˆ«æ¯”è¾ƒoldChä»¥åŠnewChçš„ä¸¤å¤´èŠ‚ç‚¹2*2=4ç§æƒ…å†µ*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        oldStartVnode <span style="color:#ff79c6">=</span> oldCh[<span style="color:#ff79c6">++</span>oldStartIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        newStartVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#ff79c6">++</span>newStartIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (sameVnode(oldEndVnode, newEndVnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>        patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        oldEndVnode <span style="color:#ff79c6">=</span> oldCh[<span style="color:#ff79c6">--</span>oldEndIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>        newEndVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#ff79c6">--</span>newEndIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (sameVnode(oldStartVnode, newEndVnode)) { <span style="color:#6272a4">// Vnode moved right
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#6272a4"></span>        patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        canMove <span style="color:#ff79c6">&amp;&amp;</span> nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>        oldStartVnode <span style="color:#ff79c6">=</span> oldCh[<span style="color:#ff79c6">++</span>oldStartIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        newEndVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#ff79c6">--</span>newEndIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (sameVnode(oldEndVnode, newStartVnode)) { <span style="color:#6272a4">// Vnode moved left
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span style="color:#6272a4"></span>        patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>        canMove <span style="color:#ff79c6">&amp;&amp;</span> nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>        oldEndVnode <span style="color:#ff79c6">=</span> oldCh[<span style="color:#ff79c6">--</span>oldEndIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>        newStartVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#ff79c6">++</span>newStartIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>      } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>        <span style="color:#6272a4">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#6272a4">          ç”Ÿæˆä¸€ä¸ªkeyä¸æ—§VNodeçš„keyå¯¹åº”çš„å“ˆå¸Œè¡¨ï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡è¿›æ¥undefinedçš„æ—¶å€™ä¼šç”Ÿæˆï¼Œä¹Ÿä¸ºåé¢æ£€æµ‹é‡å¤çš„keyå€¼åšé“ºå«ï¼‰
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#6272a4">          æ¯”å¦‚childreæ˜¯è¿™æ ·çš„ [{xx: xx, key: &#39;key0&#39;}, {xx: xx, key: &#39;key1&#39;}, {xx: xx, key: &#39;key2&#39;}]  beginIdx = 0   endIdx = 2  
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span style="color:#6272a4">          ç»“æœç”Ÿæˆ{key0: 0, key1: 1, key2: 2}
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#6272a4">        */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>        <span style="color:#ff79c6">if</span> (isUndef(oldKeyToIdx)) oldKeyToIdx <span style="color:#ff79c6">=</span> createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>        <span style="color:#6272a4">/*å¦‚æœnewStartVnodeæ–°çš„VNodeèŠ‚ç‚¹å­˜åœ¨keyå¹¶ä¸”è¿™ä¸ªkeyåœ¨oldVnodeä¸­èƒ½æ‰¾åˆ°åˆ™è¿”å›è¿™ä¸ªèŠ‚ç‚¹çš„idxInOldï¼ˆå³ç¬¬å‡ ä¸ªèŠ‚ç‚¹ï¼Œä¸‹æ ‡ï¼‰*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>        idxInOld <span style="color:#ff79c6">=</span> isDef(newStartVnode.key) <span style="color:#ff79c6">?</span> oldKeyToIdx[newStartVnode.key] <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>        <span style="color:#ff79c6">if</span> (isUndef(idxInOld)) { <span style="color:#6272a4">// New element
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#6272a4"></span>          <span style="color:#6272a4">/*newStartVnodeæ²¡æœ‰keyæˆ–è€…æ˜¯è¯¥keyæ²¡æœ‰åœ¨è€èŠ‚ç‚¹ä¸­æ‰¾åˆ°åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>          newStartVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#ff79c6">++</span>newStartIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>        } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>          <span style="color:#6272a4">/*è·å–åŒkeyçš„è€èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>          elmToMove <span style="color:#ff79c6">=</span> oldCh[idxInOld]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>          <span style="color:#6272a4">/* istanbul ignore if */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>          <span style="color:#ff79c6">if</span> (process.env.NODE_ENV <span style="color:#ff79c6">!==</span> <span style="color:#f1fa8c">&#39;production&#39;</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span>elmToMove) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>            <span style="color:#6272a4">/*å¦‚æœelmToMoveä¸å­˜åœ¨è¯´æ˜ä¹‹å‰å·²ç»æœ‰æ–°èŠ‚ç‚¹æ”¾å…¥è¿‡è¿™ä¸ªkeyçš„DOMä¸­ï¼Œæç¤ºå¯èƒ½å­˜åœ¨é‡å¤çš„keyï¼Œç¡®ä¿v-forçš„æ—¶å€™itemæœ‰å”¯ä¸€çš„keyå€¼*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>            warn(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>              <span style="color:#f1fa8c">&#39;It seems there are duplicate keys that is causing an update error. &#39;</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>              <span style="color:#f1fa8c">&#39;Make sure each v-for item has a unique key.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>            )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>          <span style="color:#ff79c6">if</span> (sameVnode(elmToMove, newStartVnode)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>            <span style="color:#6272a4">/*å¦‚æœæ–°VNodeä¸å¾—åˆ°çš„æœ‰ç›¸åŒkeyçš„èŠ‚ç‚¹æ˜¯åŒä¸€ä¸ªVNodeåˆ™è¿›è¡ŒpatchVnode*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>            patchVnode(elmToMove, newStartVnode, insertedVnodeQueue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>            <span style="color:#6272a4">/*å› ä¸ºå·²ç»patchVnodeè¿›å»äº†ï¼Œæ‰€ä»¥å°†è¿™ä¸ªè€èŠ‚ç‚¹èµ‹å€¼undefinedï¼Œä¹‹åå¦‚æœè¿˜æœ‰æ–°èŠ‚ç‚¹ä¸è¯¥èŠ‚ç‚¹keyç›¸åŒå¯ä»¥æ£€æµ‹å‡ºæ¥æç¤ºå·²æœ‰é‡å¤çš„key*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>            oldCh[idxInOld] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">undefined</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>            <span style="color:#6272a4">/*å½“æœ‰æ ‡è¯†ä½canMoveå®å¯ä»¥ç›´æ¥æ’å…¥oldStartVnodeå¯¹åº”çš„çœŸå®DOMèŠ‚ç‚¹å‰é¢*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>            canMove <span style="color:#ff79c6">&amp;&amp;</span> nodeOps.insertBefore(parentElm, newStartVnode.elm, oldStartVnode.elm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>            newStartVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#ff79c6">++</span>newStartIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>          } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>            <span style="color:#6272a4">// same key but different element. treat as new element
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">/*å½“æ–°çš„VNodeä¸æ‰¾åˆ°çš„åŒæ ·keyçš„VNodeä¸æ˜¯sameVNodeçš„æ—¶å€™ï¼ˆæ¯”å¦‚è¯´tagä¸ä¸€æ ·æˆ–è€…æ˜¯æœ‰ä¸ä¸€æ ·typeçš„inputæ ‡ç­¾ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>            createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>            newStartVnode <span style="color:#ff79c6">=</span> newCh[<span style="color:#ff79c6">++</span>newStartIdx]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82</span>    <span style="color:#ff79c6">if</span> (oldStartIdx <span style="color:#ff79c6">&gt;</span> oldEndIdx) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83</span>      <span style="color:#6272a4">/*å…¨éƒ¨æ¯”è¾ƒå®Œæˆä»¥åï¼Œå‘ç°oldStartIdx &gt; oldEndIdxçš„è¯ï¼Œè¯´æ˜è€èŠ‚ç‚¹å·²ç»éå†å®Œäº†ï¼Œæ–°èŠ‚ç‚¹æ¯”è€èŠ‚ç‚¹å¤šï¼Œæ‰€ä»¥è¿™æ—¶å€™å¤šå‡ºæ¥çš„æ–°èŠ‚ç‚¹éœ€è¦ä¸€ä¸ªä¸€ä¸ªåˆ›å»ºå‡ºæ¥åŠ å…¥åˆ°çœŸå®DOMä¸­*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84</span>      refElm <span style="color:#ff79c6">=</span> isUndef(newCh[newEndIdx <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>]) <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">:</span> newCh[newEndIdx <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>].elm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85</span>      addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86</span>    } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (newStartIdx <span style="color:#ff79c6">&gt;</span> newEndIdx) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87</span>      <span style="color:#6272a4">/*å¦‚æœå…¨éƒ¨æ¯”è¾ƒå®Œæˆä»¥åå‘ç°newStartIdx &gt; newEndIdxï¼Œåˆ™è¯´æ˜æ–°èŠ‚ç‚¹å·²ç»éå†å®Œäº†ï¼Œè€èŠ‚ç‚¹å¤šä½™æ–°èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å°†å¤šä½™çš„è€èŠ‚ç‚¹ä»çœŸå®DOMä¸­ç§»é™¤*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88</span>      removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90</span>  }
</code></pre></div><p>ç›´æ¥çœ‹æºç å¯èƒ½æ¯”è¾ƒéš¾ä»¥æ‹æ¸…å…¶ä¸­çš„å…³ç³»ï¼Œæˆ‘ä»¬é€šè¿‡å›¾æ¥çœ‹ä¸€ä¸‹ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/188d83e446bc03254b29bb0b270d2b6b.png" alt="img"></p>
<p>é¦–å…ˆï¼Œåœ¨æ–°è€ä¸¤ä¸ªVNodeèŠ‚ç‚¹çš„å·¦å³å¤´å°¾ä¸¤ä¾§éƒ½æœ‰ä¸€ä¸ªå˜é‡æ ‡è®°ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­è¿™å‡ ä¸ªå˜é‡éƒ½ä¼šå‘ä¸­é—´é æ‹¢ã€‚å½“oldStartIdx &lt;= oldEndIdxæˆ–è€…newStartIdx &lt;= newEndIdxæ—¶ç»“æŸå¾ªç¯ã€‚</p>
<p>ç´¢å¼•ä¸VNodeèŠ‚ç‚¹çš„å¯¹åº”å…³ç³»ï¼š
oldStartIdx =&gt; oldStartVnode
oldEndIdx =&gt; oldEndVnode
newStartIdx =&gt; newStartVnode
newEndIdx =&gt; newEndVnode</p>
<p>åœ¨éå†ä¸­ï¼Œå¦‚æœå­˜åœ¨keyï¼Œå¹¶ä¸”æ»¡è¶³sameVnodeï¼Œä¼šå°†è¯¥DOMèŠ‚ç‚¹è¿›è¡Œå¤ç”¨ï¼Œå¦åˆ™åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹ã€‚</p>
<p>é¦–å…ˆï¼ŒoldStartVnodeã€oldEndVnodeä¸newStartVnodeã€newEndVnodeä¸¤ä¸¤æ¯”è¾ƒä¸€å…±æœ‰2*2=4ç§æ¯”è¾ƒæ–¹æ³•ã€‚</p>
<p>å½“æ–°è€VNodeèŠ‚ç‚¹çš„startæˆ–è€…endæ»¡è¶³sameVnodeæ—¶ï¼Œä¹Ÿå°±æ˜¯sameVnode(oldStartVnode, newStartVnode)æˆ–è€…sameVnode(oldEndVnode, newEndVnode)ï¼Œç›´æ¥å°†è¯¥VNodeèŠ‚ç‚¹è¿›è¡ŒpatchVnodeå³å¯ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/3869f4b9618807f6aed3f86be8d3f4e0.png" alt="img"></p>
<p>å¦‚æœoldStartVnodeä¸newEndVnodeæ»¡è¶³sameVnodeï¼Œå³sameVnode(oldStartVnode, newEndVnode)ã€‚</p>
<p>è¿™æ—¶å€™è¯´æ˜oldStartVnodeå·²ç»è·‘åˆ°äº†oldEndVnodeåé¢å»äº†ï¼Œè¿›è¡ŒpatchVnodeçš„åŒæ—¶è¿˜éœ€è¦å°†çœŸå®DOMèŠ‚ç‚¹ç§»åŠ¨åˆ°oldEndVnodeçš„åé¢ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/946b676fd6381f038aa7b9aafb3f9645.png" alt="img"></p>
<p>å¦‚æœoldEndVnodeä¸newStartVnodeæ»¡è¶³sameVnodeï¼Œå³sameVnode(oldEndVnode, newStartVnode)ã€‚</p>
<p>è¿™è¯´æ˜oldEndVnodeè·‘åˆ°äº†oldStartVnodeçš„å‰é¢ï¼Œè¿›è¡ŒpatchVnodeçš„åŒæ—¶çœŸå®çš„DOMèŠ‚ç‚¹ç§»åŠ¨åˆ°äº†oldStartVnodeçš„å‰é¢ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/3c4084a19e082136dadde6d8657ced0e.png" alt="img"></p>
<p>å¦‚æœä»¥ä¸Šæƒ…å†µå‡ä¸ç¬¦åˆï¼Œåˆ™é€šè¿‡createKeyToOldIdxä¼šå¾—åˆ°ä¸€ä¸ªoldKeyToIdxï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€ä¸ªkeyä¸ºæ—§çš„VNodeï¼Œvalueä¸ºå¯¹åº”indexåºåˆ—çš„å“ˆå¸Œè¡¨ã€‚ä»è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­å¯ä»¥æ‰¾åˆ°æ˜¯å¦æœ‰ä¸newStartVnodeä¸€è‡´keyçš„æ—§çš„VNodeèŠ‚ç‚¹ï¼Œå¦‚æœåŒæ—¶æ»¡è¶³sameVnodeï¼ŒpatchVnodeçš„åŒæ—¶ä¼šå°†è¿™ä¸ªçœŸå®DOMï¼ˆelmToMoveï¼‰ç§»åŠ¨åˆ°oldStartVnodeå¯¹åº”çš„çœŸå®DOMçš„å‰é¢ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/7c78d8449d4d9c3525d548aa04c16f95.png" alt="img"></p>
<p>å½“ç„¶ä¹Ÿæœ‰å¯èƒ½newStartVnodeåœ¨æ—§çš„VNodeèŠ‚ç‚¹æ‰¾ä¸åˆ°ä¸€è‡´çš„keyï¼Œæˆ–è€…æ˜¯å³ä¾¿keyç›¸åŒå´ä¸æ˜¯sameVnodeï¼Œè¿™ä¸ªæ—¶å€™ä¼šè°ƒç”¨createElmåˆ›å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/49d060d1863619e5efae4e74656c15fd.png" alt="img"></p>
<p>åˆ°è¿™é‡Œå¾ªç¯å·²ç»ç»“æŸäº†ï¼Œé‚£ä¹ˆå‰©ä¸‹æˆ‘ä»¬è¿˜éœ€è¦å¤„ç†å¤šä½™æˆ–è€…ä¸å¤Ÿçš„çœŸå®DOMèŠ‚ç‚¹ã€‚</p>
<p>1.å½“ç»“æŸæ—¶oldStartIdx &gt; oldEndIdxï¼Œè¿™ä¸ªæ—¶å€™è€çš„VNodeèŠ‚ç‚¹å·²ç»éå†å®Œäº†ï¼Œä½†æ˜¯æ–°çš„èŠ‚ç‚¹è¿˜æ²¡æœ‰ã€‚è¯´æ˜äº†æ–°çš„VNodeèŠ‚ç‚¹å®é™…ä¸Šæ¯”è€çš„VNodeèŠ‚ç‚¹å¤šï¼Œä¹Ÿå°±æ˜¯æ¯”çœŸå®DOMå¤šï¼Œéœ€è¦å°†å‰©ä¸‹çš„ï¼ˆä¹Ÿå°±æ˜¯æ–°å¢çš„ï¼‰VNodeèŠ‚ç‚¹æ’å…¥åˆ°çœŸå®DOMèŠ‚ç‚¹ä¸­å»ï¼Œæ­¤æ—¶è°ƒç”¨addVnodesï¼ˆæ‰¹é‡è°ƒç”¨createElmçš„æ¥å£å°†è¿™äº›èŠ‚ç‚¹åŠ å…¥åˆ°çœŸå®DOMä¸­å»ï¼‰ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/f7c9290b5c9912e033372be205004842.png" alt="img"></p>
<p>2ã€‚åŒç†ï¼Œå½“newStartIdx &gt; newEndIdxæ—¶ï¼Œæ–°çš„VNodeèŠ‚ç‚¹å·²ç»éå†å®Œäº†ï¼Œä½†æ˜¯è€çš„èŠ‚ç‚¹è¿˜æœ‰å‰©ä½™ï¼Œè¯´æ˜çœŸå®DOMèŠ‚ç‚¹å¤šä½™äº†ï¼Œéœ€è¦ä»æ–‡æ¡£ä¸­åˆ é™¤ï¼Œè¿™æ—¶å€™è°ƒç”¨removeVnodeså°†è¿™äº›å¤šä½™çš„çœŸå®DOMåˆ é™¤ã€‚</p>
<p><img src="https://images.xiaozhuanlan.com/photo/2017/dfc41a99701946feb12a0f50c88e5381.png" alt="img"></p>
<h2 id="7-domæ“ä½œ">7. DOMæ“ä½œ</h2>
<p>ç”±äºVueä½¿ç”¨äº†è™šæ‹ŸDOMï¼Œæ‰€ä»¥è™šæ‹ŸDOMå¯ä»¥åœ¨ä»»ä½•æ”¯æŒJavaScriptè¯­è¨€çš„å¹³å°ä¸Šæ“ä½œï¼Œè­¬å¦‚è¯´ç›®å‰Vueæ”¯æŒçš„æµè§ˆå™¨å¹³å°æˆ–æ˜¯weexï¼Œåœ¨è™šæ‹ŸDOMçš„å®ç°ä¸Šæ˜¯ä¸€è‡´çš„ã€‚é‚£ä¹ˆæœ€åè™šæ‹ŸDOMå¦‚ä½•æ˜ å°„åˆ°çœŸå®çš„DOMèŠ‚ç‚¹ä¸Šå‘¢ï¼Ÿ</p>
<p>Vueä¸ºå¹³å°åšäº†ä¸€å±‚é€‚é…å±‚ã€‚ä¸åŒå¹³å°ä¹‹é—´é€šè¿‡é€‚é…å±‚å¯¹å¤–æä¾›ç›¸åŒçš„æ¥å£ï¼Œè™šæ‹ŸDOMè¿›è¡Œæ“ä½œçœŸå®DOMèŠ‚ç‚¹çš„æ—¶å€™ï¼Œåªéœ€è¦è°ƒç”¨è¿™äº›é€‚é…å±‚çš„æ¥å£å³å¯ï¼Œè€Œå†…éƒ¨å®ç°åˆ™ä¸éœ€è¦å…³å¿ƒï¼Œå®ƒä¼šæ ¹æ®å¹³å°çš„æ”¹å˜è€Œæ”¹å˜ã€‚</p>
<p>ç°åœ¨åˆå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªæ˜¯å°†è™šæ‹ŸDOMæ˜ å°„æˆäº†çœŸå®çš„DOMã€‚é‚£å¦‚ä½•ç»™è¿™äº›DOMåŠ å…¥attrã€classã€styleç­‰DOMå±æ€§å‘¢ï¼Ÿ</p>
<p>è¿™è¦ä¾èµ–äºè™šæ‹ŸDOMçš„ç”Ÿå‘½é’©å­ã€‚è™šæ‹ŸDOMæä¾›äº†å¦‚ä¸‹çš„é’©å­å‡½æ•°ï¼Œåˆ†åˆ«åœ¨ä¸åŒçš„æ—¶æœŸä¼šè¿›è¡Œè°ƒç”¨ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">const</span> hooks <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#39;create&#39;</span>, <span style="color:#f1fa8c">&#39;activate&#39;</span>, <span style="color:#f1fa8c">&#39;update&#39;</span>, <span style="color:#f1fa8c">&#39;remove&#39;</span>, <span style="color:#f1fa8c">&#39;destroy&#39;</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4">/*æ„å»ºcbså›è°ƒå‡½æ•°ï¼Œwebå¹³å°ä¸Šè§/platforms/web/runtime/modules*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  <span style="color:#ff79c6">for</span> (i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> hooks.length; <span style="color:#ff79c6">++</span>i) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    cbs[hooks[i]] <span style="color:#ff79c6">=</span> []
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#ff79c6">for</span> (j <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; j <span style="color:#ff79c6">&lt;</span> modules.length; <span style="color:#ff79c6">++</span>j) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>      <span style="color:#ff79c6">if</span> (isDef(modules[j][hooks[i]])) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        cbs[hooks[i]].push(modules[j][hooks[i]])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  }
</code></pre></div><p>åŒç†ï¼Œä¹Ÿä¼šæ ¹æ®ä¸åŒå¹³å°æœ‰è‡ªå·±ä¸åŒçš„å®ç°ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥Webå¹³å°ä¸ºä¾‹ã€‚é‡Œé¢æœ‰å¯¹attrã€classã€propsã€eventsã€styleä»¥åŠtransitionï¼ˆè¿‡æ¸¡çŠ¶æ€ï¼‰çš„DOMå±æ€§è¿›è¡Œæ“ä½œã€‚</p>
<p>ä»¥atträ¸ºä¾‹ï¼Œä»£ç å¾ˆç®€å•ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/* @flow */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">import</span> { isIE9 } from <span style="color:#f1fa8c">&#39;core/util/env&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#ff79c6">import</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  extend,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  isDef,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  isUndef
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>} from <span style="color:#f1fa8c">&#39;shared/util&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#ff79c6">import</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  isXlink,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  xlinkNS,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  getXlinkProp,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  isBooleanAttr,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  isEnumeratedAttr,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  isFalsyAttrValue
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>} from <span style="color:#f1fa8c">&#39;web/util/index&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#6272a4">/*æ›´æ–°attr*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#8be9fd;font-style:italic">function</span> updateAttrs (oldVnode<span style="color:#ff79c6">:</span> VNodeWithData, vnode<span style="color:#ff79c6">:</span> VNodeWithData) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  <span style="color:#6272a4">/*å¦‚æœæ—§çš„ä»¥åŠæ–°çš„VNodeèŠ‚ç‚¹å‡æ²¡æœ‰attrå±æ€§ï¼Œåˆ™ç›´æ¥è¿”å›*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  <span style="color:#ff79c6">if</span> (isUndef(oldVnode.data.attrs) <span style="color:#ff79c6">&amp;&amp;</span> isUndef(vnode.data.attrs)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#ff79c6">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  <span style="color:#8be9fd;font-style:italic">let</span> key, cur, old
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  <span style="color:#6272a4">/*VNodeèŠ‚ç‚¹å¯¹åº”çš„Domå®ä¾‹*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  <span style="color:#ff79c6">const</span> elm <span style="color:#ff79c6">=</span> vnode.elm
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  <span style="color:#6272a4">/*æ—§VNodeèŠ‚ç‚¹çš„attr*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  <span style="color:#ff79c6">const</span> oldAttrs <span style="color:#ff79c6">=</span> oldVnode.data.attrs <span style="color:#ff79c6">||</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  <span style="color:#6272a4">/*æ–°VNodeèŠ‚ç‚¹çš„attr*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>  <span style="color:#8be9fd;font-style:italic">let</span> attrs<span style="color:#ff79c6">:</span> any <span style="color:#ff79c6">=</span> vnode.data.attrs <span style="color:#ff79c6">||</span> {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  <span style="color:#6272a4">// clone observed objects, as the user probably wants to mutate it
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">/*å¦‚æœæ–°çš„VNodeçš„attrå·²ç»æœ‰__ob__ï¼ˆä»£è¡¨å·²ç»è¢«Observeå¤„ç†è¿‡äº†ï¼‰ï¼Œ è¿›è¡Œæ·±æ‹·è´*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>  <span style="color:#ff79c6">if</span> (isDef(attrs.__ob__)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>    attrs <span style="color:#ff79c6">=</span> vnode.data.attrs <span style="color:#ff79c6">=</span> extend({}, attrs)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>  <span style="color:#6272a4">/*éå†attrï¼Œä¸ä¸€è‡´åˆ™æ›¿æ¢*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>  <span style="color:#ff79c6">for</span> (key <span style="color:#ff79c6">in</span> attrs) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>    cur <span style="color:#ff79c6">=</span> attrs[key]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>    old <span style="color:#ff79c6">=</span> oldAttrs[key]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>    <span style="color:#ff79c6">if</span> (old <span style="color:#ff79c6">!==</span> cur) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>      setAttr(elm, key, cur)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>  <span style="color:#6272a4">// #4391: in IE9, setting type can reset value for input[type=radio]
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span style="color:#6272a4"></span>  <span style="color:#6272a4">/* istanbul ignore if */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>  <span style="color:#ff79c6">if</span> (isIE9 <span style="color:#ff79c6">&amp;&amp;</span> attrs.value <span style="color:#ff79c6">!==</span> oldAttrs.value) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    setAttr(elm, <span style="color:#f1fa8c">&#39;value&#39;</span>, attrs.value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>  <span style="color:#ff79c6">for</span> (key <span style="color:#ff79c6">in</span> oldAttrs) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>    <span style="color:#ff79c6">if</span> (isUndef(attrs[key])) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>      <span style="color:#ff79c6">if</span> (isXlink(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>        elm.removeAttributeNS(xlinkNS, getXlinkProp(key))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>      } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>isEnumeratedAttr(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>        elm.removeAttribute(key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span><span style="color:#6272a4">/*è®¾ç½®attr*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span><span style="color:#8be9fd;font-style:italic">function</span> setAttr (el<span style="color:#ff79c6">:</span> Element, key<span style="color:#ff79c6">:</span> string, value<span style="color:#ff79c6">:</span> any) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>  <span style="color:#ff79c6">if</span> (isBooleanAttr(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>    <span style="color:#6272a4">// set attribute for blank value
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// e.g. &lt;option disabled&gt;Select one&lt;/option&gt;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (isFalsyAttrValue(value)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>      el.removeAttribute(key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>      el.setAttribute(key, key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>  } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isEnumeratedAttr(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>    el.setAttribute(key, isFalsyAttrValue(value) <span style="color:#ff79c6">||</span> value <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;false&#39;</span> <span style="color:#ff79c6">?</span> <span style="color:#f1fa8c">&#39;false&#39;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;true&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span>  } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isXlink(key)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>    <span style="color:#ff79c6">if</span> (isFalsyAttrValue(value)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>      el.removeAttributeNS(xlinkNS, getXlinkProp(key))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span>      el.setAttributeNS(xlinkNS, key, value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span>  } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82</span>    <span style="color:#ff79c6">if</span> (isFalsyAttrValue(value)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83</span>      el.removeAttribute(key)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85</span>      el.setAttribute(key, value)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90</span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">default</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91</span>  create<span style="color:#ff79c6">:</span> updateAttrs,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92</span>  update<span style="color:#ff79c6">:</span> updateAttrs
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93</span>}
</code></pre></div><p>attråªéœ€è¦åœ¨createä»¥åŠupdateé’©å­è¢«è°ƒç”¨æ—¶æ›´æ–°DOMçš„attrå±æ€§å³å¯ã€‚</p>

      </div>
      <div class="footer">
        <span><a class="category" href="https://tomtomyoung.top/categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a></span>
        <span><a class="tag" href="https://tomtomyoung.top/tags/vue/">vue</a></span>
      </div>
    </div>

    <ul class="menu">
    <li class="menu-item">
        <i class="iconfont icon-top item-btn" id="back_top_btn"></i>
    </li>
    <li class="menu-item">
        <a href="https://tomtomyoung.top/" id="back-btn">
            <i class="iconfont icon-home item-btn"></i>
        </a>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-switch item-btn" id="switch_btn"></i>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-search item-btn" id="search_btn"></i>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/vue-%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81%E8%AF%A6%E8%A7%A3/" data-tooltip="vue æ•°æ®åŠ«æŒè¯¦è§£">
            <i class="iconfont icon-left item-btn"></i>
            
        </a>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/js-array%E8%AF%A6%E8%A7%A3/" data-tooltip="js Arrayè¯¦è§£">
            <i class="iconfont icon-right item-btn"></i>
            
        </a>
    </li>
</ul>

  </div>
</div>

<div class="cover" id="cover">
        <div class="search-container">
    <input type="search" class="docsearch-input search-input" placeholder="æœç´¢å…³é”®è¯" />
    
</div>
    </div>
</body>








<script type="text/javascript" src="https://tomtomyoung.top/js/util.min.js" integrity=""></script>
<script>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
    

    
    
    
    
    
    
    
    
    
</script></html>