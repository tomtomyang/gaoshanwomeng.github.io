<!DOCTYPE html>
<html lang="zh-cn" data-theme="light"><head>
    <meta name="google-site-verification" content="kw1N-Xm6qEr1c9PGuRd0U_T6DXkw_EHsLyz5LpuDDv8" />
    <meta name="msvalidate.01" content="EE98205D30806C22C519683EFC53E9BA" />
    <meta name="baidu-site-verification" content="iPC3wUcQLL" />
    <title>  react Fiberè¯¦è§£ </title>
    <meta charset="utf-8" /><meta name="generator" content="Hugo 0.74.3" /><meta name="viewport" content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1" />
    <meta name="description" itemprop="description"
        content=" react Fiberè¯¦è§£ " />
    <meta name="keywords" itemprop="keywords"
        content=" [react Fiber] " />
    <base href="https://tomtomyoung.top/">
    <link rel="shortcut icon" href="https://tomtomyoung.top/favicons//favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="https://tomtomyoung.top/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://tomtomyoung.top/favicons/favicon-16x16.png">
    <link rel="canonical" href="https://tomtomyoung.top/post/react-fiber%E8%AF%A6%E8%A7%A3/">
    <link rel="manifest" href="https://tomtomyoung.top/manifest.json">
    <link rel="stylesheet" type="text/css" href="https://at.alicdn.com/t/font_2450869_iypnqhtzjei.css">
    
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="https://tomtomyoung.top/css/style.min.css" integrity="" type="text/css">
    
    
    <script type="text/javascript" src="https://tomtomyoung.top/js/docsearch.min.js" integrity=""></script>
</head><body class="animated fadeInDown">
<div class="main"><div class="percentage_container">
    <div class="percentage" id="percentage"></div>
</div><div class="toc sub-container">
    <div class="toc-header">
        <span>ç›®å½•</span>
    </div><ul class="toc-h2"><li>
                <span class="toc-link">1. èƒŒæ™¯</span>
            </li>
            <li>
                <span class="toc-link">2. å°è¯•</span>
            </li>
            <li>
                <span class="toc-link">2. Fiber</span>
            </li>
            
                    <ul class="toc-h3"><li>
                <span class="toc-link">1. ä»€ä¹ˆæ˜¯ Fiber</span>
            </li>
            
                    <ul class="toc-h4"><li>
                <span class="toc-link">1. ä¸€ç§æ‰§è¡Œå•å…ƒ</span>
            </li>
            <li>
                <span class="toc-link">2. ä¸€ç§æ•°æ®ç»“æ„</span>
            </li>
            
                    </ul><li>
                <span class="toc-link">2. Fiber é“¾è¡¨</span>
            </li>
            <li>
                <span class="toc-link">3. Fiber å±æ€§</span>
            </li>
            
                    <ul class="toc-h4"><li>
                <span class="toc-link">1. return</span>
            </li>
            <li>
                <span class="toc-link">2. sibling</span>
            </li>
            <li>
                <span class="toc-link">3. child</span>
            </li>
            </div><div class="single-post container">
    <div class="post">
      <div class="header">
        <span class="title">react Fiberè¯¦è§£</span>
        
        <div class="info">
          <span>ğŸ“… 2021-09-10</span>
          <span>ğŸ‘¦ Tomtom Young</span>
          <span>ğŸ“– 2944å­—</span>
          <span>â± 6åˆ†é’Ÿ</span>
        </div>
        
      </div>
      <div class="content markdown-body">
        <blockquote>
<p>å‚è€ƒï¼š</p>
<p><a href="https://juejin.cn/post/6943896410987659277">èµ°è¿›React Fiberçš„ä¸–ç•Œ</a></p>
<p><a href="https://juejin.cn/post/6844904197008130062">æ‰‹å†™Reactçš„Fiberæ¶æ„ï¼Œæ·±å…¥ç†è§£å…¶åŸç†</a></p>
</blockquote>
<h2 id="1-èƒŒæ™¯">1. èƒŒæ™¯</h2>
<p>åœ¨ä¹‹å‰çš„ã€Šreact react æ—¶é—´åˆ‡ç‰‡ä¸requestIdleCallbackè¯¦è§£ã€‹ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ° React ä¸ºäº†è§£å†³æµè§ˆå™¨æ€§èƒ½ç“¶é¢ˆï¼Œæå‡ºäº†æ—¶é—´åˆ‡ç‰‡çš„æœºåˆ¶ï¼Œå°†å¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå°ä»»åŠ¡åˆ†åˆ«æ‰§è¡Œã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±ä¸å¾—ä¸å†æ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>
<p>éœ€è¦æˆ‘ä»¬åˆ’åˆ†çš„å¤§ä»»åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>å°† VirtualDOM æ ‘è½¬æ¢ä¸ºçœŸå® DOM å¹¶æŒ‚è½½åˆ°å®¹å™¨ä¸Šï¼›</p>
</li>
<li>
<p>æˆ‘ä»¬åº”è¯¥æŒ‰ç…§ä»€ä¹ˆæ ‡å‡†åˆ’åˆ†å°ä»»åŠ¡ï¼Ÿ</p>
<p>å·²ç»æ˜¾è€Œæ˜“è§äº†ï¼ŒæŒ‰ç…§èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªå°ä»»åŠ¡ï¼›</p>
</li>
<li>
<p>æˆ‘ä»¬æŒ‰ç…§ä»€ä¹ˆé¡ºåºæ‰§è¡Œå°ä»»åŠ¡ï¼Ÿ</p>
<p>å¯¹äºæ ‘å½¢ç»“æ„ï¼Œæœ€å¥½çš„é¡ºåºæ˜¯æ·±åº¦ä¼˜å…ˆï¼ŒåŒæ—¶å¿…é¡»æ˜¯éé€’å½’çš„ï¼Œåªæœ‰éé€’å½’æ‰èƒ½æ‹†åˆ†ä»»åŠ¡ï¼›</p>
</li>
<li>
<p>æˆ‘ä»¬å¦‚ä½•ç¡®ä¿æ¯ä¸€ä¸ªå°ä»»åŠ¡éƒ½æŒ‰ç…§æ—¢å®šé¡ºåºæ‰§è¡Œï¼Ÿ</p>
<p>å°†æ ‘å½¢ç»“æ„è½¬æ¢ä¸ºé“¾å¼ç»“æ„ï¼Œå°±å¯ä»¥ä¿è¯é¡ºåºï¼›</p>
</li>
</ol>
<h2 id="2-å°è¯•">2. å°è¯•</h2>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆæŒ‰ç…§ä¸Šé¢å‡ ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œè¯•ç€è‡ªå·±å»æ‹†åˆ†ä¸€ä¸‹æˆ‘ä»¬çš„å¤§ä»»åŠ¡å§ï¼</p>
<p>é¦–å…ˆæ¥çœ‹çœ‹å¤§ä»»åŠ¡æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œè¦ç»“åˆã€Šreact æ‰‹å†™react16.xã€‹çš„ä»£ç æ¥çœ‹ï¼Œæˆ‘ä»¬åœ¨<code>render</code>é‡Œæ‰§è¡Œäº†ä¸€ä¸ªå‡½æ•°<code>createDOM</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">function</span> render(element, container){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>element <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>container){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#8be9fd;font-style:italic">let</span> eleWithDOM <span style="color:#ff79c6">=</span> createDOM(element);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    <span style="color:#6272a4">// console.log(eleWithDOM);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#6272a4"></span>    container.append(eleWithDOM.dom);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>}
</code></pre></div><p><code>createDOM</code>ä¸­ï¼Œé€’å½’çš„å¯¹ element æ ‘è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼Œå¯¹æ¯ä¸ª element èŠ‚ç‚¹æ·»åŠ domå±æ€§ï¼Œå­˜å‚¨å¯¹åº”çš„çœŸå® domï¼Œè¿™å·®ä¸å¤šä¹Ÿæ˜¯ React 15çš„ render æ–¹å¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> createDOM(element){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  <span style="color:#8be9fd;font-style:italic">let</span> eleWithDOM;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  <span style="color:#ff79c6">if</span>(element.type <span style="color:#ff79c6">instanceof</span> <span style="color:#8be9fd;font-style:italic">Function</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd;font-style:italic">let</span> elecConstructor <span style="color:#ff79c6">=</span> element.type;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#8be9fd;font-style:italic">let</span> obj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> elecConstructor();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    eleWithDOM <span style="color:#ff79c6">=</span> createDOM(obj.render());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">typeof</span> element.type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;string&#39;</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#6272a4">// åˆ›å»ºdom
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> dom;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">if</span>(element.type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;TEXT_ELEMENT&#39;</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>      dom <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createTextNode(<span style="color:#f1fa8c">&#39;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>      dom <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createElement(element.type)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#6272a4">// æŒ‚è½½å±æ€§
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>element.props){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      <span style="color:#8be9fd;font-style:italic">Object</span>.keys(element.props).forEach(prop =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        dom[prop] <span style="color:#ff79c6">=</span> element.props[prop];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>      })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#6272a4">// å¤„ç†children
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">let</span> children <span style="color:#ff79c6">=</span> [];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>element.children <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>element.children.length) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>      children <span style="color:#ff79c6">=</span> element.children.map(child =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#8be9fd;font-style:italic">let</span> childEleWithDOM <span style="color:#ff79c6">=</span> createDOM(child);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>dom <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>childEleWithDOM.dom){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>          dom.append(childEleWithDOM.dom);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        <span style="color:#ff79c6">return</span> childEleWithDOM;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>      })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    <span style="color:#6272a4">// å½¢æˆFiber
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#6272a4"></span>    eleWithDOM <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>      ...element,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>      dom,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>      children
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>  <span style="color:#ff79c6">return</span> eleWithDOM;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>}
</code></pre></div><p>å…³äºåˆ‡åˆ†å°ä»»åŠ¡ï¼Œç„¶ååˆ’åˆ†æ—¶é—´åˆ‡ç‰‡å»æ‰§è¡Œï¼Œéœ€è¦ç”¨åˆ°æˆ‘ä»¬åœ¨ã€Šreact æ—¶é—´åˆ‡ç‰‡ä¸requestIdleCallbackè¯¦è§£ã€‹ä¸­ä»‹ç»çš„åŸºç¡€æ¶æ„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">let</span> taskQueue <span style="color:#ff79c6">=</span> [
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  () =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    console.log(<span style="color:#f1fa8c">&#39;task1 start&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    console.log(<span style="color:#f1fa8c">&#39;task1 end&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  () =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    console.log(<span style="color:#f1fa8c">&#39;task2 start&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    console.log(<span style="color:#f1fa8c">&#39;task2 end&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  () =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    console.log(<span style="color:#f1fa8c">&#39;task3 start&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    console.log(<span style="color:#f1fa8c">&#39;task3 end&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#ff79c6">const</span> performUnitWork <span style="color:#ff79c6">=</span> () =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  <span style="color:#6272a4">// å–å‡ºç¬¬ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å¹¶æ‰§è¡Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>  taskQueue.shift()()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#ff79c6">const</span> workloop <span style="color:#ff79c6">=</span> (deadline) =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  console.log(<span style="color:#f1fa8c">`æ­¤å¸§çš„å‰©ä½™æ—¶é—´ä¸º: </span><span style="color:#f1fa8c">${</span>deadline.timeRemaining()<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  <span style="color:#ff79c6">while</span> (deadline.timeRemaining() <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&amp;&amp;</span> taskQueue.length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    performUnitWork()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  <span style="color:#6272a4">// å¦‚æœè¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œç»§ç»­è°ƒç”¨requestIdleCallbackç”³è¯·ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span> (taskQueue.length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    requestIdleCallback(workloop)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>requestIdleCallback(workloop)
</code></pre></div><p>é‡Œé¢çš„<code>performUnitWork</code>å°±æ˜¯å°ä»»åŠ¡ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†<code>createDOM</code>æ‹†è§£ï¼Œç„¶åæŠŠæ¯ä¸ªå°ä»»åŠ¡æ”¾å…¥<code>performUnitWork</code>ä¸­ï¼Œä½†æ˜¯<code>createDOM</code>æ˜¯é€’å½’å®ç°çš„ï¼Œé€’å½’ä¸å—æ§åˆ¶ï¼Œä¸å¯æ‹†åˆ†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦è€ƒè™‘æ ‘çš„æ·±åº¦ä¼˜å…ˆéå†çš„å¦ä¸€ç§æ–¹å¼â€”â€”è¿­ä»£ï¼Œç”¨ä¸€ä¸ªæ ˆæ¥å®ç°æ·±åº¦ä¼˜å…ˆéå†ï¼Œæ¯æ¬¡å‡ºæˆ˜å…¥æ ˆå°±æ˜¯ä¸€ä¸ªå°ä»»åŠ¡ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> handleClassElement(element) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  <span style="color:#ff79c6">if</span>(element.type.__proto__ <span style="color:#ff79c6">==</span> Component){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#8be9fd;font-style:italic">let</span> eleConstructor <span style="color:#ff79c6">=</span> element.type;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd;font-style:italic">let</span> eleObj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> eleConstructor();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">return</span> eleObj.render();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (element.type <span style="color:#ff79c6">instanceof</span> <span style="color:#8be9fd;font-style:italic">Function</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">return</span> element.type();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#ff79c6">return</span> element;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#8be9fd;font-style:italic">function</span> createDOM(element){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#8be9fd;font-style:italic">let</span> dom;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#ff79c6">if</span>(element.type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;TEXT_ELEMENT&#39;</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      dom <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createTextNode(<span style="color:#f1fa8c">&#39;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>      dom <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createElement(element.type)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#6272a4">// æŒ‚è½½å±æ€§
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>element.props){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>      <span style="color:#8be9fd;font-style:italic">Object</span>.keys(element.props).forEach(prop =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        dom[prop] <span style="color:#ff79c6">=</span> element.props[prop];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>      })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#ff79c6">return</span> dom;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#8be9fd;font-style:italic">let</span> taskStack <span style="color:#ff79c6">=</span> [];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#ff79c6">const</span> sleep <span style="color:#ff79c6">=</span> delay =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> start <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">Date</span>.now(); <span style="color:#8be9fd;font-style:italic">Date</span>.now() <span style="color:#ff79c6">-</span> start <span style="color:#ff79c6">&lt;=</span> delay;) {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span style="color:#8be9fd;font-style:italic">function</span> performUnitWork () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  <span style="color:#8be9fd;font-style:italic">let</span> topItem <span style="color:#ff79c6">=</span> taskStack.pop();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>  console.log(<span style="color:#f1fa8c">&#39;æ¸²æŸ“äº†&#39;</span>, topItem);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>  topItem.dom <span style="color:#ff79c6">=</span> createDOM(topItem);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>  topItem.parent.dom.append(topItem.dom);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>  <span style="color:#8be9fd;font-style:italic">let</span> children  <span style="color:#ff79c6">=</span> topItem.children;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>children <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>children.length){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>    children.reverse().forEach((child, index) =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>      taskStack.push({
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>        ...handleClassElement(child), 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>        parent<span style="color:#ff79c6">:</span> topItem, 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>        sibling<span style="color:#ff79c6">:</span> children[index<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">null</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span style="color:#8be9fd;font-style:italic">function</span> workloop (deadline) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>  console.log(<span style="color:#f1fa8c">`æ­¤å¸§çš„å‰©ä½™æ—¶é—´ä¸º: </span><span style="color:#f1fa8c">${</span>deadline.timeRemaining()<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>  <span style="color:#ff79c6">while</span>(deadline.timeRemaining() <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>taskStack.length){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>    performUnitWork();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!</span>taskStack.length) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>    <span style="color:#6272a4">// renderDom();
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span><span style="color:#6272a4"></span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>  <span style="color:#6272a4">// å¦‚æœè¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œç»§ç»­è°ƒç”¨requestIdleCallbackç”³è¯·ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>taskStack.length){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>    requestIdleCallback(workloop)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>requestIdleCallback(workloop);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span><span style="color:#8be9fd;font-style:italic">function</span> render(element, container){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>  <span style="color:#6272a4">// elementçš„æ ¼å¼å‚è§ createElement
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>element <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>container){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>    taskStack.push({
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>      ...handleClassElement(element), 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span>      parent<span style="color:#ff79c6">:</span> { dom<span style="color:#ff79c6">:</span> container }, 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span>      sibling<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84</span><span style="color:#8be9fd;font-style:italic">let</span> ReactDOM <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85</span>  render
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88</span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">default</span> ReactDOM;
</code></pre></div><p>è¿™é‡Œæˆ‘ä»¬å®ç°äº†ï¼Œå°†å¤§ä»»åŠ¡ï¼Œæ‹†åˆ†ä¸ºå°ä»»åŠ¡ï¼Œå¦‚æœæ¯ä¸ªä»»åŠ¡å ç”¨æ—¶é—´å¾ˆé«˜çš„è¯ï¼Œæˆ‘ä»¬çš„é¡µé¢ä¼šè¿™æ ·è¢«æ¸²æŸ“ï¼š</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/Video_2021-09-10_103917.gif" alt=""></p>
<p>æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/image-20210910104408180.png" alt="image-20210910104408180"></p>
<p>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†æ—¶é—´åˆ‡ç‰‡ï¼Œé€šè¿‡ä¸€ä¸ªæ ˆç»“æ„ï¼Œå®ç°äº†éé€’å½’æ·±åº¦ä¼˜å…ˆéå†ï¼ŒåŒæ—¶æˆ‘ä»¬å½¢æˆäº†ä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¯¹æ ‘èŠ‚ç‚¹éå†çš„åŒæ—¶ï¼Œåˆ›å»ºäº† dom ï¼ŒåŒæ—¶ç»™æ¯ä¸ªèŠ‚ç‚¹æ·»åŠ äº† parent ã€sibling å±æ€§ï¼Œè®©èŠ‚ç‚¹å¯ä»¥åŒçº§æŸ¥æ‰¾ï¼Œå‘ä¸ŠæŸ¥æ‰¾ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬ä¸€ç›´åœ¨ element ä¸Šæ“ä½œï¼Œæ„Ÿè§‰å°±å¾ˆéº»çƒ¦ï¼Œè€Œä¸”ä¸æ–¹ä¾¿åç»­çš„æ›´æ–°ç­‰æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥åœ¨å¯¹èŠ‚ç‚¹è¿›è¡Œå¤„ç†æ—¶ï¼Œç”Ÿæˆå¦å¤–ä¸€ç§æ•°æ®æ ¼å¼ï¼Œæƒ³è¦å®ç°è¿™ä»¶äº‹ï¼Œå°±ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“äº†ã€‚</p>
<p>æˆ‘ä»¬å¾ˆéš¾è¿­ä»£çš„æ›´æ”¹æ•°æ®ç»“æ„ï¼Œç»å¯¹æ˜¯æˆ‘ä»¬ç®—æ³•å‡ºç°äº†ä»¥ä¸‹é—®é¢˜ï¼Œé™åˆ¶äº†æˆ‘ä»¬çš„æ“ä½œï¼Œå› æ­¤å¿…é¡»æƒ³ä¸€æƒ³åˆ«çš„åŠæ³•ï¼Œæˆ‘ä»¬å¾—æ¢ä¸€ç§æ€è·¯æ¥å®ç°éé€’å½’æ·±åº¦ä¼˜å…ˆéå†äº†ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#8be9fd;font-style:italic">function</span> handleClassElement(element) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span>  <span style="color:#ff79c6">if</span>(element.type.__proto__ <span style="color:#ff79c6">==</span> Component){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span>    <span style="color:#8be9fd;font-style:italic">let</span> eleConstructor <span style="color:#ff79c6">=</span> element.type;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span>    <span style="color:#8be9fd;font-style:italic">let</span> eleObj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> eleConstructor();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span>    <span style="color:#ff79c6">return</span> eleObj.render();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span>  } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (element.type <span style="color:#ff79c6">instanceof</span> <span style="color:#8be9fd;font-style:italic">Function</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span>    <span style="color:#ff79c6">return</span> element.type();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span>  } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span>    <span style="color:#ff79c6">return</span> element;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span style="color:#8be9fd;font-style:italic">function</span> createDOM(element){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span>    <span style="color:#8be9fd;font-style:italic">let</span> dom;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span>    <span style="color:#ff79c6">if</span>(element.type <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;TEXT_ELEMENT&#39;</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span>      dom <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createTextNode(<span style="color:#f1fa8c">&#39;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span>    } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span>      dom <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createElement(element.type)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span>    <span style="color:#6272a4">// æŒ‚è½½å±æ€§
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>element.props){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span>      <span style="color:#8be9fd;font-style:italic">Object</span>.keys(element.props).forEach(prop =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>        dom[prop] <span style="color:#ff79c6">=</span> element.props[prop];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span>      })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>    <span style="color:#ff79c6">return</span> dom;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span><span style="color:#8be9fd;font-style:italic">let</span> taskStack <span style="color:#ff79c6">=</span> [];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span><span style="color:#ff79c6">const</span> sleep <span style="color:#ff79c6">=</span> delay =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span>  <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> start <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">Date</span>.now(); <span style="color:#8be9fd;font-style:italic">Date</span>.now() <span style="color:#ff79c6">-</span> start <span style="color:#ff79c6">&lt;=</span> delay;) {}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span><span style="color:#8be9fd;font-style:italic">function</span> performUnitWork () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>  <span style="color:#8be9fd;font-style:italic">let</span> topFiber <span style="color:#ff79c6">=</span> taskStack.pop();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>  topFiber.dom <span style="color:#ff79c6">=</span> createDOM(topFiber.element);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span>  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span>  topFiber.parent.dom.append(topFiber.dom);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span>  <span style="color:#8be9fd;font-style:italic">let</span> children <span style="color:#ff79c6">=</span> topFiber.element.children;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>  <span style="color:#6272a4">// sleep(30);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>children <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>children.length){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span>    <span style="color:#8be9fd;font-style:italic">let</span> preFiber <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>    children.reverse().forEach((child, index) =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>      <span style="color:#8be9fd;font-style:italic">let</span> newFiber <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>        element<span style="color:#ff79c6">:</span> handleClassElement(child),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>        parent<span style="color:#ff79c6">:</span> topFiber,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span>        sibling<span style="color:#ff79c6">:</span> preFiber
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>      preFiber <span style="color:#ff79c6">=</span> newFiber;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>      <span style="color:#ff79c6">if</span>(index <span style="color:#ff79c6">==</span> children.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>        topFiber.child <span style="color:#ff79c6">=</span> newFiber;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>      taskStack.push(newFiber);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>    })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>  console.log(<span style="color:#f1fa8c">&#39;æ¸²æŸ“äº†&#39;</span>, topFiber);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span><span style="color:#8be9fd;font-style:italic">function</span> workloop (deadline) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span>  console.log(<span style="color:#f1fa8c">`æ­¤å¸§çš„å‰©ä½™æ—¶é—´ä¸º: </span><span style="color:#f1fa8c">${</span>deadline.timeRemaining()<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span>  <span style="color:#ff79c6">while</span>(deadline.timeRemaining() <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>taskStack.length){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span>    performUnitWork();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!</span>taskStack.length) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>    <span style="color:#6272a4">// renderDom();
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span><span style="color:#6272a4"></span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>  <span style="color:#6272a4">// å¦‚æœè¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œç»§ç»­è°ƒç”¨requestIdleCallbackç”³è¯·ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>taskStack.length){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span>    requestIdleCallback(workloop)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span>requestIdleCallback(workloop);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span style="color:#8be9fd;font-style:italic">function</span> render(element, container){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>  <span style="color:#6272a4">// elementçš„æ ¼å¼å‚è§ createElement
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span>(<span style="color:#ff79c6">!!</span>element <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!!</span>container){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>    taskStack.push({
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>      element<span style="color:#ff79c6">:</span> handleClassElement(element),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>      parent<span style="color:#ff79c6">:</span> { dom<span style="color:#ff79c6">:</span> container },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>      sibling<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span><span style="color:#8be9fd;font-style:italic">let</span> ReactDOM <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>  render
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">default</span> ReactDOM;
</code></pre></div><p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/image-20210910185443282.png" alt="image-20210910185443282"></p>
<p>è¿™æ ·æˆ‘ä»¬åœ¨ä¸æ”¹å˜ element çš„åŒæ—¶ç”Ÿæˆä¸€ä¸²æ–°çš„æ•°æ®ç»“æ„ï¼Œè¿™ç§ç»“æ„å¤§æ¦‚å°±æ˜¯ä¸‹é¢æˆ‘ä»¬è¦è®²çš„ Fiberï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åºŸè¿™ä¹ˆå¤§åŠ›æ°”å»ç”Ÿæˆ Fiber å‘¢ï¼Œå› ä¸ºæœ‰äº† Fiber ä¹‹åï¼Œæˆ‘ä»¬çš„å„ç§æ“ä½œéƒ½å˜å¾—ç®€å•äº†ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å°±ç»´æŠ¤äº†ä¸¤ç§æ•°æ®ç»“æ„ï¼š</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/image-20210910185252174.png" alt="image-20210910185252174"></p>
<h2 id="2-fiber">2. Fiber</h2>
<h3 id="1-ä»€ä¹ˆæ˜¯-fiber">1. ä»€ä¹ˆæ˜¯ Fiber</h3>
<h4 id="1-ä¸€ç§æ‰§è¡Œå•å…ƒ">1. ä¸€ç§æ‰§è¡Œå•å…ƒ</h4>
<p>Fiber å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œreact å°±ä¼šæ£€æŸ¥ç°åœ¨è¿˜å‰©å¤šå°‘æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰æ—¶é—´åˆ™å°†æ§åˆ¶æƒè®©å‡ºå»ã€‚React Fiber ä¸æµè§ˆå™¨çš„æ ¸å¿ƒäº¤äº’æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/78a602cbc87342628ace49abb5d20c39~tplv-k3u1fbpfcp-watermark.awebp" alt="undefined"></p>
<p>Fiber å¯ä»¥è¢«ç†è§£ä¸ºåˆ’åˆ†ä¸€ä¸ªä¸ªæ›´å°çš„æ‰§è¡Œå•å…ƒï¼Œå®ƒæ˜¯æŠŠä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºäº†å¾ˆå¤šä¸ªå°å—ä»»åŠ¡ï¼Œä¸€ä¸ªå°å—ä»»åŠ¡çš„æ‰§è¡Œå¿…é¡»æ˜¯ä¸€æ¬¡å®Œæˆçš„ï¼Œä¸èƒ½å‡ºç°æš‚åœï¼Œä½†æ˜¯ä¸€ä¸ªå°å—ä»»åŠ¡æ‰§è¡Œå®Œåå¯ä»¥ç§»äº¤æ§åˆ¶æƒç»™æµè§ˆå™¨å»å“åº”ç”¨æˆ·ï¼Œä»è€Œä¸ç”¨åƒä¹‹å‰ä¸€æ ·è¦ç­‰é‚£ä¸ªå¤§ä»»åŠ¡ä¸€ç›´æ‰§è¡Œå®Œæˆå†å»å“åº”ç”¨æˆ·ã€‚</p>
<h4 id="2-ä¸€ç§æ•°æ®ç»“æ„">2. ä¸€ç§æ•°æ®ç»“æ„</h4>
<p>Fiber è¿˜å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼ŒReact Fiber å°±æ˜¯é‡‡ç”¨é“¾è¡¨å®ç°çš„ã€‚æ¯ä¸ª Virtual DOM éƒ½å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ª Fiberï¼Œé¦–å…ˆæˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹ Virtual DOM ä¸ Fiber çš„åŒºåˆ«ï¼š</p>
<p>Virtual DOMï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;div&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    props<span style="color:#ff79c6">:</span> { },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    children<span style="color:#ff79c6">:</span> [{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>        ...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>    }]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>}
</code></pre></div><p>Fiberï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    type<span style="color:#ff79c6">:</span> any, <span style="color:#6272a4">// å¯¹äºç±»ç»„ä»¶ï¼Œå®ƒæŒ‡å‘æ„é€ å‡½æ•°ï¼›å¯¹äºDOMå…ƒç´ ï¼Œå®ƒæŒ‡å®šHTML tag
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    key<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">|</span> string, <span style="color:#6272a4">// å”¯ä¸€æ ‡è¯†ç¬¦
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"></span>    stateNode<span style="color:#ff79c6">:</span> any, <span style="color:#6272a4">// ä¿å­˜ç»„ä»¶çš„ç±»å®ä¾‹ã€DOMèŠ‚ç‚¹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>    child<span style="color:#ff79c6">:</span> Fiber <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">null</span>, <span style="color:#6272a4">// å¤§å„¿å­
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    sibling<span style="color:#ff79c6">:</span> Fiber <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">null</span>, <span style="color:#6272a4">// ä¸‹ä¸€ä¸ªå…„å¼Ÿ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">return</span><span style="color:#ff79c6">:</span> Fiber <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">null</span>, <span style="color:#6272a4">// çˆ¶èŠ‚ç‚¹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>    tag<span style="color:#ff79c6">:</span> WorkTag, <span style="color:#6272a4">// å®šä¹‰fiberæ“ä½œçš„ç±»å‹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    nextEffect<span style="color:#ff79c6">:</span> Fiber <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">null</span>, <span style="color:#6272a4">// æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    updateQueue<span style="color:#ff79c6">:</span> mixed, <span style="color:#6272a4">// ç”¨äºçŠ¶æ€æ›´æ–°ï¼Œå›è°ƒå‡½æ•°ï¼ŒDOMæ›´æ–°çš„é˜Ÿåˆ—
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>    memoizedState<span style="color:#ff79c6">:</span> any, <span style="color:#6272a4">// ç”¨äºåˆ›å»ºè¾“å‡ºçš„fiberçŠ¶æ€
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4"></span>    pendingProps<span style="color:#ff79c6">:</span> any, <span style="color:#6272a4">// å·²ä»Reactå…ƒç´ ä¸­çš„æ–°æ•°æ®æ›´æ–°ï¼Œå¹¶ä¸”éœ€è¦åº”ç”¨äºå­ç»„ä»¶æˆ–DOMå…ƒç´ çš„props
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    memoizedProps<span style="color:#ff79c6">:</span> any, <span style="color:#6272a4">// åœ¨å‰ä¸€æ¬¡æ¸²æŸ“æœŸé—´ç”¨äºåˆ›å»ºè¾“å‡ºçš„props   
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>}
</code></pre></div><p>é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ Fiber çš„ return sibling child</p>
<p>çœ‹åˆ°äº†èŠ‚ç‚¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥æ¸…æ¥šçš„ç†è§£ Virtual DOM èŠ‚ç‚¹æ˜¯é¢å‘æ•°æ®çš„ï¼ŒFiber èŠ‚ç‚¹æ˜¯é¢å‘æ“ä½œçš„ã€‚</p>
<h3 id="2-fiber-é“¾è¡¨">2. Fiber é“¾è¡¨</h3>
<p>FiberåŒ…æ‹¬äº† childï¼ˆç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼‰ã€siblingï¼ˆå…„å¼ŸèŠ‚ç‚¹ï¼‰ã€returnï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰ç­‰å±æ€§ï¼Œé€šè¿‡è¿™äº›å±æ€§ï¼Œç¦»æ•£çš„ Fiber èŠ‚ç‚¹ä¸²æˆäº†é“¾è¡¨ç»“æ„ï¼Œæˆ‘ä»¬å†æ¥å¯¹æ¯”ä»¥ä¸‹ Virtual DOM æ ‘ Fiber é“¾è¡¨çš„åŒºåˆ«ï¼š</p>
<p>Virtual DOM æ ‘ï¼š</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/image-20210909112211371.png" alt="image-20210909112211371"></p>
<p>Fiber é“¾è¡¨ï¼š</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/74fe5e7d1dc449568448b462abcbff6e~tplv-k3u1fbpfcp-watermark.awebp" alt="undefined"></p>
<h3 id="3-fiber-å±æ€§">3. Fiber å±æ€§</h3>
<h4 id="1-return">1. return</h4>
<p>æŒ‡å‘çˆ¶ Fiber</p>
<h4 id="2-sibling">2. sibling</h4>
<p>æŒ‡å‘å…„å¼Ÿ Fiber</p>
<h4 id="3-child">3. child</h4>
<p>æŒ‡å‘ç¬¬ä¸€ä¸ªå­ Fiber</p>
<p>æœªå®Œå¾…ç»­</p>

      </div>
      <div class="footer">
        <span><a class="category" href="https://tomtomyoung.top/categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a><a class="category" href="https://tomtomyoung.top/categories/%E7%B2%BE%E9%80%89/">ç²¾é€‰</a></span>
        <span><a class="tag" href="https://tomtomyoung.top/tags/react/">react</a></span>
      </div>
    </div>

    <ul class="menu">
    <li class="menu-item">
        <i class="iconfont icon-top item-btn" id="back_top_btn"></i>
    </li>
    <li class="menu-item">
        <a href="https://tomtomyoung.top/" id="back-btn">
            <i class="iconfont icon-home item-btn"></i>
        </a>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-switch item-btn" id="switch_btn"></i>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-search item-btn" id="search_btn"></i>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/react-%E6%89%8B%E5%86%99react16.x%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93/" data-tooltip="react æ‰‹å†™react16.xç»„ä»¶æ¸²æŸ“">
            <i class="iconfont icon-left item-btn"></i>
            
        </a>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-tcp%E8%AF%A6%E8%A7%A3/" data-tooltip="è®¡ç®—æœºç½‘ç»œ TCPè¯¦è§£">
            <i class="iconfont icon-right item-btn"></i>
            
        </a>
    </li>
</ul>

  </div>
</div>

<div class="cover" id="cover">
        <div class="search-container">
    <input type="search" class="docsearch-input search-input" placeholder="æœç´¢å…³é”®è¯" />
    
</div>
    </div>
</body>






<script type="text/javascript" src="https://tomtomyoung.top/js/util.min.js" integrity=""></script>
<script>
    if('serviceWorker' in navigator) {
    const PREFETCH = true;
    const PREFETCH_LINK_RELS = ['index','next', 'prev', 'prefetch'];
    function prefetchCache() {
        if(navigator.serviceWorker.controller) {
            let links = document.querySelectorAll(
                PREFETCH_LINK_RELS.map((rel) => {
                    return 'link[rel='+rel+']';
                }).join(',')
            );
            if(links.length > 0) {
                Array.from(links)
                    .map((link) => {
                        let href = link.getAttribute('href');
                        navigator.serviceWorker.controller.postMessage({
                            action : 'cache',
                            url : href,
                        });
                    });
            }
        }
    }

    navigator.serviceWorker
        .register('/sw.js', { scope: '/' })
        .then(() => {
            console.log('Service Worker Registered');
        });

    navigator.serviceWorker
        .ready
        .then(() => {
            if(PREFETCH) {
                prefetchCache();
            }
        });
}
</script></html>