<!DOCTYPE html>
<html lang="zh-cn" data-theme="light"><head>
  <meta
    name="google-site-verification"
    content="kw1N-Xm6qEr1c9PGuRd0U_T6DXkw_EHsLyz5LpuDDv8"
  />
  <meta name="msvalidate.01" content="EE98205D30806C22C519683EFC53E9BA" />
  <meta name="baidu-site-verification" content="iPC3wUcQLL" />
  <title> vue æ‰‹å†™æ•°æ®åŒå‘ç»‘å®š</title>
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.74.3" /><meta
    name="viewport"
    content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1"
  />
  <meta
    name="description"
    itemprop="description"
    content=" vue æ‰‹å†™æ•°æ®åŒå‘ç»‘å®š "
  />
  <meta
    name="keywords"
    itemprop="keywords"
    content=" [vue æ•°æ®åŒå‘ç»‘å®š] "
  />
  <base href="https://tomtomyoung.top/" />

  
  <link
    rel="shortcut icon"
    href="https://tomtomyoung.top/favicons//favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://tomtomyoung.top/favicons/favicon-32x32.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://tomtomyoung.top/favicons/favicon-16x16.png"
  />
  

  <link rel="canonical" href="https://tomtomyoung.top/post/vue-%E6%89%8B%E5%86%99%E6%95%B0%E6%8D%AE%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A/" />
  <link
    rel="stylesheet"
    type="text/css"
    href="https://at.alicdn.com/t/font_2450869_iypnqhtzjei.css"
  />
  
  
  
  
  
  
  
  
  
  <link
    rel="stylesheet"
    href="https://tomtomyoung.top/css/style.min.css"
    integrity=""
    type="text/css"
  />
  
  
  <script
    type="text/javascript"
    src="https://tomtomyoung.top/js/docsearch.min.js"
    integrity=""
  ></script>
</head>
<body class="animated fadeInDown">
<div class="main"><div class="percentage_container">
    <div class="percentage" id="percentage"></div>
</div><div class="toc sub-container">
    <div class="toc-header">
        <span>ç›®å½•</span>
    </div><ul class="toc-h2"><li>
                <span class="toc-link">1. åŒå‘ç»‘å®šåŸç†</span>
            </li>
            <li>
                <span class="toc-link">2. MVVM</span>
            </li>
            <li>
                <span class="toc-link">3. Observer</span>
            </li>
            <li>
                <span class="toc-link">4. Dep</span>
            </li>
            <li>
                <span class="toc-link">5. Compile</span>
            </li>
            <li>
                <span class="toc-link">6. Watcher</span>
            </li>
            </div><div class="single-post container">
    <div class="post">
      <div class="header">
        <span class="title">vue æ‰‹å†™æ•°æ®åŒå‘ç»‘å®š</span>
        
        <div class="info">
          <span>ğŸ“… 2021-09-05</span>
          <span>ğŸ‘¦ Tomtom Young</span>
          <span>ğŸ“– 5134å­—</span>
          <span>â± 11åˆ†é’Ÿ</span>
        </div>
        
      </div>
      <div class="content markdown-body">
        <blockquote>
<p>å‚è€ƒï¼š</p>
<p><a href="https://cn.vuejs.org/v2/guide/reactivity.html#%E5%A6%82%E4%BD%95%E8%BF%BD%E8%B8%AA%E5%8F%98%E5%8C%96">Vue.js_æ·±å…¥å“åº”å¼åŸç†</a></p>
<p><a href="https://www.cnblogs.com/demonxian3/p/13546525.html">Vueæºç åˆ†æä¹‹å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆçš„Vue</a></p>
<p><a href="https://github.com/DMQ/mvvm">DMQ/mvvm</a></p>
<p><a href="https://www.cnblogs.com/moon3/p/12200807.html">vueæºç è§£è¯»ï¼ˆä¸€ï¼‰Observer/Dep/Watcheræ˜¯å¦‚ä½•å®ç°æ•°æ®ç»‘å®šçš„</a></p>
<p><a href="https://juejin.cn/post/6844904128028622861">Observerã€Depã€Watcher å‚»å‚»æä¸æ¸…æ¥š</a></p>
</blockquote>
<h2 id="1-åŒå‘ç»‘å®šåŸç†">1. åŒå‘ç»‘å®šåŸç†</h2>
<p>vue.js æ˜¯é‡‡ç”¨æ•°æ®åŠ«æŒ+å‘å¸ƒè®¢é˜…æ¨¡å¼çš„æ–¹å¼ï¼Œé€šè¿‡<code>Object.defineProperty()</code>æ¥åŠ«æŒå„ä¸ªå±æ€§çš„<code>setter</code>ï¼Œ<code>getter</code>ï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒã€‚</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/20190528174339999.png" alt="img"></p>
<p>é‡Œé¢æ¶‰åŠåˆ°ä»¥ä¸‹å…³é”®çš„ç±»å’Œæµç¨‹ï¼Œä¸»è¦æ˜¯ä¸‹é¢è¿™äº›ï¼š</p>
<ol>
<li>MVVMç±»ï¼Œè¿™ä¸ªç±»ä½œä¸ºæ‰€æœ‰çš„å…¥å£ï¼Œåœ¨æ‰§è¡Œ<code>new MVVM()</code>æ—¶ï¼Œä¼šæ„é€ ä¸€ä¸ªMVVMå®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªå®ä¾‹å¯¹è±¡ä¸Šä¼šæœ‰å¾ˆå¤šå±æ€§ï¼Œè€Œè¿™äº›å±æ€§å¹¶ä¸æ˜¯ç›´æ¥æ‹¿åˆ°çš„ï¼Œè€Œæ˜¯é€šè¿‡å¾ˆå¤šæ“ä½œç”Ÿæˆçš„ã€‚è¿™äº›æ“ä½œé‡ŒåŒ…æ‹¬äº†<code>observe</code>ã€<code>compile</code>ç­‰ï¼›</li>
<li>Observerç±»ï¼Œè¿™ä¸ªç±»æ˜¯ç”¨æ¥è§‚å¯Ÿå¯¹è±¡çš„ï¼Œä¸€å®šè¦è®°ä½ï¼Œdataä¸­æœ‰å‡ ä¸ªå¯¹è±¡ï¼Œå°±ä¼šæœ‰å‡ ä¸ªObserverå®ä¾‹ï¼ŒåŒ…æ‹¬dataæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥è‡³å°‘æœ‰ä¸€ä¸ªObserverï¼Œç”¨äºè§‚å¯Ÿå¯¹è±¡ä¸­å±æ€§çš„å˜åŒ–ï¼›</li>
<li>Depç±»ï¼Œè¿™ä¸ªç±»åœ¨è®¢é˜…å‘å¸ƒæ¨¡å¼ä¸­ï¼Œæ‰®æ¼”ç€å‘å¸ƒè€…çš„è§’è‰²ï¼Œè€Œä¸”è¿˜è¦æ¯ä¸ªå¯¹è±¡çš„å±æ€§éƒ½ä¼šç»‘å®šä¸€ä¸ªDepå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè®¢é˜…å‘å¸ƒé’ˆå¯¹çš„æ˜¯å¯¹è±¡çš„æ¯ä¸€ä¸ªå±æ€§ï¼Œå½“å±æ€§çš„è¢«è®¿é—®æ—¶ï¼Œå°±å¾€Depçš„subsæ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå±æ€§åœ¨é¡µé¢ä¸­è¢«ä½¿ç”¨äº†å‡ æ¬¡ï¼Œè¿™ä¸ªçš„å±æ€§çš„Depå®ä¾‹ä¸­ï¼Œå°±ä¼šæœ‰å‡ ä¸ªæ•°æ®å¯¹è±¡ï¼Œè¿™æ˜¯è®¢é˜…ï¼Œåœ¨å¾ˆå¤šåœ°æ–¹å«åšä¾èµ–æ”¶é›†ã€‚è€Œå½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œè¦é€šçŸ¥æ‰€æœ‰é¡µé¢ä¸­ä½¿ç”¨åˆ°è¿™ä¸ªæ•°æ®çš„åœ°æ–¹ï¼Œæ›´æ–°æ–°çš„å€¼ï¼Œè¿™æ˜¯å‘å¸ƒï¼›</li>
<li>Compileç±»ï¼Œå…¶å®è¿™éƒ¨åˆ†ä¸ç®—æ˜¯ç±»ï¼Œè€Œæ˜¯ä¸€ç§æ“ä½œï¼Œæˆ‘ä»¬å†™çš„é¡µé¢è¿›è¡Œç¼–è¯‘ï¼ŒæŠ½å–é‡Œé¢çš„æŒ‡ä»¤å’Œæ•°æ®å¼•ç”¨ï¼Œå˜æˆä¸€ä¸ªä¸ªæ•°æ®å¯¹è±¡ï¼Œä¸ºåç»­çš„æ“ä½œå’Œæ›´æ–°åšå‡†å¤‡ï¼›</li>
<li>Watcherç±»ï¼Œä¸Šé¢æ‰€æŒ‡çš„æ•°æ®å¯¹è±¡ï¼Œå°±æ˜¯Watcherç±»çš„å®ä¾‹ï¼Œé‡Œé¢åŒ…å«ç€æ•°æ®çš„å€¼ï¼Œä»¥åŠæ›´æ–°æ•°æ®çš„æ–¹æ³•ï¼Œä¸Šé¢çš„Depå‘å¸ƒæ—¶ï¼Œå°±æ˜¯è°ƒç”¨é‡Œé¢çš„æ›´æ–°æ–¹æ³•ï¼›</li>
</ol>
<h2 id="2-mvvm">2. MVVM</h2>
<p>MVVMæ„é€ å‡½æ•°ä½œä¸ºå…¥å£ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆæ¥å®ç°å®ƒã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> MVVM(options) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#6272a4">// åœ¨å®ä¾‹å¯¹è±¡ä¸Šä¿å­˜option
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.$options <span style="color:#ff79c6">=</span> options <span style="color:#ff79c6">||</span> {};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#6272a4">// åœ¨å®ä¾‹ä¸Šä¿å­˜data
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// dataä¼šæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯å‡½æ•°è¿”å›ï¼Œä¸€ç§æ˜¯å¯¹è±¡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">var</span> data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>._data <span style="color:#ff79c6">=</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#ff79c6">typeof</span> <span style="color:#ff79c6">this</span>.$options.data <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;function&#39;</span> <span style="color:#ff79c6">?</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            <span style="color:#ff79c6">this</span>.$options.data.call(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#ff79c6">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            <span style="color:#ff79c6">this</span>.$options.data;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#6272a4">// æš‚å­˜å½“å‰å®ä¾‹å¯¹è±¡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#6272a4">// æ•°æ®ä»£ç†
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// å®ç° vm.xxx -&gt; vm._data.xxx
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">Object</span>.keys(data).forEach(key =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        me._proxyData(key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    observe(data, me);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#6272a4">// compileç”¨äºç¼–è¯‘html
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.$compile <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Compile(options.el <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">document</span>.body, me)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>MVVM.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    constructor<span style="color:#ff79c6">:</span> MVVM,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    _proxyData<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(key) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        <span style="color:#8be9fd;font-style:italic">Object</span>.defineProperty(<span style="color:#ff79c6">this</span>, key, {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>            get<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span> () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>._data[key];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>            },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>            set<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span> (newVal) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                <span style="color:#ff79c6">if</span>(newVal <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">this</span>._data[key]){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>                    <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>                } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                    <span style="color:#ff79c6">this</span>._data[key] <span style="color:#ff79c6">=</span> newVal;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>};
</code></pre></div><p>è¿™é‡Œé¢æœ‰å‡ ä¸ªå…³é”®çš„åˆå§‹åŒ–æ“ä½œï¼š</p>
<ol>
<li>
<p>åœ¨å®ä¾‹ä¸ŠæŒ‚è½½dataï¼Œè¿™é‡Œè¿›è¡Œäº†åˆ¤æ–­<code>typeof this.$options.data == 'function'</code>ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å®šä¹‰dataæ—¶ï¼Œä¼šæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>ä¸€ç§æ˜¯å‡½æ•°è¿”å›çš„æ–¹å¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>data<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">return</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        someStr<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;hello MVVM&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        strArr<span style="color:#ff79c6">:</span> [
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            <span style="color:#f1fa8c">&#39;hello str1&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>            <span style="color:#f1fa8c">&#39;hello str2&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            <span style="color:#f1fa8c">&#39;hello str3&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>},
</code></pre></div><p>ä¸€ç§æ˜¯å¯¹è±¡æ–¹å¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>data<span style="color:#ff79c6">:</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    someStr<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;hello MVVM&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>},
</code></pre></div></li>
<li>
<p>è¿›è¡Œäº†ç¬¬ä¸€æ¬¡çš„æ•°æ®ä»£ç†ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šä½¿ç”¨<code>this.XXX</code>çš„æ–¹å¼ä½¿ç”¨æˆ‘ä»¬åœ¨dataä¸­å®šä¹‰çš„æ•°æ®ï¼Œä½†æ˜¯æ•°æ®å®é™…ä¸Šæ˜¯ä¿å­˜åœ¨<code>this._data</code>ä¸­çš„ï¼Œéœ€è¦ä½¿ç”¨<code>this._data.XXX</code>æ‰èƒ½è®¿é—®åˆ°ï¼Œå› æ­¤è¿™ä»£ç†äº†ä¸€å±‚ï¼›</p>
</li>
<li>
<p>è§‚å¯Ÿdataä¸­çš„æ•°æ®ï¼Œè¿›è¡Œæ•°æ®åŠ«æŒï¼Œè¿™ä¸€ç‚¹ä¸»è¦æ˜¯åé¢çš„Observerç±»çš„å·¥ä½œï¼›</p>
</li>
<li>
<p>å¯¹äº<code>el</code>èŠ‚ç‚¹è¿›è¡Œç¼–è¯‘ï¼Œå°†é‡Œé¢å’Œæ•°æ®ç›¸å…³çš„åœ°æ–¹ï¼Œéƒ½ä¸€ä¸€ä¿®æ”¹ä¸ºå¯¹è±¡ï¼Œè¿™ä¸€ç‚¹éƒ½æ˜¯åé¢çš„Compileç±»çš„å·¥ä½œï¼›</p>
</li>
</ol>
<h2 id="3-observer">3. Observer</h2>
<p>åœ¨ç»™å¯¹è±¡ç»‘å®šè§‚å¯Ÿç±»ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿™ä¸ªæ•°æ®ä¸æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‚¯å®šä¸éœ€è¦è¿›è¡Œ<code>new Observer</code>çš„æ“ä½œï¼Œå› æ­¤è¦å®šä¹‰ä¸€ä¸ª<code>observe</code>å‡½æ•°è¿›è¡Œæ•°æ®çš„åˆ¤æ–­ï¼Œå•ç‹¬å°è£…ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿæ–¹ä¾¿äº†é€»è¾‘å¤ç”¨ï¼Œå› ä¸ºæœ‰é€’å½’çš„æ“ä½œï¼Œè¿™æ®µåˆ¤æ–­åœ¨å¾ˆå¤šåœ°æ–¹éƒ½ç”¨åˆ°äº†ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> observe(data, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#6272a4">// å¦‚æœæ˜¯æ˜¯æ•°ç»„çš„è¯ï¼Œç›‘å¬é‡Œé¢çš„æ¯ä¸ªå…ƒç´ 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (data <span style="color:#ff79c6">instanceof</span> <span style="color:#8be9fd;font-style:italic">Array</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        data.forEach(item =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            observe(item, vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    } 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#6272a4">// å¦‚æœæ˜¯å¯¹è±¡çš„è¯ï¼Œç›‘å¬è¿™ä¸ªå¯¹è±¡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> data <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;object&#39;</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Observer(data, vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#6272a4">// å¦‚æœå•¥ä¹Ÿä¸æ˜¯ï¼Œå°±è¿”å› 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>};
</code></pre></div><p>Observerç±»ä½œä¸ºæ•°æ®åŠ«æŒçš„å®ç°ï¼Œæ˜¯Vueæ ¸å¿ƒæ€æƒ³çš„ä½“ç°ï¼Œä¹Ÿæ˜¯å„ä¸ªæ‰‹å†™Vueæ•™ç¨‹æœ€å¤šæåŠçš„ï¼Œè¿™ä¸€éƒ¨åˆ†è™½ç„¶å…³é”®ï¼Œå…¶å®å¹¶ä¸éš¾ç†è§£ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">// Observeråªè´Ÿè´£å¯¹å¯¹ç°è±¡çš„ç›‘å¬ï¼Œæœ‰ä¸€ä¸ªå¯¹è±¡å°±ä¼šæœ‰ä¸€ä¸ªObserver
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">function</span> Observer(data, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    vm._dep <span style="color:#ff79c6">=</span> [];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">this</span>.data <span style="color:#ff79c6">=</span> data;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">this</span>.walk(data, vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>Observer.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    constructor<span style="color:#ff79c6">:</span> Observer,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    walk<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(data, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#6272a4">// å¯¹dataä¸‹é¢çš„æ¯ä¸€ä¸ªå±æ€§éƒ½è¿›è¡ŒåŠ«æŒ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">Object</span>.keys(data).forEach(key =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            me.defineReactive(vm, data, key, data[key]);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    defineReactive<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, data, key, val) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#8be9fd;font-style:italic">var</span> dep <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Dep();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        vm._dep.push(dep);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#6272a4">// å½“å‰å€¼æœ‰å¯èƒ½æ˜¯å¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œç›‘å¬ä¸€ä¸‹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#6272a4"></span>        observe(val);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        <span style="color:#8be9fd;font-style:italic">Object</span>.defineProperty(data, key, {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>            get<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>                <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!!</span>Dep.target) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>                    dep.depend();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>                <span style="color:#ff79c6">return</span> val;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>            },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>            set<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(newVal) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>                <span style="color:#ff79c6">if</span> (newVal <span style="color:#ff79c6">===</span> val) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>                    <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>                } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                    val <span style="color:#ff79c6">=</span> newVal;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>                    <span style="color:#6272a4">// æ–°è®¾ç½®çš„å€¼ä¹Ÿæœ‰å¯èƒ½æ˜¯å¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œç›‘å¬ä¸€ä¸‹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#6272a4"></span>                    observe(newVal);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                    <span style="color:#6272a4">// é€šçŸ¥è®¢é˜…è€…
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#6272a4"></span>                    dep.notify();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>};
</code></pre></div><p>åœ¨Observerä¸­ï¼Œå…¶å®æ²¡æœ‰è¿›è¡Œå¤ªå¤šæ“ä½œï¼Œåªæ˜¯ä½¿ç”¨äº†<code> Object.defineProperty</code>å¯¹å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªå±æ€§è¿›è¡Œæ•°æ®åŠ«æŒï¼Œéœ€è¦é¢å¤–è¯´æ˜çš„æ˜¯é€’å½’æ“ä½œï¼Œå› ä¸ºå¯¹è±¡ä¸­æŸä¸ªå±æ€§å¯¹åº”çš„å€¼è¿˜æœ‰å¯èƒ½æ˜¯å¯¹è±¡ï¼Œè¿˜æœ‰å°±æ˜¯è¿™ä¸ªå±æ€§å¯èƒ½åŸæœ¬ä¸æ˜¯å¯¹è±¡ï¼Œä½†æ˜¯åæ¥è¢«ä¿®æ”¹æˆäº†å¯¹è±¡ï¼Œéƒ½éœ€è¦å†ä½¿ç”¨<code>observe</code>å‡½æ•°è¿›è¡Œè§‚å¯Ÿã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰å¯¹æ•°ç»„è¿›è¡Œå¤„ç†ï¼Œå…³äºæ•°ç»„çš„å¤„ç†å¯ä»¥çœ‹å¦ä¸€ç¯‡æ–‡ç« ã€Švue æ•°æ®åŠ«æŒè¯¦è§£ã€‹ã€‚</p>
<h2 id="4-dep">4. Dep</h2>
<p>ç›¸æ¯”äºObserverï¼Œæˆ‘ä¸ªäººè®¤ä¸ºDepæ‰æ˜¯å®ç°æ•°æ®åŒå‘ç»‘å®šçš„æ ¸å¿ƒï¼Œåªæœ‰ææ¸…æ¥šDepçš„å·¥ä½œæ–¹å¼ï¼Œæ‰èƒ½çœŸæ­£ç†è§£æ•´ä¸ªæµç¨‹ã€‚</p>
<p>éœ€è¦å†æ¬¡æ˜ç¡®çš„æ˜¯ï¼Œæ¯ä¸€ä¸ªå±æ€§ï¼Œéƒ½å¯¹åº”ä¸€ä¸ªDepå®ä¾‹ï¼Œå®ä¾‹ä¸­subsæ•°ç»„ä¸­å­˜æ”¾è¿™ä¸ªå±æ€§åœ¨é¡µé¢ä¸­çš„å¼•ç”¨ã€‚è¦ä»”ç»†åœ°ä½“ä¼šä¾èµ–æ”¶é›†çš„å«ä¹‰ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">var</span> uid <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#8be9fd;font-style:italic">function</span> Dep() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">this</span>.id <span style="color:#ff79c6">=</span> uid<span style="color:#ff79c6">++</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">this</span>.subs <span style="color:#ff79c6">=</span> [];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>Dep.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    addSub<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(sub) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">this</span>.subs.push(sub);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>	<span style="color:#6272a4">// æ·»åŠ ä¾èµ–
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>    depend<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        Dep.target.addDep(<span style="color:#ff79c6">this</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    removeSub<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(sub) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        <span style="color:#8be9fd;font-style:italic">var</span> index <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.subs.indexOf(sub);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#ff79c6">if</span> (index <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#ff79c6">this</span>.subs.splice(index, <span style="color:#bd93f9">1</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#6272a4">// å‘å¸ƒæ–¹æ³•ï¼Œæ‰§è¡Œæ¯ä¸ªä¾èµ–ä¸­çš„æ›´æ–°å‡½æ•°
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#6272a4"></span>    notify<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>        <span style="color:#ff79c6">this</span>.subs.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(sub) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>            sub.update();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#6272a4">// åœ¨Depæ„é€ å‡½æ•°å¯¹è±¡ä¸Šæ·»åŠ ä¸€ä¸ªtargetï¼Œä½œä¸ºæ·»åŠ ä¾èµ–æ—¶çš„å¯¹è±¡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4"></span>Dep.target <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>;
</code></pre></div><p>ç”¨ä¸€ä¸ªå®é™…æƒ…å†µæ¥è¯´æ˜Depçš„å½¢æˆï¼š</p>
<p>é¡µé¢ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>&lt;<span style="color:#ff79c6">input</span> <span style="color:#50fa7b">type</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;text&#34;</span> <span style="color:#50fa7b">v-model</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;someStr&#34;</span>&gt;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>&lt;<span style="color:#ff79c6">p</span>&gt;{{someStr}}&lt;/<span style="color:#ff79c6">p</span>&gt;
</code></pre></div><p>æ•°æ®ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>data<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">return</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        someStr<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;hello MVVM&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        strArr<span style="color:#ff79c6">:</span> [
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            <span style="color:#f1fa8c">&#39;hello str1&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>            <span style="color:#f1fa8c">&#39;hello str2&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            <span style="color:#f1fa8c">&#39;hello str3&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>},
</code></pre></div><p>ä¸Šé¢è¿™ç§æƒ…å†µï¼Œå½¢æˆçš„Depæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/20210905220921.jpg" alt=""></p>
<p>è§£é‡Šä¸€ä¸‹ï¼Œdataä¸­æœ‰ä¸¤ä¸ªæ•°æ®ï¼Œæ‰€ä»¥å½¢æˆäº†ä¸¤ä¸ªDepå®ä¾‹ï¼š</p>
<p>ç¬¬ä¸€ä¸ªDepå®ä¾‹ï¼Œå¯¹åº”ç€<code>someStr</code>ï¼Œsubsé‡Œé¢æœ‰ä¸¤ä¸ªæ•°æ®ä¾èµ–ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨é¡µé¢ä¸­åˆ†åˆ«å†™äº†<code>v-model=&quot;someStr&quot;</code>å’Œ<code>{{someStr}}</code>ã€‚</p>
<p>ç¬¬äºŒä¸ªDepå®ä¾‹ï¼Œå¯¹åº”ç€<code>strArr</code>ï¼Œsubsæ˜¯ç©ºæ•°ç»„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨é¡µé¢ä¸­ä½¿ç”¨è¿™ä¸ªæ•°æ®ã€‚</p>
<h2 id="5-compile">5. Compile</h2>
<p>é€šè¿‡ä¸Šé¢çš„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°subsé‡Œé¢æ”¾çš„æ˜¯Watcherå®ä¾‹ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å…ˆä¸å»ç ”ç©¶Watcherçš„å®ä¾‹æ˜¯ä»€ä¹ˆæ ·å­ï¼ŒåŒ…å«ä»€ä¹ˆï¼Œæˆ‘ä»¬å…ˆå»ç ”ç©¶ï¼Œé¡µé¢ä¸­çš„æ•°æ®æ˜¯æ€ä¹ˆè¢«è½¬æ¢ä¸ºWatcherå¯¹è±¡çš„ï¼Œè¿™ä¸€éƒ¨åˆ†å°±æ˜¯Compileçš„ä¸»è¦å·¥ä½œã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#8be9fd;font-style:italic">function</span> Compile(el, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span>    <span style="color:#ff79c6">this</span>.$vm <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span>    <span style="color:#6272a4">// ä¼ è¿›æ¥çš„el, æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦æ‹¿åˆ°çœŸå®DOMèŠ‚ç‚¹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.$el <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.querySelector(el);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!!</span><span style="color:#ff79c6">this</span>.$el) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span>        <span style="color:#ff79c6">this</span>.$fragment <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.node2Fragment(<span style="color:#ff79c6">this</span>.$el);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span>        <span style="color:#6272a4">// ä»æ ¹èŠ‚ç‚¹èµ–æ—¶ç¼–è¯‘
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">this</span>.compileElement(<span style="color:#ff79c6">this</span>.$fragment);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span>        <span style="color:#ff79c6">this</span>.$el.appendChild(<span style="color:#ff79c6">this</span>.$fragment);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span>Compile.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span>    constructor<span style="color:#ff79c6">:</span> Compile,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span>    <span style="color:#6272a4">// å°†å½“å‰èŠ‚ç‚¹çš„ç‰‡æ®µæå–å‡ºæ¥
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span style="color:#6272a4"></span>    node2Fragment<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(el) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span>        <span style="color:#8be9fd;font-style:italic">var</span> fragment <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createDocumentFragment(),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span>            child;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span>        <span style="color:#6272a4">// å°†åŸç”ŸèŠ‚ç‚¹æ‹·è´åˆ°fragment
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">while</span> (child <span style="color:#ff79c6">=</span> el.firstChild) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>            <span style="color:#6272a4">// console.log(el.childNodes);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span style="color:#6272a4"></span>            fragment.appendChild(child);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>        <span style="color:#ff79c6">return</span> fragment;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>    <span style="color:#6272a4">// ç¼–è¯‘eleèŠ‚ç‚¹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span><span style="color:#6272a4"></span>    compileElement<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(el) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span>        <span style="color:#8be9fd;font-style:italic">var</span> childNodes <span style="color:#ff79c6">=</span> el.childNodes,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span>            me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span>        console.log(<span style="color:#8be9fd;font-style:italic">Array</span>.from(childNodes));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>        <span style="color:#6272a4">// å°†nodeListè½¬æ¢ä¸ºæ•°ç»„ï¼Œè¿›è¡Œéå†
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">Array</span>.from(childNodes).forEach(node =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>            <span style="color:#8be9fd;font-style:italic">var</span> text <span style="color:#ff79c6">=</span> node.textContent;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span>            <span style="color:#8be9fd;font-style:italic">var</span> reg <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">/\{\{(.*)\}\}/</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span>            <span style="color:#6272a4">// å¦‚æœæ˜¯èŠ‚ç‚¹ï¼Œç¼–è¯‘
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (me.isElementNode(node)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span>                me.compile(node);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span>            <span style="color:#6272a4">// å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯textç±»å‹ åŒæ—¶é‡Œé¢çš„textæ˜¯{{}}åŒ…è£¹ï¼Œè¯´æ˜æ˜¯å˜é‡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span><span style="color:#6272a4"></span>            } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (me.isTextNode(node) <span style="color:#ff79c6">&amp;&amp;</span> reg.test(text)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span>                console.log(<span style="color:#f1fa8c">&#39;node&#39;</span>, node, <span style="color:#f1fa8c">&#39;text&#39;</span>, text);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>                me.compileText(node, <span style="color:#8be9fd;font-style:italic">RegExp</span>.$1.trim());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>            <span style="color:#6272a4">// å¦‚æœè¿˜æœ‰å­å…ƒç´ ï¼Œç¼–è¯‘
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (node.childNodes <span style="color:#ff79c6">&amp;&amp;</span> node.childNodes.length) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>                me.compileElement(node);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>    compile<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>        <span style="color:#8be9fd;font-style:italic">var</span> nodeAttrs <span style="color:#ff79c6">=</span> node.attributes,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>            me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>        <span style="color:#8be9fd;font-style:italic">Array</span>.from(nodeAttrs).forEach(attr =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>            <span style="color:#8be9fd;font-style:italic">var</span> attrName <span style="color:#ff79c6">=</span> attr.name;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span>            <span style="color:#6272a4">// å¦‚æœæ˜¯v-æŒ‡ä»¤
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (me.isDirective(attrName)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>                <span style="color:#8be9fd;font-style:italic">var</span> exp <span style="color:#ff79c6">=</span> attr.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span>                <span style="color:#8be9fd;font-style:italic">var</span> dir <span style="color:#ff79c6">=</span> attrName.substring(<span style="color:#bd93f9">2</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span>                <span style="color:#6272a4">// å¦‚æœæ˜¯ç”¨v-onç»‘å®šçš„äº‹ä»¶
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">if</span> (me.isEventDirective(dir)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>                    compileUtil.eventHandler(node, me.$vm, exp, dir);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>                <span style="color:#6272a4">// å¦‚æœæ˜¯å…¶ä»–æŒ‡ä»¤ 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>                    <span style="color:#ff79c6">!!</span>compileUtil[dir] <span style="color:#ff79c6">&amp;&amp;</span> compileUtil[dir](node, me.$vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span>                <span style="color:#6272a4">// åˆ æ‰æŒ‡ä»¤
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span><span style="color:#6272a4"></span>                node.removeAttribute(attrName);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span>    <span style="color:#6272a4">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å˜é‡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span style="color:#6272a4"></span>    compileText<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>        compileUtil.text(node, <span style="color:#ff79c6">this</span>.$vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>    isDirective<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(attr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>        <span style="color:#ff79c6">return</span> attr.indexOf(<span style="color:#f1fa8c">&#39;v-&#39;</span>) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>    isEventDirective<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(dir) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>        <span style="color:#ff79c6">return</span> dir.indexOf(<span style="color:#f1fa8c">&#39;on&#39;</span>) <span style="color:#ff79c6">===</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>    <span style="color:#6272a4">// nodeTypeè¡¨ç¤ºèŠ‚ç‚¹ç±»å‹  1 --&gt;Elementç±»å‹   3 --&gt;Textç±»å‹   9 --&gt;Documentç±»å‹
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span>    isElementNode<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>        <span style="color:#6272a4">// nodeType == 1 è¯´æ˜æ˜¯ä¸€ä¸ªå…ƒç´ èŠ‚ç‚¹ï¼Œæ¯”å¦‚pæˆ–è€…div
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> node.nodeType <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>    isTextNode<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>        <span style="color:#ff79c6">return</span> node.nodeType <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">3</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span><span style="color:#6272a4">// æŒ‡ä»¤å¤„ç†é›†åˆ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">var</span> compileUtil <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span>    <span style="color:#6272a4">// ç»‘å®šå˜é‡
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span><span style="color:#6272a4"></span>    text<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span>        <span style="color:#ff79c6">this</span>.bind(node, vm, exp, <span style="color:#f1fa8c">&#39;text&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span>    model<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span>        <span style="color:#ff79c6">this</span>.bind(node, vm, exp, <span style="color:#f1fa8c">&#39;model&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span>        <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span>            val <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>._getVMVal(vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span>        node.addEventListener(<span style="color:#f1fa8c">&#39;input&#39;</span>, <span style="color:#8be9fd;font-style:italic">function</span>(e) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span>            <span style="color:#8be9fd;font-style:italic">var</span> newValue <span style="color:#ff79c6">=</span> e.target.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span>            <span style="color:#ff79c6">if</span> (val <span style="color:#ff79c6">===</span> newValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span>                <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span>            me._setVMVal(vm, exp, newValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span>            val <span style="color:#ff79c6">=</span> newValue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132</span>    <span style="color:#6272a4">// è½¬æ¢watcher 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133</span><span style="color:#6272a4"></span>    bind<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp, dir) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134</span>        <span style="color:#8be9fd;font-style:italic">var</span> updaterFn <span style="color:#ff79c6">=</span> updater[dir <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;Updater&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136</span>        <span style="color:#6272a4">// å…ˆæ›´æ–°ä¸€æ¬¡å˜é‡å€¼
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137</span><span style="color:#6272a4"></span>        updaterFn <span style="color:#ff79c6">&amp;&amp;</span> updaterFn(node, <span style="color:#ff79c6">this</span>._getVMVal(vm, exp));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139</span>        <span style="color:#6272a4">// ä¼ è¿›å»ä¸‰ä¸ªå‚æ•° vm å˜é‡ æ›´æ–°æ–¹æ³•
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">new</span> Watcher(vm, exp, <span style="color:#8be9fd;font-style:italic">function</span>(value, oldValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141</span>            updaterFn <span style="color:#ff79c6">&amp;&amp;</span> updaterFn(node, value, oldValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145</span>    <span style="color:#6272a4">// äº‹ä»¶å¤„ç†
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146</span><span style="color:#6272a4"></span>    eventHandler<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp, dir) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147</span>        <span style="color:#8be9fd;font-style:italic">var</span> eventType <span style="color:#ff79c6">=</span> dir.split(<span style="color:#f1fa8c">&#39;:&#39;</span>)[<span style="color:#bd93f9">1</span>],
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148</span>            fn <span style="color:#ff79c6">=</span> vm.$options.methods <span style="color:#ff79c6">&amp;&amp;</span> vm.$options.methods[exp];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150</span>        <span style="color:#ff79c6">if</span> (eventType <span style="color:#ff79c6">&amp;&amp;</span> fn) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151</span>            node.addEventListener(eventType, fn.bind(vm), <span style="color:#ff79c6">false</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155</span>    <span style="color:#6272a4">// åœ¨dataä¸­æŸ¥æ‰¾expçš„å€¼
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156</span><span style="color:#6272a4"></span>    _getVMVal<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157</span>        <span style="color:#8be9fd;font-style:italic">var</span> val <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158</span>        exp <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159</span>        <span style="color:#6272a4">// å¾ªç¯æ‰¾åˆ°æœ€åä¸€ä¸ªå€¼
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160</span><span style="color:#6272a4"></span>        exp.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(k) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161</span>            val <span style="color:#ff79c6">=</span> val[k];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163</span>        <span style="color:#ff79c6">return</span> val;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166</span>    _setVMVal<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, exp, value) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167</span>        <span style="color:#8be9fd;font-style:italic">var</span> val <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168</span>        exp <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169</span>        exp.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(k, i) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170</span>            <span style="color:#6272a4">// éæœ€åä¸€ä¸ªkeyï¼Œæ›´æ–°valçš„å€¼
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (i <span style="color:#ff79c6">&lt;</span> exp.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172</span>                val <span style="color:#ff79c6">=</span> val[k];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173</span>            } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174</span>                val[k] <span style="color:#ff79c6">=</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181</span><span style="color:#8be9fd;font-style:italic">var</span> updater <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182</span>    <span style="color:#6272a4">// textèŠ‚ç‚¹æ›´æ–°å‡½æ•°
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183</span><span style="color:#6272a4"></span>    textUpdater<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, value) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184</span>        <span style="color:#6272a4">// ç›´æ¥ä¿®æ”¹textContent
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185</span><span style="color:#6272a4"></span>        node.textContent <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">typeof</span> value <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;undefined&#39;</span> <span style="color:#ff79c6">?</span> <span style="color:#f1fa8c">&#39;&#39;</span> <span style="color:#ff79c6">:</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188</span>    modelUpdater<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, value, oldValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189</span>        node.value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">typeof</span> value <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;undefined&#39;</span> <span style="color:#ff79c6">?</span> <span style="color:#f1fa8c">&#39;&#39;</span> <span style="color:#ff79c6">:</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191</span>};
</code></pre></div><p>Compileçš„ä»£ç é‡æ¯”è¾ƒå¤šï¼Œä½†æ˜¯å¹²çš„äº‹æƒ…å¹¶ä¸å¤æ‚ï¼Œå½’ç»“ä¸‹æ¥ä¸»è¦æœ‰ä¸‹é¢å‡ ä»¶ï¼š</p>
<ol>
<li>è·å–elèŠ‚ç‚¹ï¼Œå¹¶æŠŠelèŠ‚ç‚¹çš„å­èŠ‚ç‚¹éƒ½æ‹¿å‡ºæ¥ï¼ŒæŒ‚è½½åˆ°æ–°åˆ›å»ºçš„<code>documentFragment</code>ä¸Šï¼Œè¿™æ ·åšçš„åŸå› æ˜¯ï¼Œé¿å…ç›´æ¥åœ¨elèŠ‚ç‚¹ä¸Šæ“ä½œï¼Œå¯¼è‡´é¡µé¢é¢‘ç¹çš„æ·»åŠ ä¿®æ”¹èŠ‚ç‚¹ï¼Œè€Œæ˜¯åœ¨<code>documentFragment</code>ä¸Šè¿›è¡Œæ“ä½œï¼Œæ“ä½œå®Œäº†å†ç»Ÿä¸€æŒ‚è½½å›å»ï¼Œä¸€æ¬¡å®Œå·¥ï¼›</li>
<li>å¯¹elèŠ‚ç‚¹ä¸‹é¢çš„å­èŠ‚ç‚¹è¿›è¡Œé€å±‚ç¼–è¯‘ï¼Œè·å–èŠ‚ç‚¹ä¸Šçš„<code>v-</code>æŒ‡ä»¤ï¼Œä»¥åŠæ–‡æœ¬ç±»å‹èŠ‚ç‚¹ä¸­çš„<code>{{}}</code>ï¼›</li>
<li>å¯¹å‘ç°çš„<code>v-</code>æŒ‡ä»¤å’Œ<code>{{}}</code>è¿›è¡Œå¤„ç†ï¼Œåˆ†åˆ«åˆ›å»º<code>Watcher</code>ï¼Œä¿å­˜å¯¹åº”å˜é‡ï¼Œä»¥åŠæ›´æ–°å‡½æ•°ï¼›</li>
</ol>
<p>è¿™é‡Œè¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>v-model</code>çš„å¤„ç†ä¸­ï¼Œä½¿ç”¨äº†<code>addEventListener('input' function(){})</code>ï¼Œæ­£æ˜¯è¿™ä¸€æ­¥ï¼Œå®ç°äº†view -&gt; modelçš„æ•°æ®æµï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span> model<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">this</span>.bind(node, vm, exp, <span style="color:#f1fa8c">&#39;model&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        val <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>._getVMVal(vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    node.addEventListener(<span style="color:#f1fa8c">&#39;input&#39;</span>, <span style="color:#8be9fd;font-style:italic">function</span>(e) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        <span style="color:#8be9fd;font-style:italic">var</span> newValue <span style="color:#ff79c6">=</span> e.target.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#ff79c6">if</span> (val <span style="color:#ff79c6">===</span> newValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        me._setVMVal(vm, exp, newValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        val <span style="color:#ff79c6">=</span> newValue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>},
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>_setVMVal<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, exp, value) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#8be9fd;font-style:italic">var</span> val <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    exp <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    exp.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(k, i) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        <span style="color:#6272a4">// éæœ€åä¸€ä¸ªkeyï¼Œæ›´æ–°valçš„å€¼
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (i <span style="color:#ff79c6">&lt;</span> exp.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            val <span style="color:#ff79c6">=</span> val[k];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            val[k] <span style="color:#ff79c6">=</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>}
</code></pre></div><h2 id="6-watcher">6. Watcher</h2>
<p>ä¸‹é¢å†æ¥çœ‹Watcherï¼Œæ­£æ˜¯WatcheræŠŠCompileå’ŒDepè¿æ¥èµ·æ¥ï¼Œå®ç°äº†model-&gt;viewçš„æ•°æ®æµã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> Watcher(vm, exp, updateFunc) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">this</span>.updateFunc <span style="color:#ff79c6">=</span> updateFunc;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#ff79c6">this</span>.vm <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">this</span>.exp <span style="color:#ff79c6">=</span> exp;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">this</span>.depIds <span style="color:#ff79c6">=</span> {};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">this</span>.getter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.parseGetter(exp.trim());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.get();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>Watcher.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    constructor<span style="color:#ff79c6">:</span> Watcher,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    update<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        <span style="color:#ff79c6">this</span>.run();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    run<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#8be9fd;font-style:italic">var</span> value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.get();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        <span style="color:#8be9fd;font-style:italic">var</span> oldVal <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        <span style="color:#ff79c6">if</span> (value <span style="color:#ff79c6">!==</span> oldVal) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            <span style="color:#ff79c6">this</span>.updateFunc.call(<span style="color:#ff79c6">this</span>.vm, value, oldVal);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    addDep<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(dep) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        <span style="color:#6272a4">// 1. æ¯æ¬¡è°ƒç”¨run()çš„æ—¶å€™ä¼šè§¦å‘ç›¸åº”å±æ€§çš„getter
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// getteré‡Œé¢ä¼šè§¦å‘dep.depend()ï¼Œç»§è€Œè§¦å‘è¿™é‡Œçš„addDep
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        <span style="color:#6272a4">// 2. å‡å¦‚ç›¸åº”å±æ€§çš„dep.idå·²ç»åœ¨å½“å‰watcherçš„depIdsé‡Œï¼Œè¯´æ˜ä¸æ˜¯ä¸€ä¸ªæ–°çš„å±æ€§ï¼Œä»…ä»…æ˜¯æ”¹å˜äº†å…¶å€¼è€Œå·²
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// åˆ™ä¸éœ€è¦å°†å½“å‰watcheræ·»åŠ åˆ°è¯¥å±æ€§çš„depé‡Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        <span style="color:#6272a4">// 3. å‡å¦‚ç›¸åº”å±æ€§æ˜¯æ–°çš„å±æ€§ï¼Œåˆ™å°†å½“å‰watcheræ·»åŠ åˆ°æ–°å±æ€§çš„depé‡Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// å¦‚é€šè¿‡ vm.child = {name: &#39;a&#39;} æ”¹å˜äº† child.name çš„å€¼ï¼Œchild.name å°±æ˜¯ä¸ªæ–°å±æ€§
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// åˆ™éœ€è¦å°†å½“å‰watcher(child.name)åŠ å…¥åˆ°æ–°çš„ child.name çš„depé‡Œ
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// å› ä¸ºæ­¤æ—¶ child.name æ˜¯ä¸ªæ–°å€¼ï¼Œä¹‹å‰çš„ setterã€dep éƒ½å·²ç»å¤±æ•ˆï¼Œå¦‚æœä¸æŠŠ watcher åŠ å…¥åˆ°æ–°çš„ child.name çš„depä¸­
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// é€šè¿‡ child.name = xxx èµ‹å€¼çš„æ—¶å€™ï¼Œå¯¹åº”çš„ watcher å°±æ”¶ä¸åˆ°é€šçŸ¥ï¼Œç­‰äºå¤±æ•ˆäº†
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>        <span style="color:#6272a4">// 4. æ¯ä¸ªå­å±æ€§çš„watcheråœ¨æ·»åŠ åˆ°å­å±æ€§çš„depçš„åŒæ—¶ï¼Œä¹Ÿä¼šæ·»åŠ åˆ°çˆ¶å±æ€§çš„dep
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// ç›‘å¬å­å±æ€§çš„åŒæ—¶ç›‘å¬çˆ¶å±æ€§çš„å˜æ›´ï¼Œè¿™æ ·ï¼Œçˆ¶å±æ€§æ”¹å˜æ—¶ï¼Œå­å±æ€§çš„watcherä¹Ÿèƒ½æ”¶åˆ°é€šçŸ¥è¿›è¡Œupdate
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// è¿™ä¸€æ­¥æ˜¯åœ¨ this.get() --&gt; this.getVMVal() é‡Œé¢å®Œæˆï¼ŒforEachæ—¶ä¼šä»çˆ¶çº§å¼€å§‹å–å€¼ï¼Œé—´æ¥è°ƒç”¨äº†å®ƒçš„getter
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// è§¦å‘äº†addDep(), åœ¨æ•´ä¸ªforEachè¿‡ç¨‹ï¼Œå½“å‰wacheréƒ½ä¼šåŠ å…¥åˆ°æ¯ä¸ªçˆ¶çº§è¿‡ç¨‹å±æ€§çš„dep
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// ä¾‹å¦‚ï¼šå½“å‰watcherçš„æ˜¯&#39;child.child.name&#39;, é‚£ä¹ˆchild, child.child, child.child.nameè¿™ä¸‰ä¸ªå±æ€§çš„depéƒ½ä¼šåŠ å…¥å½“å‰watcher
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.depIds.hasOwnProperty(dep.id)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>            dep.addSub(<span style="color:#ff79c6">this</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>            <span style="color:#ff79c6">this</span>.depIds[dep.id] <span style="color:#ff79c6">=</span> dep;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>    get<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>        Dep.target <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>        <span style="color:#8be9fd;font-style:italic">var</span> value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.getter.call(<span style="color:#ff79c6">this</span>.vm, <span style="color:#ff79c6">this</span>.vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>        Dep.target <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>        <span style="color:#ff79c6">return</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>    parseGetter<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>        <span style="color:#ff79c6">if</span> (<span style="color:#f1fa8c">/[^\w.$]/</span>.test(exp)) <span style="color:#ff79c6">return</span>; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>        <span style="color:#8be9fd;font-style:italic">var</span> exps <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">function</span>(obj) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>            <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">var</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>, len <span style="color:#ff79c6">=</span> exps.length; i <span style="color:#ff79c6">&lt;</span> len; i<span style="color:#ff79c6">++</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>                <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>obj) <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>                obj <span style="color:#ff79c6">=</span> obj[exps[i]];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>            <span style="color:#ff79c6">return</span> obj;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>};
</code></pre></div><p>Watcheré‡Œé¢ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š</p>
<ol>
<li>åˆå§‹åŒ–ä¿å­˜äº†ä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚<code>updateFunc</code>ã€<code>exp</code>ç­‰ï¼›</li>
<li>æœ€æ ¸å¿ƒçš„æ“ä½œæ˜¯<code>get()</code>ï¼Œåˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œ<code>get()</code>ï¼Œåœ¨å†…éƒ¨é¦–å…ˆæŒ‡å®šäº†<code>Dep.target = this;</code>ï¼Œç„¶ååˆå»è·å–<code>exp</code>çš„å€¼ï¼Œåœ¨è·å–æ—¶å°±ä¼šè§¦å‘Observeré‡Œé¢çš„æ•°æ®åŠ«æŒï¼Œå°†å½“å‰thisæ·»åŠ è¿›Depçš„subsä¸­ï¼Œä¹‹ååˆ<code>Dep.target = null;</code>ï¼Œæ–¹ä¾¿ä¸‹ä¸€ä¸ªWatcherè¿›è¡Œæ“ä½œï¼›</li>
</ol>
<p>ä»¥ä¸Šå°±å®ç°äº†æ•°æ®çš„åŒå‘ç»‘å®šã€‚</p>

      </div>
      <div class="footer">
        <span><a class="category" href="https://tomtomyoung.top/categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a><a class="category" href="https://tomtomyoung.top/categories/%E7%B2%BE%E9%80%89/">ç²¾é€‰</a></span>
        <span><a class="tag" href="https://tomtomyoung.top/tags/vue/">vue</a></span>
      </div>
    </div>

    <ul class="menu">
    <li class="menu-item">
        <i class="iconfont icon-top item-btn" id="back_top_btn"></i>
    </li>
    <li class="menu-item">
        <a href="https://tomtomyoung.top/" id="back-btn">
            <i class="iconfont icon-home item-btn"></i>
        </a>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-switch item-btn" id="switch_btn"></i>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-search item-btn" id="search_btn"></i>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/vue-%E7%AE%80%E4%BB%8B/" data-tooltip="vue ç®€ä»‹">
            <i class="iconfont icon-left item-btn"></i>
            
        </a>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/react_native-%E7%AE%80%E4%BB%8B/" data-tooltip="react_native ç®€ä»‹">
            <i class="iconfont icon-right item-btn"></i>
            
        </a>
    </li>
</ul>

  </div>
</div>

<div class="cover" id="cover">
        <div class="search-container">
    <input type="search" class="docsearch-input search-input" placeholder="æœç´¢å…³é”®è¯" />
    
</div>
    </div>
</body>






<script type="text/javascript" src="https://tomtomyoung.top/js/util.min.js" integrity=""></script>
</html>