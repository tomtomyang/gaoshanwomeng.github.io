<!DOCTYPE html>
<html lang="zh-cn" data-theme="light"><head>
  <meta
    name="google-site-verification"
    content="kw1N-Xm6qEr1c9PGuRd0U_T6DXkw_EHsLyz5LpuDDv8"
  />
  <meta name="msvalidate.01" content="EE98205D30806C22C519683EFC53E9BA" />
  <meta name="baidu-site-verification" content="iPC3wUcQLL" />
  <title> vue 手写数据双向绑定</title>
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.74.3" /><meta
    name="viewport"
    content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1"
  />
  <meta
    name="description"
    itemprop="description"
    content=" vue 手写数据双向绑定 "
  />
  <meta
    name="keywords"
    itemprop="keywords"
    content=" [vue 数据双向绑定] "
  />
  <base href="https://tomtomyoung.top/" />

  
  <link
    rel="shortcut icon"
    href="https://tomtomyoung.top/favicons//favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://tomtomyoung.top/favicons/favicon-32x32.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://tomtomyoung.top/favicons/favicon-16x16.png"
  />
  

  <link rel="canonical" href="https://tomtomyoung.top/post/vue-%E6%89%8B%E5%86%99%E6%95%B0%E6%8D%AE%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A/" />
  <link
    rel="stylesheet"
    type="text/css"
    href="https://at.alicdn.com/t/font_2450869_iypnqhtzjei.css"
  />
  
  
  
  
  
  
  
  
  
  <link
    rel="stylesheet"
    href="https://tomtomyoung.top/css/style.min.css"
    integrity=""
    type="text/css"
  />
  
  
  <script
    type="text/javascript"
    src="https://tomtomyoung.top/js/docsearch.min.js"
    integrity=""
  ></script>
</head>
<body class="animated fadeInDown">
<div class="main"><div class="percentage_container">
    <div class="percentage" id="percentage"></div>
</div><div class="toc sub-container">
    <div class="toc-header">
        <span>目录</span>
    </div><ul class="toc-h2"><li>
                <span class="toc-link">1. 双向绑定原理</span>
            </li>
            <li>
                <span class="toc-link">2. MVVM</span>
            </li>
            <li>
                <span class="toc-link">3. Observer</span>
            </li>
            <li>
                <span class="toc-link">4. Dep</span>
            </li>
            <li>
                <span class="toc-link">5. Compile</span>
            </li>
            <li>
                <span class="toc-link">6. Watcher</span>
            </li>
            </div><div class="single-post container">
    <div class="post">
      <div class="header">
        <span class="title">vue 手写数据双向绑定</span>
        
        <div class="info">
          <span>📅 2021-09-05</span>
          <span>👦 Tomtom Young</span>
          <span>📖 5134字</span>
          <span>⏱ 11分钟</span>
        </div>
        
      </div>
      <div class="content markdown-body">
        <blockquote>
<p>参考：</p>
<p><a href="https://cn.vuejs.org/v2/guide/reactivity.html#%E5%A6%82%E4%BD%95%E8%BF%BD%E8%B8%AA%E5%8F%98%E5%8C%96">Vue.js_深入响应式原理</a></p>
<p><a href="https://www.cnblogs.com/demonxian3/p/13546525.html">Vue源码分析之实现一个简易版的Vue</a></p>
<p><a href="https://github.com/DMQ/mvvm">DMQ/mvvm</a></p>
<p><a href="https://www.cnblogs.com/moon3/p/12200807.html">vue源码解读（一）Observer/Dep/Watcher是如何实现数据绑定的</a></p>
<p><a href="https://juejin.cn/post/6844904128028622861">Observer、Dep、Watcher 傻傻搞不清楚</a></p>
</blockquote>
<h2 id="1-双向绑定原理">1. 双向绑定原理</h2>
<p>vue.js 是采用数据劫持+发布订阅模式的方式，通过<code>Object.defineProperty()</code>来劫持各个属性的<code>setter</code>，<code>getter</code>，在数据变动时发布消息给订阅者，触发相应的监听回调。</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/20190528174339999.png" alt="img"></p>
<p>里面涉及到以下关键的类和流程，主要是下面这些：</p>
<ol>
<li>MVVM类，这个类作为所有的入口，在执行<code>new MVVM()</code>时，会构造一个MVVM实例对象，这个实例对象上会有很多属性，而这些属性并不是直接拿到的，而是通过很多操作生成的。这些操作里包括了<code>observe</code>、<code>compile</code>等；</li>
<li>Observer类，这个类是用来观察对象的，一定要记住，data中有几个对象，就会有几个Observer实例，包括data本身也是一个对象，所以至少有一个Observer，用于观察对象中属性的变化；</li>
<li>Dep类，这个类在订阅发布模式中，扮演着发布者的角色，而且还要每个对象的属性都会绑定一个Dep实例，也就是说，订阅发布针对的是对象的每一个属性，当属性的被访问时，就往Dep的subs数组中添加一个数据对象，也就是这个属性在页面中被使用了几次，这个的属性的Dep实例中，就会有几个数据对象，这是订阅，在很多地方叫做依赖收集。而当数据发生改变时，要通知所有页面中使用到这个数据的地方，更新新的值，这是发布；</li>
<li>Compile类，其实这部分不算是类，而是一种操作，我们写的页面进行编译，抽取里面的指令和数据引用，变成一个个数据对象，为后续的操作和更新做准备；</li>
<li>Watcher类，上面所指的数据对象，就是Watcher类的实例，里面包含着数据的值，以及更新数据的方法，上面的Dep发布时，就是调用里面的更新方法；</li>
</ol>
<h2 id="2-mvvm">2. MVVM</h2>
<p>MVVM构造函数作为入口，我们应该先来实现它。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> MVVM(options) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#6272a4">// 在实例对象上保存option
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.$options <span style="color:#ff79c6">=</span> options <span style="color:#ff79c6">||</span> {};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#6272a4">// 在实例上保存data
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// data会有两种情况，一种是函数返回，一种是对象
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">var</span> data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>._data <span style="color:#ff79c6">=</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#ff79c6">typeof</span> <span style="color:#ff79c6">this</span>.$options.data <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;function&#39;</span> <span style="color:#ff79c6">?</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            <span style="color:#ff79c6">this</span>.$options.data.call(<span style="color:#ff79c6">this</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#ff79c6">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            <span style="color:#ff79c6">this</span>.$options.data;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#6272a4">// 暂存当前实例对象
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#6272a4">// 数据代理
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 实现 vm.xxx -&gt; vm._data.xxx
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">Object</span>.keys(data).forEach(key =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        me._proxyData(key);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    observe(data, me);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#6272a4">// compile用于编译html
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.$compile <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Compile(options.el <span style="color:#ff79c6">||</span> <span style="color:#8be9fd;font-style:italic">document</span>.body, me)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>MVVM.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    constructor<span style="color:#ff79c6">:</span> MVVM,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    _proxyData<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(key) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        <span style="color:#8be9fd;font-style:italic">Object</span>.defineProperty(<span style="color:#ff79c6">this</span>, key, {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>            get<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span> () {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>._data[key];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>            },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>            set<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span> (newVal) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                <span style="color:#ff79c6">if</span>(newVal <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">this</span>._data[key]){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>                    <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>                } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                    <span style="color:#ff79c6">this</span>._data[key] <span style="color:#ff79c6">=</span> newVal;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>};
</code></pre></div><p>这里面有几个关键的初始化操作：</p>
<ol>
<li>
<p>在实例上挂载data，这里进行了判断<code>typeof this.$options.data == 'function'</code>，是因为我们在定义data时，会有两种方式：</p>
<p>一种是函数返回的方式：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>data<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">return</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        someStr<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;hello MVVM&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        strArr<span style="color:#ff79c6">:</span> [
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            <span style="color:#f1fa8c">&#39;hello str1&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>            <span style="color:#f1fa8c">&#39;hello str2&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            <span style="color:#f1fa8c">&#39;hello str3&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>},
</code></pre></div><p>一种是对象方式：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>data<span style="color:#ff79c6">:</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    someStr<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;hello MVVM&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>},
</code></pre></div></li>
<li>
<p>进行了第一次的数据代理，因为我们会使用<code>this.XXX</code>的方式使用我们在data中定义的数据，但是数据实际上是保存在<code>this._data</code>中的，需要使用<code>this._data.XXX</code>才能访问到，因此这代理了一层；</p>
</li>
<li>
<p>观察data中的数据，进行数据劫持，这一点主要是后面的Observer类的工作；</p>
</li>
<li>
<p>对于<code>el</code>节点进行编译，将里面和数据相关的地方，都一一修改为对象，这一点都是后面的Compile类的工作；</p>
</li>
</ol>
<h2 id="3-observer">3. Observer</h2>
<p>在给对象绑定观察类之前，我们需要先对数据进行判断，如果这个数据不是对象，那么我们肯定不需要进行<code>new Observer</code>的操作，因此要定义一个<code>observe</code>函数进行数据的判断，单独封装一个函数，也方便了逻辑复用，因为有递归的操作，这段判断在很多地方都用到了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> observe(data, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#6272a4">// 如果是是数组的话，监听里面的每个元素
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (data <span style="color:#ff79c6">instanceof</span> <span style="color:#8be9fd;font-style:italic">Array</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        data.forEach(item =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            observe(item, vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    } 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#6272a4">// 如果是对象的话，监听这个对象
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> data <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;object&#39;</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Observer(data, vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#6272a4">// 如果啥也不是，就返回 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>};
</code></pre></div><p>Observer类作为数据劫持的实现，是Vue核心思想的体现，也是各个手写Vue教程最多提及的，这一部分虽然关键，其实并不难理解。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">// Observer只负责对对现象的监听，有一个对象就会有一个Observer
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">function</span> Observer(data, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    vm._dep <span style="color:#ff79c6">=</span> [];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">this</span>.data <span style="color:#ff79c6">=</span> data;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">this</span>.walk(data, vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>Observer.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    constructor<span style="color:#ff79c6">:</span> Observer,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    walk<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(data, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#6272a4">// 对data下面的每一个属性都进行劫持
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">Object</span>.keys(data).forEach(key =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            me.defineReactive(vm, data, key, data[key]);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    defineReactive<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, data, key, val) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#8be9fd;font-style:italic">var</span> dep <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Dep();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        vm._dep.push(dep);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#6272a4">// 当前值有可能是对象或者数组，监听一下
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#6272a4"></span>        observe(val);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        <span style="color:#8be9fd;font-style:italic">Object</span>.defineProperty(data, key, {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>            get<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>                <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!!</span>Dep.target) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>                    dep.depend();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>                <span style="color:#ff79c6">return</span> val;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>            },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>            set<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(newVal) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>                <span style="color:#ff79c6">if</span> (newVal <span style="color:#ff79c6">===</span> val) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>                    <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>                } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                    val <span style="color:#ff79c6">=</span> newVal;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>                    <span style="color:#6272a4">// 新设置的值也有可能是对象或者数组，监听一下
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#6272a4"></span>                    observe(newVal);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                    <span style="color:#6272a4">// 通知订阅者
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#6272a4"></span>                    dep.notify();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>};
</code></pre></div><p>在Observer中，其实没有进行太多操作，只是使用了<code> Object.defineProperty</code>对对象中的每一个属性进行数据劫持，需要额外说明的是递归操作，因为对象中某个属性对应的值还有可能是对象，还有就是这个属性可能原本不是对象，但是后来被修改成了对象，都需要再使用<code>observe</code>函数进行观察。</p>
<p>这里我们没有对数组进行处理，关于数组的处理可以看另一篇文章《vue 数据劫持详解》。</p>
<h2 id="4-dep">4. Dep</h2>
<p>相比于Observer，我个人认为Dep才是实现数据双向绑定的核心，只有搞清楚Dep的工作方式，才能真正理解整个流程。</p>
<p>需要再次明确的是，每一个属性，都对应一个Dep实例，实例中subs数组中存放这个属性在页面中的引用。要仔细地体会依赖收集的含义。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">var</span> uid <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#8be9fd;font-style:italic">function</span> Dep() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">this</span>.id <span style="color:#ff79c6">=</span> uid<span style="color:#ff79c6">++</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">this</span>.subs <span style="color:#ff79c6">=</span> [];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>Dep.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    addSub<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(sub) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">this</span>.subs.push(sub);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>	<span style="color:#6272a4">// 添加依赖
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>    depend<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        Dep.target.addDep(<span style="color:#ff79c6">this</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    removeSub<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(sub) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        <span style="color:#8be9fd;font-style:italic">var</span> index <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.subs.indexOf(sub);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#ff79c6">if</span> (index <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#ff79c6">this</span>.subs.splice(index, <span style="color:#bd93f9">1</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#6272a4">// 发布方法，执行每个依赖中的更新函数
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#6272a4"></span>    notify<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>        <span style="color:#ff79c6">this</span>.subs.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(sub) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>            sub.update();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#6272a4">// 在Dep构造函数对象上添加一个target，作为添加依赖时的对象
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4"></span>Dep.target <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>;
</code></pre></div><p>用一个实际情况来说明Dep的形成：</p>
<p>页面：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>&lt;<span style="color:#ff79c6">input</span> <span style="color:#50fa7b">type</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;text&#34;</span> <span style="color:#50fa7b">v-model</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;someStr&#34;</span>&gt;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>&lt;<span style="color:#ff79c6">p</span>&gt;{{someStr}}&lt;/<span style="color:#ff79c6">p</span>&gt;
</code></pre></div><p>数据：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>data<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">return</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        someStr<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;hello MVVM&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        strArr<span style="color:#ff79c6">:</span> [
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            <span style="color:#f1fa8c">&#39;hello str1&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>            <span style="color:#f1fa8c">&#39;hello str2&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            <span style="color:#f1fa8c">&#39;hello str3&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>},
</code></pre></div><p>上面这种情况，形成的Dep是这样的：</p>
<p><img src="https://blogimg-1302307650.cos.ap-shanghai.myqcloud.com/20210905220921.jpg" alt=""></p>
<p>解释一下，data中有两个数据，所以形成了两个Dep实例：</p>
<p>第一个Dep实例，对应着<code>someStr</code>，subs里面有两个数据依赖，因为我们在页面中分别写了<code>v-model=&quot;someStr&quot;</code>和<code>{{someStr}}</code>。</p>
<p>第二个Dep实例，对应着<code>strArr</code>，subs是空数组，因为我们没有在页面中使用这个数据。</p>
<h2 id="5-compile">5. Compile</h2>
<p>通过上面的图，我们可以看到subs里面放的是Watcher实例，但是这里我们先不去研究Watcher的实例是什么样子，包含什么，我们先去研究，页面中的数据是怎么被转换为Watcher对象的，这一部分就是Compile的主要工作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#8be9fd;font-style:italic">function</span> Compile(el, vm) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span>    <span style="color:#ff79c6">this</span>.$vm <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span>    <span style="color:#6272a4">// 传进来的el, 是一个字符串，需要拿到真实DOM节点
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span>.$el <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.querySelector(el);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!!</span><span style="color:#ff79c6">this</span>.$el) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span>        <span style="color:#ff79c6">this</span>.$fragment <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.node2Fragment(<span style="color:#ff79c6">this</span>.$el);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span>        <span style="color:#6272a4">// 从根节点赖时编译
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">this</span>.compileElement(<span style="color:#ff79c6">this</span>.$fragment);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span>        <span style="color:#ff79c6">this</span>.$el.appendChild(<span style="color:#ff79c6">this</span>.$fragment);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span>Compile.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span>    constructor<span style="color:#ff79c6">:</span> Compile,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span>    <span style="color:#6272a4">// 将当前节点的片段提取出来
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span style="color:#6272a4"></span>    node2Fragment<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(el) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span>        <span style="color:#8be9fd;font-style:italic">var</span> fragment <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">document</span>.createDocumentFragment(),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span>            child;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span>        <span style="color:#6272a4">// 将原生节点拷贝到fragment
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">while</span> (child <span style="color:#ff79c6">=</span> el.firstChild) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>            <span style="color:#6272a4">// console.log(el.childNodes);
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span style="color:#6272a4"></span>            fragment.appendChild(child);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>        <span style="color:#ff79c6">return</span> fragment;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>    <span style="color:#6272a4">// 编译ele节点
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span><span style="color:#6272a4"></span>    compileElement<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(el) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span>        <span style="color:#8be9fd;font-style:italic">var</span> childNodes <span style="color:#ff79c6">=</span> el.childNodes,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span>            me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span>        console.log(<span style="color:#8be9fd;font-style:italic">Array</span>.from(childNodes));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>        <span style="color:#6272a4">// 将nodeList转换为数组，进行遍历
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">Array</span>.from(childNodes).forEach(node =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>            <span style="color:#8be9fd;font-style:italic">var</span> text <span style="color:#ff79c6">=</span> node.textContent;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span>            <span style="color:#8be9fd;font-style:italic">var</span> reg <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">/\{\{(.*)\}\}/</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span>            <span style="color:#6272a4">// 如果是节点，编译
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (me.isElementNode(node)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span>                me.compile(node);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span>            <span style="color:#6272a4">// 如果这个节点是text类型 同时里面的text是{{}}包裹，说明是变量
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span><span style="color:#6272a4"></span>            } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (me.isTextNode(node) <span style="color:#ff79c6">&amp;&amp;</span> reg.test(text)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span>                console.log(<span style="color:#f1fa8c">&#39;node&#39;</span>, node, <span style="color:#f1fa8c">&#39;text&#39;</span>, text);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>                me.compileText(node, <span style="color:#8be9fd;font-style:italic">RegExp</span>.$1.trim());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>            <span style="color:#6272a4">// 如果还有子元素，编译
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (node.childNodes <span style="color:#ff79c6">&amp;&amp;</span> node.childNodes.length) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>                me.compileElement(node);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>    compile<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>        <span style="color:#8be9fd;font-style:italic">var</span> nodeAttrs <span style="color:#ff79c6">=</span> node.attributes,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>            me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>        <span style="color:#8be9fd;font-style:italic">Array</span>.from(nodeAttrs).forEach(attr =&gt; {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>            <span style="color:#8be9fd;font-style:italic">var</span> attrName <span style="color:#ff79c6">=</span> attr.name;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span>            <span style="color:#6272a4">// 如果是v-指令
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (me.isDirective(attrName)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>                <span style="color:#8be9fd;font-style:italic">var</span> exp <span style="color:#ff79c6">=</span> attr.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span>                <span style="color:#8be9fd;font-style:italic">var</span> dir <span style="color:#ff79c6">=</span> attrName.substring(<span style="color:#bd93f9">2</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span>                <span style="color:#6272a4">// 如果是用v-on绑定的事件
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">if</span> (me.isEventDirective(dir)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>                    compileUtil.eventHandler(node, me.$vm, exp, dir);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>                <span style="color:#6272a4">// 如果是其他指令 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>                    <span style="color:#ff79c6">!!</span>compileUtil[dir] <span style="color:#ff79c6">&amp;&amp;</span> compileUtil[dir](node, me.$vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>                }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span>                <span style="color:#6272a4">// 删掉指令
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span><span style="color:#6272a4"></span>                node.removeAttribute(attrName);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span>    <span style="color:#6272a4">// 第一个参数是节点，第二个参数是变量
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span style="color:#6272a4"></span>    compileText<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>        compileUtil.text(node, <span style="color:#ff79c6">this</span>.$vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>    isDirective<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(attr) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>        <span style="color:#ff79c6">return</span> attr.indexOf(<span style="color:#f1fa8c">&#39;v-&#39;</span>) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>    isEventDirective<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(dir) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>        <span style="color:#ff79c6">return</span> dir.indexOf(<span style="color:#f1fa8c">&#39;on&#39;</span>) <span style="color:#ff79c6">===</span> <span style="color:#bd93f9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>    <span style="color:#6272a4">// nodeType表示节点类型  1 --&gt;Element类型   3 --&gt;Text类型   9 --&gt;Document类型
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span>    isElementNode<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>        <span style="color:#6272a4">// nodeType == 1 说明是一个元素节点，比如p或者div
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> node.nodeType <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>    isTextNode<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>        <span style="color:#ff79c6">return</span> node.nodeType <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">3</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span><span style="color:#6272a4">// 指令处理集合
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">var</span> compileUtil <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span>    <span style="color:#6272a4">// 绑定变量
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span><span style="color:#6272a4"></span>    text<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span>        <span style="color:#ff79c6">this</span>.bind(node, vm, exp, <span style="color:#f1fa8c">&#39;text&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span>    model<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span>        <span style="color:#ff79c6">this</span>.bind(node, vm, exp, <span style="color:#f1fa8c">&#39;model&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span>        <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span>            val <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>._getVMVal(vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span>        node.addEventListener(<span style="color:#f1fa8c">&#39;input&#39;</span>, <span style="color:#8be9fd;font-style:italic">function</span>(e) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span>            <span style="color:#8be9fd;font-style:italic">var</span> newValue <span style="color:#ff79c6">=</span> e.target.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span>            <span style="color:#ff79c6">if</span> (val <span style="color:#ff79c6">===</span> newValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span>                <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span>            me._setVMVal(vm, exp, newValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span>            val <span style="color:#ff79c6">=</span> newValue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132</span>    <span style="color:#6272a4">// 转换watcher 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133</span><span style="color:#6272a4"></span>    bind<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp, dir) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134</span>        <span style="color:#8be9fd;font-style:italic">var</span> updaterFn <span style="color:#ff79c6">=</span> updater[dir <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;Updater&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136</span>        <span style="color:#6272a4">// 先更新一次变量值
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137</span><span style="color:#6272a4"></span>        updaterFn <span style="color:#ff79c6">&amp;&amp;</span> updaterFn(node, <span style="color:#ff79c6">this</span>._getVMVal(vm, exp));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139</span>        <span style="color:#6272a4">// 传进去三个参数 vm 变量 更新方法
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">new</span> Watcher(vm, exp, <span style="color:#8be9fd;font-style:italic">function</span>(value, oldValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141</span>            updaterFn <span style="color:#ff79c6">&amp;&amp;</span> updaterFn(node, value, oldValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145</span>    <span style="color:#6272a4">// 事件处理
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146</span><span style="color:#6272a4"></span>    eventHandler<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp, dir) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147</span>        <span style="color:#8be9fd;font-style:italic">var</span> eventType <span style="color:#ff79c6">=</span> dir.split(<span style="color:#f1fa8c">&#39;:&#39;</span>)[<span style="color:#bd93f9">1</span>],
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148</span>            fn <span style="color:#ff79c6">=</span> vm.$options.methods <span style="color:#ff79c6">&amp;&amp;</span> vm.$options.methods[exp];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150</span>        <span style="color:#ff79c6">if</span> (eventType <span style="color:#ff79c6">&amp;&amp;</span> fn) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151</span>            node.addEventListener(eventType, fn.bind(vm), <span style="color:#ff79c6">false</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155</span>    <span style="color:#6272a4">// 在data中查找exp的值
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156</span><span style="color:#6272a4"></span>    _getVMVal<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157</span>        <span style="color:#8be9fd;font-style:italic">var</span> val <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158</span>        exp <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159</span>        <span style="color:#6272a4">// 循环找到最后一个值
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160</span><span style="color:#6272a4"></span>        exp.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(k) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161</span>            val <span style="color:#ff79c6">=</span> val[k];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163</span>        <span style="color:#ff79c6">return</span> val;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166</span>    _setVMVal<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, exp, value) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167</span>        <span style="color:#8be9fd;font-style:italic">var</span> val <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168</span>        exp <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169</span>        exp.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(k, i) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170</span>            <span style="color:#6272a4">// 非最后一个key，更新val的值
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> (i <span style="color:#ff79c6">&lt;</span> exp.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172</span>                val <span style="color:#ff79c6">=</span> val[k];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173</span>            } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174</span>                val[k] <span style="color:#ff79c6">=</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176</span>        });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178</span>};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181</span><span style="color:#8be9fd;font-style:italic">var</span> updater <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182</span>    <span style="color:#6272a4">// text节点更新函数
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183</span><span style="color:#6272a4"></span>    textUpdater<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, value) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184</span>        <span style="color:#6272a4">// 直接修改textContent
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185</span><span style="color:#6272a4"></span>        node.textContent <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">typeof</span> value <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;undefined&#39;</span> <span style="color:#ff79c6">?</span> <span style="color:#f1fa8c">&#39;&#39;</span> <span style="color:#ff79c6">:</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188</span>    modelUpdater<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, value, oldValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189</span>        node.value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">typeof</span> value <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;undefined&#39;</span> <span style="color:#ff79c6">?</span> <span style="color:#f1fa8c">&#39;&#39;</span> <span style="color:#ff79c6">:</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191</span>};
</code></pre></div><p>Compile的代码量比较多，但是干的事情并不复杂，归结下来主要有下面几件：</p>
<ol>
<li>获取el节点，并把el节点的子节点都拿出来，挂载到新创建的<code>documentFragment</code>上，这样做的原因是，避免直接在el节点上操作，导致页面频繁的添加修改节点，而是在<code>documentFragment</code>上进行操作，操作完了再统一挂载回去，一次完工；</li>
<li>对el节点下面的子节点进行逐层编译，获取节点上的<code>v-</code>指令，以及文本类型节点中的<code>{{}}</code>；</li>
<li>对发现的<code>v-</code>指令和<code>{{}}</code>进行处理，分别创建<code>Watcher</code>，保存对应变量，以及更新函数；</li>
</ol>
<p>这里还要注意的是，在<code>v-model</code>的处理中，使用了<code>addEventListener('input' function(){})</code>，正是这一步，实现了view -&gt; model的数据流：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span> model<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(node, vm, exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">this</span>.bind(node, vm, exp, <span style="color:#f1fa8c">&#39;model&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd;font-style:italic">var</span> me <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        val <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>._getVMVal(vm, exp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    node.addEventListener(<span style="color:#f1fa8c">&#39;input&#39;</span>, <span style="color:#8be9fd;font-style:italic">function</span>(e) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        <span style="color:#8be9fd;font-style:italic">var</span> newValue <span style="color:#ff79c6">=</span> e.target.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#ff79c6">if</span> (val <span style="color:#ff79c6">===</span> newValue) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        me._setVMVal(vm, exp, newValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        val <span style="color:#ff79c6">=</span> newValue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>},
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>_setVMVal<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(vm, exp, value) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#8be9fd;font-style:italic">var</span> val <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    exp <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    exp.forEach(<span style="color:#8be9fd;font-style:italic">function</span>(k, i) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        <span style="color:#6272a4">// 非最后一个key，更新val的值
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (i <span style="color:#ff79c6">&lt;</span> exp.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            val <span style="color:#ff79c6">=</span> val[k];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        } <span style="color:#ff79c6">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            val[k] <span style="color:#ff79c6">=</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    });
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>}
</code></pre></div><h2 id="6-watcher">6. Watcher</h2>
<p>下面再来看Watcher，正是Watcher把Compile和Dep连接起来，实现了model-&gt;view的数据流。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">function</span> Watcher(vm, exp, updateFunc) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">this</span>.updateFunc <span style="color:#ff79c6">=</span> updateFunc;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#ff79c6">this</span>.vm <span style="color:#ff79c6">=</span> vm;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">this</span>.exp <span style="color:#ff79c6">=</span> exp;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">this</span>.depIds <span style="color:#ff79c6">=</span> {};
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">this</span>.getter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.parseGetter(exp.trim());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.get();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>Watcher.prototype <span style="color:#ff79c6">=</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    constructor<span style="color:#ff79c6">:</span> Watcher,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    update<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        <span style="color:#ff79c6">this</span>.run();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    run<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#8be9fd;font-style:italic">var</span> value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.get();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        <span style="color:#8be9fd;font-style:italic">var</span> oldVal <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        <span style="color:#ff79c6">if</span> (value <span style="color:#ff79c6">!==</span> oldVal) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#ff79c6">this</span>.value <span style="color:#ff79c6">=</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            <span style="color:#ff79c6">this</span>.updateFunc.call(<span style="color:#ff79c6">this</span>.vm, value, oldVal);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    addDep<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(dep) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        <span style="color:#6272a4">// 1. 每次调用run()的时候会触发相应属性的getter
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// getter里面会触发dep.depend()，继而触发这里的addDep
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        <span style="color:#6272a4">// 2. 假如相应属性的dep.id已经在当前watcher的depIds里，说明不是一个新的属性，仅仅是改变了其值而已
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 则不需要将当前watcher添加到该属性的dep里
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        <span style="color:#6272a4">// 3. 假如相应属性是新的属性，则将当前watcher添加到新属性的dep里
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 如通过 vm.child = {name: &#39;a&#39;} 改变了 child.name 的值，child.name 就是个新属性
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 则需要将当前watcher(child.name)加入到新的 child.name 的dep里
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 因为此时 child.name 是个新值，之前的 setter、dep 都已经失效，如果不把 watcher 加入到新的 child.name 的dep中
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 通过 child.name = xxx 赋值的时候，对应的 watcher 就收不到通知，等于失效了
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>        <span style="color:#6272a4">// 4. 每个子属性的watcher在添加到子属性的dep的同时，也会添加到父属性的dep
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 监听子属性的同时监听父属性的变更，这样，父属性改变时，子属性的watcher也能收到通知进行update
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 这一步是在 this.get() --&gt; this.getVMVal() 里面完成，forEach时会从父级开始取值，间接调用了它的getter
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 触发了addDep(), 在整个forEach过程，当前wacher都会加入到每个父级过程属性的dep
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 例如：当前watcher的是&#39;child.child.name&#39;, 那么child, child.child, child.child.name这三个属性的dep都会加入当前watcher
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span><span style="color:#ff79c6">this</span>.depIds.hasOwnProperty(dep.id)) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>            dep.addSub(<span style="color:#ff79c6">this</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>            <span style="color:#ff79c6">this</span>.depIds[dep.id] <span style="color:#ff79c6">=</span> dep;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>    get<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>        Dep.target <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>        <span style="color:#8be9fd;font-style:italic">var</span> value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.getter.call(<span style="color:#ff79c6">this</span>.vm, <span style="color:#ff79c6">this</span>.vm);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>        Dep.target <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>        <span style="color:#ff79c6">return</span> value;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>    parseGetter<span style="color:#ff79c6">:</span> <span style="color:#8be9fd;font-style:italic">function</span>(exp) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>        <span style="color:#ff79c6">if</span> (<span style="color:#f1fa8c">/[^\w.$]/</span>.test(exp)) <span style="color:#ff79c6">return</span>; 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>        <span style="color:#8be9fd;font-style:italic">var</span> exps <span style="color:#ff79c6">=</span> exp.split(<span style="color:#f1fa8c">&#39;.&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">function</span>(obj) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>            <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">var</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>, len <span style="color:#ff79c6">=</span> exps.length; i <span style="color:#ff79c6">&lt;</span> len; i<span style="color:#ff79c6">++</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>                <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>obj) <span style="color:#ff79c6">return</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>                obj <span style="color:#ff79c6">=</span> obj[exps[i]];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>            <span style="color:#ff79c6">return</span> obj;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>};
</code></pre></div><p>Watcher里面主要做了下面几件事：</p>
<ol>
<li>初始化保存了一些数据，比如<code>updateFunc</code>、<code>exp</code>等；</li>
<li>最核心的操作是<code>get()</code>，初始化时会执行<code>get()</code>，在内部首先指定了<code>Dep.target = this;</code>，然后又去获取<code>exp</code>的值，在获取时就会触发Observer里面的数据劫持，将当前this添加进Dep的subs中，之后又<code>Dep.target = null;</code>，方便下一个Watcher进行操作；</li>
</ol>
<p>以上就实现了数据的双向绑定。</p>

      </div>
      <div class="footer">
        <span><a class="category" href="https://tomtomyoung.top/categories/%E5%89%8D%E7%AB%AF/">前端</a><a class="category" href="https://tomtomyoung.top/categories/%E7%B2%BE%E9%80%89/">精选</a></span>
        <span><a class="tag" href="https://tomtomyoung.top/tags/vue/">vue</a></span>
      </div>
    </div>

    <ul class="menu">
    <li class="menu-item">
        <i class="iconfont icon-top item-btn" id="back_top_btn"></i>
    </li>
    <li class="menu-item">
        <a href="https://tomtomyoung.top/" id="back-btn">
            <i class="iconfont icon-home item-btn"></i>
        </a>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-switch item-btn" id="switch_btn"></i>
    </li>
    <li class="menu-item">
        <i class="iconfont icon-search item-btn" id="search_btn"></i>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/vue-%E7%AE%80%E4%BB%8B/" data-tooltip="vue 简介">
            <i class="iconfont icon-left item-btn"></i>
            
        </a>
    </li>
    <li class="menu-item">
        
        <a class="" href="https://tomtomyoung.top/post/react_native-%E7%AE%80%E4%BB%8B/" data-tooltip="react_native 简介">
            <i class="iconfont icon-right item-btn"></i>
            
        </a>
    </li>
</ul>

  </div>
</div>

<div class="cover" id="cover">
        <div class="search-container">
    <input type="search" class="docsearch-input search-input" placeholder="搜索关键词" />
    
</div>
    </div>
</body>






<script type="text/javascript" src="https://tomtomyoung.top/js/util.min.js" integrity=""></script>
</html>